"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
jest.mock('../window');
var StreamActions = __importStar(require("../actions/StreamActions"));
var index_1 = __importDefault(require("./index"));
var window_1 = require("../window");
var redux_1 = require("redux");
var middlewares_1 = require("../middlewares");
describe('reducers/alerts', function () {
    var store, stream, userId;
    beforeEach(function () {
        store = redux_1.createStore(index_1["default"], redux_1.applyMiddleware.apply(void 0, middlewares_1.create()));
        userId = 'test id';
        stream = new window_1.MediaStream();
    });
    afterEach(function () {
        window_1.createObjectURL
            .mockImplementation(function (object) { return 'blob://' + String(object); });
    });
    describe('defaultState', function () {
        it('should have default state set', function () {
            expect(store.getState().streams).toEqual({});
        });
    });
    describe('addStream', function () {
        it('adds a stream', function () {
            var _a;
            store.dispatch(StreamActions.addStream({ userId: userId, stream: stream }));
            expect(store.getState().streams).toEqual((_a = {},
                _a[userId] = {
                    userId: userId,
                    streams: [{
                            stream: stream,
                            url: jasmine.any(String),
                            type: undefined
                        }]
                },
                _a));
        });
        it('does not fail when createObjectURL fails', function () {
            var _a;
            window_1.createObjectURL
                .mockImplementation(function () { throw new Error('test'); });
            store.dispatch(StreamActions.addStream({ userId: userId, stream: stream }));
            expect(store.getState().streams).toEqual((_a = {},
                _a[userId] = {
                    userId: userId,
                    streams: [{
                            stream: stream,
                            type: undefined,
                            url: undefined
                        }]
                },
                _a));
        });
    });
    describe('removeStream', function () {
        it('removes a stream', function () {
            store.dispatch(StreamActions.addStream({ userId: userId, stream: stream }));
            store.dispatch(StreamActions.removeStream(userId, stream));
            expect(store.getState().streams).toEqual({});
        });
        it('does not fail when no stream', function () {
            store.dispatch(StreamActions.removeStream(userId, stream));
        });
    });
    describe('addStreamTrack', function () {
        var stream;
        beforeEach(function () {
            stream = new window_1.MediaStream();
            stream.getTracks.mockReturnValue([]);
        });
        it('adds a stream when stream does not exist', function () {
            var _a;
            var track = new window_1.MediaStreamTrack();
            store.dispatch(StreamActions.addTrack({
                stream: stream,
                track: track,
                userId: userId
            }));
            expect(store.getState().streams).toEqual((_a = {},
                _a[userId] = {
                    userId: userId,
                    streams: [{
                            stream: stream,
                            url: jasmine.any(String)
                        }]
                },
                _a));
        });
        it('adds a track to stream when track not added to stream', function () {
            var track = new window_1.MediaStreamTrack();
            store.dispatch(StreamActions.addTrack({
                stream: stream,
                track: track,
                userId: userId
            }));
            expect(stream.addTrack.mock.calls.length).toBe(1);
            expect(stream.addTrack.mock.calls[0][0]).toBe(track);
        });
        it('adds stream and does not add existing track in stream', function () {
            var _a;
            var track = new window_1.MediaStreamTrack();
            stream.getTracks.mockReturnValue([track]);
            store.dispatch(StreamActions.addTrack({
                stream: stream,
                track: track,
                userId: userId
            }));
            expect(stream.addTrack.mock.calls.length).toBe(0);
            expect(store.getState().streams).toEqual((_a = {},
                _a[userId] = {
                    userId: userId,
                    streams: [{
                            stream: stream,
                            url: jasmine.any(String)
                        }]
                },
                _a));
        });
        it('adds missing track to existing stream', function () {
            var _a;
            var track = new window_1.MediaStreamTrack();
            store.dispatch(StreamActions.addStream({
                stream: stream,
                userId: userId
            }));
            store.dispatch(StreamActions.addTrack({
                stream: stream,
                track: track,
                userId: userId
            }));
            expect(stream.addTrack.mock.calls.length).toBe(1);
            expect(stream.addTrack.mock.calls[0][0]).toBe(track);
            expect(store.getState().streams).toEqual((_a = {},
                _a[userId] = {
                    userId: userId,
                    streams: [{
                            stream: stream,
                            url: jasmine.any(String)
                        }]
                },
                _a));
        });
    });
    describe('removeStreamTrack', function () {
        var stream;
        var tracks;
        beforeEach(function () {
            stream = new window_1.MediaStream();
            store.dispatch(StreamActions.addStream({
                userId: userId,
                stream: stream
            }));
            tracks = [];
            stream.getTracks.mockImplementation(function () { return tracks; });
            stream.removeTrack
                .mockImplementation(function (track) {
                tracks = tracks.filter(function (t) { return t !== track; });
            });
        });
        it('removes a track from stream', function () {
            var _a;
            var track = new window_1.MediaStreamTrack();
            tracks = [track, new window_1.MediaStreamTrack()];
            store.dispatch(StreamActions.removeTrack({
                userId: userId,
                stream: stream,
                track: track
            }));
            expect(store.getState().streams).toEqual((_a = {},
                _a[userId] = {
                    userId: userId,
                    streams: [{
                            stream: stream,
                            url: jasmine.any(String)
                        }]
                },
                _a));
        });
        it('removes a stream when no tracks left in stream', function () {
            var track = new window_1.MediaStreamTrack();
            tracks = [track];
            store.dispatch(StreamActions.removeTrack({
                userId: userId,
                stream: stream,
                track: track
            }));
            expect(store.getState().streams).toEqual({});
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyZWFtcy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NsaWVudC9yZWR1Y2Vycy9zdHJlYW1zLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtBQUV0QixzRUFBeUQ7QUFDekQsa0RBQThCO0FBQzlCLG9DQUEwRTtBQUMxRSwrQkFBMkQ7QUFDM0QsOENBQXVDO0FBRXZDLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRTtJQUUxQixJQUFJLEtBQVksRUFBRSxNQUFtQixFQUFFLE1BQWMsQ0FBQTtJQUNyRCxVQUFVLENBQUM7UUFDVCxLQUFLLEdBQUcsbUJBQVcsQ0FDakIsa0JBQVEsRUFDUix1QkFBZSxlQUFJLG9CQUFNLEVBQUUsRUFDNUIsQ0FBQTtRQUNELE1BQU0sR0FBRyxTQUFTLENBQUE7UUFDbEIsTUFBTSxHQUFHLElBQUksb0JBQVcsRUFBRSxDQUFBO0lBQzVCLENBQUMsQ0FBQyxDQUFBO0lBRUYsU0FBUyxDQUFDO1FBQ1Asd0JBQTZCO2FBQzdCLGtCQUFrQixDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBMUIsQ0FBMEIsQ0FBQyxDQUFBO0lBQzNELENBQUMsQ0FBQyxDQUFBO0lBRUYsUUFBUSxDQUFDLGNBQWMsRUFBRTtRQUN2QixFQUFFLENBQUMsK0JBQStCLEVBQUU7WUFDbEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDOUMsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtJQUVGLFFBQVEsQ0FBQyxXQUFXLEVBQUU7UUFDcEIsRUFBRSxDQUFDLGVBQWUsRUFBRTs7WUFDbEIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsU0FBUyxD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Qzt5QkFDekIsQ0FBQztpQkFDSDtvQkFDRCxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7UUFFRixFQUFFLENBQUMsZ0RBQWdELEVBQUU7WUFDbkQsSUFBTSxLQUFLLEdBQUcsSUFBSSx5QkFBZ0IsRUFBRSxDQUFBO1lBQ3BDLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2hCLEtBQUssQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQztnQkFDdkMsTUFBTSxRQUFBO2dCQUNOLE1BQU0sUUFBQTtnQkFDTixLQUFLLE9BQUE7YUFDTixDQUFDLENBQUMsQ0FBQTtZQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQzlDLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFFSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImplc3QubW9jaygnLi4vd2luZG93JylcblxuaW1wb3J0ICogYXMgU3RyZWFtQWN0aW9ucyBmcm9tICcuLi9hY3Rpb25zL1N0cmVhbUFjdGlvbnMnXG5pbXBvcnQgcmVkdWNlcnMgZnJvbSAnLi9pbmRleCdcbmltcG9ydCB7IGNyZWF0ZU9iamVjdFVSTCwgTWVkaWFTdHJlYW0sIE1lZGlhU3RyZWFtVHJhY2sgfSBmcm9tICcuLi93aW5kb3cnXG5pbXBvcnQgeyBhcHBseU1pZGRsZXdhcmUsIGNyZWF0ZVN0b3JlLCBTdG9yZSB9IGZyb20gJ3JlZHV4J1xuaW1wb3J0IHsgY3JlYXRlIH0gZnJvbSAnLi4vbWlkZGxld2FyZXMnXG5cbmRlc2NyaWJlKCdyZWR1Y2Vycy9hbGVydHMnLCAoKSA9PiB7XG5cbiAgbGV0IHN0b3JlOiBTdG9yZSwgc3RyZWFtOiBNZWRpYVN0cmVhbSwgdXNlcklkOiBzdHJpbmdcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgc3RvcmUgPSBjcmVhdGVTdG9yZShcbiAgICAgIHJlZHVjZXJzLFxuICAgICAgYXBwbHlNaWRkbGV3YXJlKC4uLmNyZWF0ZSgpKSxcbiAgICApXG4gICAgdXNlcklkID0gJ3Rlc3QgaWQnXG4gICAgc3RyZWFtID0gbmV3IE1lZGlhU3RyZWFtKClcbiAgfSlcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIChjcmVhdGVPYmplY3RVUkwgYXMgamVzdC5Nb2NrKVxuICAgIC5tb2NrSW1wbGVtZW50YXRpb24ob2JqZWN0ID0+ICdibG9iOi8vJyArIFN0cmluZyhvYmplY3QpKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdkZWZhdWx0U3RhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYXZlIGRlZmF1bHQgc3RhdGUgc2V0JywgKCkgPT4ge1xuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkuc3RyZWFtcykudG9FcXVhbCh7fSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdhZGRTdHJlYW0nLCAoKSA9PiB7XG4gICAgaXQoJ2FkZHMgYSBzdHJlYW0nLCAoKSA9PiB7XG4gICAgICBzdG9yZS5kaXNwYXRjaChTdHJlYW1BY3Rpb25zLmFkZFN0cmVhbSh7IHVzZXJJZCwgc3RyZWFtIH0pKVxuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkuc3RyZWFtcykudG9FcXVhbCh7XG4gICAgICAgIFt1c2VySWRdOiB7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHN0cmVhbXM6IFt7XG4gICAgICAgICAgICBzdHJlYW0sXG4gICAgICAgICAgICB1cmw6IGphc21pbmUuYW55KFN0cmluZyksXG4gICAgICAgICAgICB0eXBlOiB1bmRlZmluZWQsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgIH0pXG4gICAgaXQoJ2RvZXMgbm90IGZhaWwgd2hlbiBjcmVhdGVPYmplY3RVUkwgZmFpbHMnLCAoKSA9PiB7XG4gICAgICAoY3JlYXRlT2JqZWN0VVJMIGFzIGplc3QuTW9jaylcbiAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4geyB0aHJvdyBuZXcgRXJyb3IoJ3Rlc3QnKSB9KVxuICAgICAgc3RvcmUuZGlzcGF0Y2goU3RyZWFtQWN0aW9ucy5hZGRTdHJlYW0oeyB1c2VySWQsIHN0cmVhbSB9KSlcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLnN0cmVhbXMpLnRvRXF1YWwoe1xuICAgICAgICBbdXNlcklkXToge1xuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBzdHJlYW1zOiBbe1xuICAgICAgICAgICAgc3RyZWFtLFxuICAgICAgICAgICAgdHlwZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgdXJsOiB1bmRlZmluZWQsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3JlbW92ZVN0cmVhbScsICgpID0+IHtcbiAgICBpdCgncmVtb3ZlcyBhIHN0cmVhbScsICgpID0+IHtcbiAgICAgIHN0b3JlLmRpc3BhdGNoKFN0cmVhbUFjdGlvbnMuYWRkU3RyZWFtKHsgdXNlcklkLCBzdHJlYW0gfSkpXG4gICAgICBzdG9yZS5kaXNwYXRjaChTdHJlYW1BY3Rpb25zLnJlbW92ZVN0cmVhbSh1c2VySWQsIHN0cmVhbSkpXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zKS50b0VxdWFsKHt9KVxuICAgIH0pXG4gICAgaXQoJ2RvZXMgbm90IGZhaWwgd2hlbiBubyBzdHJlYW0nLCAoKSA9PiB7XG4gICAgICBzdG9yZS5kaXNwYXRjaChTdHJlYW1BY3Rpb25zLnJlbW92ZVN0cmVhbSh1c2VySWQsIHN0cmVhbSkpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnYWRkU3RyZWFtVHJhY2snLCAoKSA9PiB7XG4gICAgbGV0IHN0cmVhbTogTWVkaWFTdHJlYW1cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHN0cmVhbSA9IG5ldyBNZWRpYVN0cmVhbSgpXG4gICAgICA7KHN0cmVhbS5nZXRUcmFja3MgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoW10pXG4gICAgfSlcblxuICAgIGl0KCdhZGRzIGEgc3RyZWFtIHdoZW4gc3RyZWFtIGRvZXMgbm90IGV4aXN0JywgKCkgPT4ge1xuICAgICAgY29uc3QgdHJhY2sgPSBuZXcgTWVkaWFTdHJlYW1UcmFjaygpXG4gICAgICBzdG9yZS5kaXNwYXRjaChTdHJlYW1BY3Rpb25zLmFkZFRyYWNrKHtcbiAgICAgICAgc3RyZWFtLFxuICAgICAgICB0cmFjayxcbiAgICAgICAgdXNlcklkLFxuICAgICAgfSkpXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zKS50b0VxdWFsKHtcbiAgICAgICAgW3VzZXJJZF06IHtcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgc3RyZWFtczogW3tcbiAgICAgICAgICAgIHN0cmVhbSxcbiAgICAgICAgICAgIHVybDogamFzbWluZS5hbnkoU3RyaW5nKSxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGl0KCdhZGRzIGEgdHJhY2sgdG8gc3RyZWFtIHdoZW4gdHJhY2sgbm90IGFkZGVkIHRvIHN0cmVhbScsICgpID0+IHtcbiAgICAgIGNvbnN0IHRyYWNrID0gbmV3IE1lZGlhU3RyZWFtVHJhY2soKVxuICAgICAgc3RvcmUuZGlzcGF0Y2goU3RyZWFtQWN0aW9ucy5hZGRUcmFjayh7XG4gICAgICAgIHN0cmVhbSxcbiAgICAgICAgdHJhY2ssXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0pKVxuICAgICAgZXhwZWN0KChzdHJlYW0uYWRkVHJhY2sgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgZXhwZWN0KChzdHJlYW0uYWRkVHJhY2sgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzWzBdWzBdKS50b0JlKHRyYWNrKVxuICAgIH0pXG5cbiAgICBpdCgnYWRkcyBzdHJlYW0gYW5kIGRvZXMgbm90IGFkZCBleGlzdGluZyB0cmFjayBpbiBzdHJlYW0nLCAoKSA9PiB7XG4gICAgICBjb25zdCB0cmFjayA9IG5ldyBNZWRpYVN0cmVhbVRyYWNrKClcbiAgICAgIDsoc3RyZWFtLmdldFRyYWNrcyBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZShbdHJhY2tdKVxuICAgICAgc3RvcmUuZGlzcGF0Y2goU3RyZWFtQWN0aW9ucy5hZGRUcmFjayh7XG4gICAgICAgIHN0cmVhbSxcbiAgICAgICAgdHJhY2ssXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0pKVxuICAgICAgZXhwZWN0KChzdHJlYW0uYWRkVHJhY2sgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgwKVxuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkuc3RyZWFtcykudG9FcXVhbCh7XG4gICAgICAgIFt1c2VySWRdOiB7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHN0cmVhbXM6IFt7XG4gICAgICAgICAgICBzdHJlYW0sXG4gICAgICAgICAgICB1cmw6IGphc21pbmUuYW55KFN0cmluZyksXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBpdCgnYWRkcyBtaXNzaW5nIHRyYWNrIHRvIGV4aXN0aW5nIHN0cmVhbScsICgpID0+IHtcbiAgICAgIGNvbnN0IHRyYWNrID0gbmV3IE1lZGlhU3RyZWFtVHJhY2soKVxuICAgICAgc3RvcmUuZGlzcGF0Y2goU3RyZWFtQWN0aW9ucy5hZGRTdHJlYW0oe1xuICAgICAgICBzdHJlYW0sXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0pKVxuICAgICAgc3RvcmUuZGlzcGF0Y2goU3RyZWFtQWN0aW9ucy5hZGRUcmFjayh7XG4gICAgICAgIHN0cmVhbSxcbiAgICAgICAgdHJhY2ssXG4gICAgICAgIHVzZXJJZCxcbiAgICAgIH0pKVxuICAgICAgZXhwZWN0KChzdHJlYW0uYWRkVHJhY2sgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgZXhwZWN0KChzdHJlYW0uYWRkVHJhY2sgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzWzBdWzBdKS50b0JlKHRyYWNrKVxuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkuc3RyZWFtcykudG9FcXVhbCh7XG4gICAgICAgIFt1c2VySWRdOiB7XG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHN0cmVhbXM6IFt7XG4gICAgICAgICAgICBzdHJlYW0sXG4gICAgICAgICAgICB1cmw6IGphc21pbmUuYW55KFN0cmluZyksXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3JlbW92ZVN0cmVhbVRyYWNrJywgKCkgPT4ge1xuICAgIGxldCBzdHJlYW06IE1lZGlhU3RyZWFtXG4gICAgbGV0IHRyYWNrczogTWVkaWFTdHJlYW1UcmFja1tdXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBzdHJlYW0gPSBuZXcgTWVkaWFTdHJlYW0oKVxuICAgICAgc3RvcmUuZGlzcGF0Y2goU3RyZWFtQWN0aW9ucy5hZGRTdHJlYW0oe1xuICAgICAgICB1c2VySWQsXG4gICAgICAgIHN0cmVhbSxcbiAgICAgIH0pKVxuICAgICAgdHJhY2tzID0gW11cbiAgICAgIDsoc3RyZWFtLmdldFRyYWNrcyBhcyBqZXN0Lk1vY2spLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB0cmFja3MpXG4gICAgICA7KHN0cmVhbS5yZW1vdmVUcmFjayBhcyBqZXN0Lk1vY2spXG4gICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCh0cmFjazogTWVkaWFTdHJlYW1UcmFjaykgPT4ge1xuICAgICAgICB0cmFja3MgPSB0cmFja3MuZmlsdGVyKHQgPT4gdCAhPT0gdHJhY2spXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBpdCgncmVtb3ZlcyBhIHRyYWNrIGZyb20gc3RyZWFtJywgKCkgPT4ge1xuICAgICAgY29uc3QgdHJhY2sgPSBuZXcgTWVkaWFTdHJlYW1UcmFjaygpXG4gICAgICB0cmFja3MgPSBbdHJhY2ssIG5ldyBNZWRpYVN0cmVhbVRyYWNrKCldXG4gICAgICBzdG9yZS5kaXNwYXRjaChTdHJlYW1BY3Rpb25zLnJlbW92ZVRyYWNrKHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBzdHJlYW0sXG4gICAgICAgIHRyYWNrLFxuICAgICAgfSkpXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zKS50b0VxdWFsKHtcbiAgICAgICAgW3VzZXJJZF06IHtcbiAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgc3RyZWFtczogW3tcbiAgICAgICAgICAgIHN0cmVhbSxcbiAgICAgICAgICAgIHVybDogamFzbWluZS5hbnkoU3RyaW5nKSxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGl0KCdyZW1vdmVzIGEgc3RyZWFtIHdoZW4gbm8gdHJhY2tzIGxlZnQgaW4gc3RyZWFtJywgKCkgPT4ge1xuICAgICAgY29uc3QgdHJhY2sgPSBuZXcgTWVkaWFTdHJlYW1UcmFjaygpXG4gICAgICB0cmFja3MgPSBbdHJhY2tdXG4gICAgICBzdG9yZS5kaXNwYXRjaChTdHJlYW1BY3Rpb25zLnJlbW92ZVRyYWNrKHtcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBzdHJlYW0sXG4gICAgICAgIHRyYWNrLFxuICAgICAgfSkpXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zKS50b0VxdWFsKHt9KVxuICAgIH0pXG4gIH0pXG5cbn0pXG4iXX0=