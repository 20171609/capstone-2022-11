"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
exports.__esModule = true;
jest.mock('simple-peer');
jest.mock('../socket');
jest.useFakeTimers();
var simple_peer_1 = __importDefault(require("simple-peer"));
var CallActions_1 = require("../actions/CallActions");
var MediaActions = __importStar(require("../actions/MediaActions"));
var constants_1 = require("../constants");
var socket_1 = __importDefault(require("../socket"));
var store_1 = require("../store");
describe('media', function () {
    var store;
    beforeEach(function () {
        store = store_1.createStore();
        navigator.mediaDevices = {};
    });
    afterEach(function () {
        delete navigator.mediaDevices;
    });
    function toJSON() {
        return JSON.stringify(this);
    }
    describe(constants_1.MEDIA_ENUMERATE, function () {
        beforeEach(function () {
            navigator.mediaDevices.enumerateDevices = function () { return __awaiter(void 0, void 0, void 0, function () {
                var result;
                return __generator(this, function (_a) {
                    result = [{
                            deviceId: 'abcdef1',
                            groupId: 'group1',
                            kind: 'videoinput',
                            label: 'Video Input',
                            toJSON: toJSON
                        }, {
                            deviceId: 'abcdef2',
                            groupId: 'group1',
                            kind: 'audioinput',
                            label: 'Audio Input',
                            toJSON: toJSON
                        }, {
                            deviceId: 'abcdef3',
                            groupId: 'group2',
                            kind: 'audiooutput',
                            label: 'Audio Output',
                            toJSON: toJSON
                        }];
                    return [2 /*return*/, result];
                });
            }); };
        });
        it('retrieves a list of audioinput/videoinput devices', function () { return __awaiter(void 0, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, store.dispatch(MediaActions.enumerateDevices())];
                    case 1:
                        _a.sent();
                        expect(store.getState().media.devices).toEqual([{
                                id: 'abcdef1',
                                name: 'Video Input',
                                type: 'videoinput'
                            }, {
                                id: 'abcdef2',
                                name: 'Audio Input',
                                type: 'audioinput'
                            }]);
                        return [2 /*return*/];
                }
            });
        }); });
        it('handles errors', function () { return __awaiter(void 0, void 0, void 0, function () {
            var err_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        delete navigator.mediaDevices.enumerateDevices;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, store.dispatch(MediaActions.enumerateDevices())];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        err_1 = _a.sent();
                        return [3 /*break*/, 4];
                    case 4:
                        expect(store.getState().media.devices).toEqual([]);
                        expect(store.getState().media.error).toBeTruthy();
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe(constants_1.MEDIA_VIDEO_CONSTRAINT_SET, function () {
        it('sets constraints for video device', function () {
            expect(store.getState().media.video).toEqual({ facingMode: 'user' });
            var constraint = true;
            store.dispatch(MediaActions.setVideoConstraint(constraint));
            expect(store.getState().media.video).toEqual(constraint);
        });
    });
    describe(constants_1.MEDIA_AUDIO_CONSTRAINT_SET, function () {
        it('sets constraints for audio device', function () {
            expect(store.getState().media.audio).toBe(true);
            var constraint = { deviceId: 'abcd' };
            store.dispatch(MediaActions.setAudioConstraint(constraint));
            expect(store.getState().media.audio).toEqual(constraint);
        });
    });
    describe(constants_1.MEDIA_STREAM, function () {
        var track = {};
        var stream = {
            getTracks: function () {
                return [track];
            }
        };
        describe('using navigator.mediaDevices.getUserMedia', function () {
            beforeEach(function () {
                navigator.mediaDevices.getUserMedia = function () { return __awaiter(void 0, void 0, void 0, function () { return __generator(this, function (_a) {
                    return [2 /*return*/, stream];
                }); }); };
            });
            function dispatch() {
                return __awaiter(this, void 0, void 0, function () {
                    var result;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0: return [4 /*yield*/, store.dispatch(MediaActions.getMediaStream({
                                    audio: true,
                                    video: true
                                }))];
                            case 1:
                                result = _a.sent();
                                expect(result.stream).toBe(stream);
                                expect(result.type).toBe(constants_1.STREAM_TYPE_CAMERA);
                                expect(result.userId).toBe(constants_1.ME);
                                return [2 /*return*/];
                        }
                    });
                });
            }
            describe('reducers/streams', function () {
                it('adds the local stream to the map of videos', function () { return __awaiter(void 0, void 0, void 0, function () {
                    var localStreams;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                expect(store.getState().streams[constants_1.ME]).toBeFalsy();
                                return [4 /*yield*/, dispatch()];
                            case 1:
                                _a.sent();
                                localStreams = store.getState().streams[constants_1.ME];
                                expect(localStreams).toBeTruthy();
                                expect(localStreams.streams.length).toBe(1);
                                expect(localStreams.streams[0].type).toBe(constants_1.STREAM_TYPE_CAMERA);
                                expect(localStreams.streams[0].stream).toBe(stream);
                                return [2 /*return*/];
                        }
                    });
                }); });
            });
            describe('reducers/peers', function () {
                var peer1 = new simple_peer_1["default"]();
                var peer2 = new simple_peer_1["default"]();
                var peers = [peer1, peer2];
                beforeEach(function () {
                    store.dispatch({
                        type: constants_1.HANG_UP
                    });
                    store.dispatch({
                        type: constants_1.PEER_ADD,
                        payload: {
                            userId: '1',
                            peer: peer1
                        }
                    });
                    store.dispatch({
                        type: constants_1.PEER_ADD,
                        payload: {
                            userId: '2',
                            peer: peer2
                        }
                    });
                });
                afterEach(function () {
                    store.dispatch({
                        type: constants_1.HANG_UP
                    });
                });
                it('adds local camera stream to all peers', function () { return __awaiter(void 0, void 0, void 0, function () {
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0: return [4 /*yield*/, dispatch()];
                            case 1:
                                _a.sent();
                                peers.forEach(function (peer) {
                                    expect(peer.addTrack.mock.calls)
                                        .toEqual([[track, stream]]);
                                    expect(peer.removeTrack.mock.calls).toEqual([]);
                                });
                                return [4 /*yield*/, dispatch()];
                            case 2:
                                _a.sent();
                                peers.forEach(function (peer) {
                                    expect(peer.addTrack.mock.calls)
                                        .toEqual([[track, stream], [track, stream]]);
                                    expect(peer.removeTrack.mock.calls)
                                        .toEqual([[track, stream]]);
                                });
                                return [2 /*return*/];
                        }
                    });
                }); });
            });
        });
        ['getUserMedia', 'mozGetUserMedia', 'webkitGetUserMedia'].forEach(function (item) {
            describe('compatibility: navigator.' + item, function () {
                beforeEach(function () {
                    var getUserMedia = function (constraint, onSuccess, onError) { return onSuccess(stream); };
                    navigator[item] = getUserMedia;
                });
                afterEach(function () {
                    delete navigator[item];
                });
                it('returns a promise with media stream' + item, function () { return __awaiter(void 0, void 0, void 0, function () {
                    var promise, result;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                promise = MediaActions.getMediaStream({
                                    audio: true,
                                    video: true
                                });
                                expect(promise.type).toBe('MEDIA_STREAM');
                                expect(promise.status).toBe('pending');
                                return [4 /*yield*/, promise];
                            case 1:
                                result = _a.sent();
                                expect(result.stream).toBe(stream);
                                expect(result.userId).toBe(constants_1.ME);
                                return [2 /*return*/];
                        }
                    });
                }); });
            });
        });
    });
    describe('getDesktopStream (getDisplayMedia)', function () {
        var stream = {};
        beforeEach(function () {
            navigator.mediaDevices.getDisplayMedia = function () { return __awaiter(void 0, void 0, void 0, function () { return __generator(this, function (_a) {
                return [2 /*return*/, stream];
            }); }); };
        });
        function dispatch() {
            return __awaiter(this, void 0, void 0, function () {
                var result;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0: return [4 /*yield*/, store.dispatch(MediaActions.getDesktopStream())];
                        case 1:
                            result = _a.sent();
                            expect(result.stream).toBe(stream);
                            expect(result.type).toBe(constants_1.STREAM_TYPE_DESKTOP);
                            expect(result.userId).toBe(constants_1.ME);
                            return [2 /*return*/];
                    }
                });
            });
        }
        it('adds the local stream to the map of videos', function () { return __awaiter(void 0, void 0, void 0, function () {
            var localStreams;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        expect(store.getState().streams[constants_1.ME]).toBeFalsy();
                        return [4 /*yield*/, dispatch()];
                    case 1:
                        _a.sent();
                        localStreams = store.getState().streams[constants_1.ME];
                        expect(localStreams).toBeTruthy();
                        expect(localStreams.streams.length).toBe(1);
                        expect(localStreams.streams[0].type).toBe(constants_1.STREAM_TYPE_DESKTOP);
                        expect(localStreams.streams[0].stream).toBe(stream);
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('dialState', function () {
        function successfulDial() {
            return __awaiter(this, void 0, void 0, function () {
                var promise;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            promise = store.dispatch(CallActions_1.dial());
                            expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_DIALLING);
                            socket_1["default"].emit('users', {
                                initiator: 'test',
                                users: []
                            });
                            jest.runAllTimers();
                            return [4 /*yield*/, promise];
                        case 1:
                            _a.sent();
                            expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_IN_CALL);
                            return [2 /*return*/];
                    }
                });
            });
        }
        it('has dialState HUNG_UP by default', function () {
            expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_HUNG_UP);
        });
        it('changes state from DIALLING to HUNG_UP', function () { return __awaiter(void 0, void 0, void 0, function () {
            var promise, err, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        promise = store.dispatch(CallActions_1.dial());
                        expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_DIALLING);
                        jest.runAllTimers();
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, promise];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        e_1 = _a.sent();
                        err = e_1;
                        return [3 /*break*/, 4];
                    case 4:
                        expect(err).toBeTruthy();
                        expect(err.message).toMatch(/Dial timed out/);
                        expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_HUNG_UP);
                        return [2 /*return*/];
                }
            });
        }); });
        it('changes state from DIALLING to IN_CALL', function () { return __awaiter(void 0, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, successfulDial()];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        }); });
        it('cahnges state to HUNG_UP when destroyPeers is called', function () { return __awaiter(void 0, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, successfulDial()];
                    case 1:
                        _a.sent();
                        store.dispatch(CallActions_1.hangUp());
                        expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_HUNG_UP);
                        return [2 /*return*/];
                }
            });
        }); });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVkaWEudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvcmVkdWNlcnMvbWVkaWEudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDdEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO0FBRXBCLDREQUFvQztBQUNwQyxzREFBcUQ7QUFDckQsb0VBQXVEO0FBQ3ZELDBDQUFpUDtBQUNqUCxxREFBOEI7QUFDOUIsa0NBQTZDO0FBRTdDLFFBQVEsQ0FBQyxPQUFPLEVBQUU7SUFFaEIsSUFBSSxLQUFZLENBQUE7SUFDaEIsVUFBVSxDQUFDO1FBQ1QsS0FBSyxHQUFHLG1CQUFXLEVBQUUsQ0FBQztRQUNyQixTQUFpQixDQUFDLFlBQVksR0FBRyxFQUFFLENBQUE7SUFDdEMsQ0FBQyxDQUFDLENBQUE7SUFFRixTQUFTLENBQUM7UUFDUixPQUFRLFNBQWlCLENBQUMsWUFBWSxDQUFBO0lBQ3hDLENBQUMsQ0FBQyxDQUFBO0lBRUYsU0FBUyxNQUFNO1FBQ2IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzdCLENBQUM7SUFFRCxRQUFRLENBQUMsMkJBQWUsRUFBRTtRQUN4QixVQUFVLENBQUM7WUFDVCxTQUFTLENBQUMsWUFBWSxDQUFDLGdCQUFnQixHQUFHOzs7b0JBQ2xDLE1BQU0sR0FBc0IsQ0FBQzs0QkFDakMsUUFBUSxFQUFFLFNBQVM7NEJBQ25CLE9BQU8sRUFBRSxRQUFROzRCQUNqQixJQUFJLEVBQUUsWUFBWTs0QkFDbEIsS0FBSyxFQUFFLGFBQWE7NEJBQ3BCLE1BQU0sUUFBQTt5QkFDUCxFQUFFOzRCQUNELFFBQVEsRUFBRSxTQUFT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QyxDQUFDLElBQUksQ0FBQywrQkFBbUIsQ0FBQyxDQUFBO3dCQUNsRSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7Ozs7d0JBR2pCLHFCQUFNLE9BQU8sRUFBQTs7d0JBQWIsU0FBYSxDQUFBOzs7O3dCQUViLEdBQUcsR0FBRyxHQUFDLENBQUE7Ozt3QkFFVCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUE7d0JBQ3hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUE7d0JBQzdDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyw4QkFBa0IsQ0FBQyxDQUFBOzs7O2FBQ2xFLENBQUMsQ0FBQTtRQUNGLEVBQUUsQ0FBQyx3Q0FBd0MsRUFBRTs7OzRCQUMzQyxxQkFBTSxjQUFjLEVBQUUsRUFBQTs7d0JBQXRCLFNBQXNCLENBQUE7Ozs7YUFDdkIsQ0FBQyxDQUFBO1FBRUYsRUFBRSxDQUFDLHNEQUFzRCxFQUFFOzs7NEJBQ3pELHFCQUFNLGNBQWMsRUFBRSxFQUFBOzt3QkFBdEIsU0FBc0IsQ0FBQTt3QkFDdEIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxvQkFBTSxFQUFFLENBQUMsQ0FBQTt3QkFDeEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLDhCQUFrQixDQUFDLENBQUE7Ozs7YUFDbEUsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFFSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImplc3QubW9jaygnc2ltcGxlLXBlZXInKVxuamVzdC5tb2NrKCcuLi9zb2NrZXQnKVxuamVzdC51c2VGYWtlVGltZXJzKClcblxuaW1wb3J0IFNpbXBsZVBlZXIgZnJvbSAnc2ltcGxlLXBlZXInXG5pbXBvcnQgeyBkaWFsLCBoYW5nVXAgfSBmcm9tICcuLi9hY3Rpb25zL0NhbGxBY3Rpb25zJ1xuaW1wb3J0ICogYXMgTWVkaWFBY3Rpb25zIGZyb20gJy4uL2FjdGlvbnMvTWVkaWFBY3Rpb25zJ1xuaW1wb3J0IHsgRElBTF9TVEFURV9ESUFMTElORywgRElBTF9TVEFURV9IVU5HX1VQLCBESUFMX1NUQVRFX0lOX0NBTEwsIEhBTkdfVVAsIE1FLCBNRURJQV9BVURJT19DT05TVFJBSU5UX1NFVCwgTUVESUFfRU5VTUVSQVRFLCBNRURJQV9TVFJFQU0sIE1FRElBX1ZJREVPX0NPTlNUUkFJTlRfU0VULCBQRUVSX0FERCwgU1RSRUFNX1RZUEVfQ0FNRVJBLCBTVFJFQU1fVFlQRV9ERVNLVE9QIH0gZnJvbSAnLi4vY29uc3RhbnRzJ1xuaW1wb3J0IHNvY2tldCBmcm9tICcuLi9zb2NrZXQnXG5pbXBvcnQgeyBjcmVhdGVTdG9yZSwgU3RvcmUgfSBmcm9tICcuLi9zdG9yZSdcblxuZGVzY3JpYmUoJ21lZGlhJywgKCkgPT4ge1xuXG4gIGxldCBzdG9yZTogU3RvcmVcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgc3RvcmUgPSBjcmVhdGVTdG9yZSgpO1xuICAgIChuYXZpZ2F0b3IgYXMgYW55KS5tZWRpYURldmljZXMgPSB7fVxuICB9KVxuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgZGVsZXRlIChuYXZpZ2F0b3IgYXMgYW55KS5tZWRpYURldmljZXNcbiAgfSlcblxuICBmdW5jdGlvbiB0b0pTT04odGhpczogTWVkaWFEZXZpY2VJbmZvKSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMpXG4gIH1cblxuICBkZXNjcmliZShNRURJQV9FTlVNRVJBVEUsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcyA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBNZWRpYURldmljZUluZm9bXSA9IFt7XG4gICAgICAgICAgZGV2aWNlSWQ6ICdhYmNkZWYxJyxcbiAgICAgICAgICBncm91cElkOiAnZ3JvdXAxJyxcbiAgICAgICAgICBraW5kOiAndmlkZW9pbnB1dCcsXG4gICAgICAgICAgbGFiZWw6ICdWaWRlbyBJbnB1dCcsXG4gICAgICAgICAgdG9KU09OLFxuICAgICAgICB9LCB7XG4gICAgICAgICAgZGV2aWNlSWQ6ICdhYmNkZWYyJyxcbiAgICAgICAgICBncm91cElkOiAnZ3JvdXAxJyxcbiAgICAgICAgICBraW5kOiAnYXVkaW9pbnB1dCcsXG4gICAgICAgICAgbGFiZWw6ICdBdWRpbyBJbnB1dCcsXG4gICAgICAgICAgdG9KU09OLFxuICAgICAgICB9LCB7XG4gICAgICAgICAgZGV2aWNlSWQ6ICdhYmNkZWYzJyxcbiAgICAgICAgICBncm91cElkOiAnZ3JvdXAyJyxcbiAgICAgICAgICBraW5kOiAnYXVkaW9vdXRwdXQnLFxuICAgICAgICAgIGxhYmVsOiAnQXVkaW8gT3V0cHV0JyxcbiAgICAgICAgICB0b0pTT04sXG4gICAgICAgIH1dXG4gICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgaXQoJ3JldHJpZXZlcyBhIGxpc3Qgb2YgYXVkaW9pbnB1dC92aWRlb2lucHV0IGRldmljZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzdG9yZS5kaXNwYXRjaChNZWRpYUFjdGlvbnMuZW51bWVyYXRlRGV2aWNlcygpKVxuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkubWVkaWEuZGV2aWNlcykudG9FcXVhbChbe1xuICAgICAgICBpZDogJ2FiY2RlZjEnLFxuICAgICAgICBuYW1lOiAnVmlkZW8gSW5wdXQnLFxuICAgICAgICB0eXBlOiAndmlkZW9pbnB1dCcsXG4gICAgICB9LCB7XG4gICAgICAgIGlkOiAnYWJjZGVmMicsXG4gICAgICAgIG5hbWU6ICdBdWRpbyBJbnB1dCcsXG4gICAgICAgIHR5cGU6ICdhdWRpb2lucHV0JyxcbiAgICAgIH1dKVxuICAgIH0pXG5cbiAgICBpdCgnaGFuZGxlcyBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBkZWxldGUgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBzdG9yZS5kaXNwYXRjaChNZWRpYUFjdGlvbnMuZW51bWVyYXRlRGV2aWNlcygpKVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgIH1cbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLmRldmljZXMpLnRvRXF1YWwoW10pXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZWRpYS5lcnJvcikudG9CZVRydXRoeSgpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZShNRURJQV9WSURFT19DT05TVFJBSU5UX1NFVCwgKCkgPT4ge1xuICAgIGl0KCdzZXRzIGNvbnN0cmFpbnRzIGZvciB2aWRlbyBkZXZpY2UnLCAoKSA9PiB7XG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZWRpYS52aWRlbykudG9FcXVhbCh7IGZhY2luZ01vZGU6ICd1c2VyJyB9KVxuICAgICAgY29uc3QgY29uc3RyYWludDogTWVkaWFBY3Rpb25zLlZpZGVvQ29uc3RyYWludCA9IHRydWVcbiAgICAgIHN0b3JlLmRpc3BhdGNoKE1lZGlhQWN0aW9ucy5zZXRWaWRlb0NvbnN0cmFpbnQoY29uc3RyYWludCkpXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZWRpYS52aWRlbykudG9FcXVhbChjb25zdHJhaW50KVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoTUVESUFfQVVESU9fQ09OU1RSQUlOVF9TRVQsICgpID0+IHtcbiAgICBpdCgnc2V0cyBjb25zdHJhaW50cyBmb3IgYXVkaW8gZGV2aWNlJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkubWVkaWEuYXVkaW8pLnRvQmUodHJ1ZSlcbiAgICAgIGNvbnN0IGNvbnN0cmFpbnQ6IE1lZGlhQWN0aW9ucy5BdWRpb0NvbnN0cmFpbnQgPSB7IGRldmljZUlkOiAnYWJjZCcgfVxuICAgICAgc3RvcmUuZGlzcGF0Y2goTWVkaWFBY3Rpb25zLnNldEF1ZGlvQ29uc3RyYWludChjb25zdHJhaW50KSlcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLmF1ZGlvKS50b0VxdWFsKGNvbnN0cmFpbnQpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZShNRURJQV9TVFJFQU0sICgpID0+IHtcbiAgICBjb25zdCB0cmFjazogTWVkaWFTdHJlYW1UcmFjayA9IHt9IGFzIHVua25vd24gYXMgTWVkaWFTdHJlYW1UcmFja1xuICAgIGNvbnN0IHN0cmVhbTogTWVkaWFTdHJlYW0gPSB7XG4gICAgICBnZXRUcmFja3MoKSB7XG4gICAgICAgIHJldHVybiBbdHJhY2tdXG4gICAgICB9LFxuICAgIH0gYXMgTWVkaWFTdHJlYW1cbiAgICBkZXNjcmliZSgndXNpbmcgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEnLCAoKSA9PiB7XG5cbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGFzeW5jICgpID0+IHN0cmVhbVxuICAgICAgfSlcblxuICAgICAgYXN5bmMgZnVuY3Rpb24gZGlzcGF0Y2goKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHN0b3JlLmRpc3BhdGNoKE1lZGlhQWN0aW9ucy5nZXRNZWRpYVN0cmVhbSh7XG4gICAgICAgICAgYXVkaW86IHRydWUsXG4gICAgICAgICAgdmlkZW86IHRydWUsXG4gICAgICAgIH0pKVxuICAgICAgICBleHBlY3QocmVzdWx0LnN0cmVhbSkudG9CZShzdHJlYW0pXG4gICAgICAgIGV4cGVjdChyZXN1bHQudHlwZSkudG9CZShTVFJFQU1fVFlQRV9DQU1FUkEpXG4gICAgICAgIGV4cGVjdChyZXN1bHQudXNlcklkKS50b0JlKE1FKVxuICAgICAgfVxuXG4gICAgICBkZXNjcmliZSgncmVkdWNlcnMvc3RyZWFtcycsICgpID0+IHtcbiAgICAgICAgaXQoJ2FkZHMgdGhlIGxvY2FsIHN0cmVhbSB0byB0aGUgbWFwIG9mIHZpZGVvcycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zW01FXSkudG9CZUZhbHN5KClcbiAgICAgICAgICBhd2FpdCBkaXNwYXRjaCgpXG4gICAgICAgICAgY29uc3QgbG9jYWxTdHJlYW1zID0gc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zW01FXVxuICAgICAgICAgIGV4cGVjdChsb2NhbFN0cmVhbXMpLnRvQmVUcnV0aHkoKVxuICAgICAgICAgIGV4cGVjdChsb2NhbFN0cmVhbXMuc3RyZWFtcy5sZW5ndGgpLnRvQmUoMSlcbiAgICAgICAgICBleHBlY3QobG9jYWxTdHJlYW1zLnN0cmVhbXNbMF0udHlwZSkudG9CZShTVFJFQU1fVFlQRV9DQU1FUkEpXG4gICAgICAgICAgZXhwZWN0KGxvY2FsU3RyZWFtcy5zdHJlYW1zWzBdLnN0cmVhbSkudG9CZShzdHJlYW0pXG4gICAgICAgIH0pXG4gICAgICB9KVxuXG4gICAgICBkZXNjcmliZSgncmVkdWNlcnMvcGVlcnMnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBlZXIxID0gbmV3IFNpbXBsZVBlZXIoKVxuICAgICAgICBjb25zdCBwZWVyMiA9IG5ldyBTaW1wbGVQZWVyKClcbiAgICAgICAgY29uc3QgcGVlcnMgPSBbcGVlcjEsIHBlZXIyXVxuXG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICAgIHN0b3JlLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIHR5cGU6IEhBTkdfVVAsXG4gICAgICAgICAgfSlcbiAgICAgICAgICBzdG9yZS5kaXNwYXRjaCh7XG4gICAgICAgICAgICB0eXBlOiBQRUVSX0FERCxcbiAgICAgICAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgICAgICAgdXNlcklkOiAnMScsXG4gICAgICAgICAgICAgIHBlZXI6IHBlZXIxLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIHN0b3JlLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIHR5cGU6IFBFRVJfQURELFxuICAgICAgICAgICAgcGF5bG9hZDoge1xuICAgICAgICAgICAgICB1c2VySWQ6ICcyJyxcbiAgICAgICAgICAgICAgcGVlcjogcGVlcjIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cbiAgICAgICAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAgICAgICBzdG9yZS5kaXNwYXRjaCh7XG4gICAgICAgICAgICB0eXBlOiBIQU5HX1VQLFxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cbiAgICAgICAgaXQoJ2FkZHMgbG9jYWwgY2FtZXJhIHN0cmVhbSB0byBhbGwgcGVlcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgYXdhaXQgZGlzcGF0Y2goKVxuICAgICAgICAgIHBlZXJzLmZvckVhY2gocGVlciA9PiB7XG4gICAgICAgICAgICBleHBlY3QoKHBlZXIuYWRkVHJhY2sgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzKVxuICAgICAgICAgICAgLnRvRXF1YWwoW1sgdHJhY2ssIHN0cmVhbSBdXSlcbiAgICAgICAgICAgIGV4cGVjdCgocGVlci5yZW1vdmVUcmFjayBhcyBhbnkpLm1vY2suY2FsbHMpLnRvRXF1YWwoW10pXG4gICAgICAgICAgfSlcbiAgICAgICAgICBhd2FpdCBkaXNwYXRjaCgpXG4gICAgICAgICAgcGVlcnMuZm9yRWFjaChwZWVyID0+IHtcbiAgICAgICAgICAgIGV4cGVjdCgocGVlci5hZGRUcmFjayBhcyBqZXN0Lk1vY2spLm1vY2suY2FsbHMpXG4gICAgICAgICAgICAudG9FcXVhbChbWyB0cmFjaywgc3RyZWFtIF0sIFsgdHJhY2ssIHN0cmVhbSBdXSlcbiAgICAgICAgICAgIGV4cGVjdCgocGVlci5yZW1vdmVUcmFjayBhcyBqZXN0Lk1vY2spLm1vY2suY2FsbHMpXG4gICAgICAgICAgICAudG9FcXVhbChbWyB0cmFjaywgc3RyZWFtIF1dKVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0pO1xuXG4gICAgWydnZXRVc2VyTWVkaWEnLCAnbW96R2V0VXNlck1lZGlhJywgJ3dlYmtpdEdldFVzZXJNZWRpYSddLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBkZXNjcmliZSgnY29tcGF0aWJpbGl0eTogbmF2aWdhdG9yLicgKyBpdGVtLCAoKSA9PiB7XG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGdldFVzZXJNZWRpYTogdHlwZW9mIG5hdmlnYXRvci5nZXRVc2VyTWVkaWEgPVxuICAgICAgICAgICAgKGNvbnN0cmFpbnQsIG9uU3VjY2Vzcywgb25FcnJvcikgPT4gb25TdWNjZXNzKHN0cmVhbSk7XG4gICAgICAgICAgKG5hdmlnYXRvciBhcyBhbnkpW2l0ZW1dID0gZ2V0VXNlck1lZGlhXG4gICAgICAgIH0pXG4gICAgICAgIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgICAgICAgZGVsZXRlIChuYXZpZ2F0b3IgYXMgYW55KVtpdGVtXVxuICAgICAgICB9KVxuICAgICAgICBpdCgncmV0dXJucyBhIHByb21pc2Ugd2l0aCBtZWRpYSBzdHJlYW0nICsgaXRlbSwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHByb21pc2UgPSBNZWRpYUFjdGlvbnMuZ2V0TWVkaWFTdHJlYW0oe1xuICAgICAgICAgICAgYXVkaW86IHRydWUsXG4gICAgICAgICAgICB2aWRlbzogdHJ1ZSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIGV4cGVjdChwcm9taXNlLnR5cGUpLnRvQmUoJ01FRElBX1NUUkVBTScpXG4gICAgICAgICAgZXhwZWN0KHByb21pc2Uuc3RhdHVzKS50b0JlKCdwZW5kaW5nJylcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBwcm9taXNlXG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdHJlYW0pLnRvQmUoc3RyZWFtKVxuICAgICAgICAgIGV4cGVjdChyZXN1bHQudXNlcklkKS50b0JlKE1FKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdnZXREZXNrdG9wU3RyZWFtIChnZXREaXNwbGF5TWVkaWEpJywgKCkgPT4ge1xuICAgIGNvbnN0IHN0cmVhbTogTWVkaWFTdHJlYW0gPSB7fSBhcyBNZWRpYVN0cmVhbVxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgKG5hdmlnYXRvci5tZWRpYURldmljZXMgYXMgYW55KS5nZXREaXNwbGF5TWVkaWEgPSBhc3luYyAoKSA9PiBzdHJlYW1cbiAgICB9KVxuICAgIGFzeW5jIGZ1bmN0aW9uIGRpc3BhdGNoKCkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3RvcmUuZGlzcGF0Y2goTWVkaWFBY3Rpb25zLmdldERlc2t0b3BTdHJlYW0oKSlcbiAgICAgIGV4cGVjdChyZXN1bHQuc3RyZWFtKS50b0JlKHN0cmVhbSlcbiAgICAgIGV4cGVjdChyZXN1bHQudHlwZSkudG9CZShTVFJFQU1fVFlQRV9ERVNLVE9QKVxuICAgICAgZXhwZWN0KHJlc3VsdC51c2VySWQpLnRvQmUoTUUpXG4gICAgfVxuICAgIGl0KCdhZGRzIHRoZSBsb2NhbCBzdHJlYW0gdG8gdGhlIG1hcCBvZiB2aWRlb3MnLCBhc3luYyAoKSA9PiB7XG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zW01FXSkudG9CZUZhbHN5KClcbiAgICAgIGF3YWl0IGRpc3BhdGNoKClcbiAgICAgIGNvbnN0IGxvY2FsU3RyZWFtcyA9IHN0b3JlLmdldFN0YXRlKCkuc3RyZWFtc1tNRV1cbiAgICAgIGV4cGVjdChsb2NhbFN0cmVhbXMpLnRvQmVUcnV0aHkoKVxuICAgICAgZXhwZWN0KGxvY2FsU3RyZWFtcy5zdHJlYW1zLmxlbmd0aCkudG9CZSgxKVxuICAgICAgZXhwZWN0KGxvY2FsU3RyZWFtcy5zdHJlYW1zWzBdLnR5cGUpLnRvQmUoU1RSRUFNX1RZUEVfREVTS1RPUClcbiAgICAgIGV4cGVjdChsb2NhbFN0cmVhbXMuc3RyZWFtc1swXS5zdHJlYW0pLnRvQmUoc3RyZWFtKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ2RpYWxTdGF0ZScsICgpID0+IHtcbiAgICBhc3luYyBmdW5jdGlvbiBzdWNjZXNzZnVsRGlhbCgpIHtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBzdG9yZS5kaXNwYXRjaChkaWFsKCkpXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZWRpYS5kaWFsU3RhdGUpLnRvQmUoRElBTF9TVEFURV9ESUFMTElORylcbiAgICAgIHNvY2tldC5lbWl0KCd1c2VycycsIHtcbiAgICAgICAgaW5pdGlhdG9yOiAndGVzdCcsXG4gICAgICAgIHVzZXJzOiBbXSxcbiAgICAgIH0pXG4gICAgICBqZXN0LnJ1bkFsbFRpbWVycygpXG4gICAgICBhd2FpdCBwcm9taXNlXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZWRpYS5kaWFsU3RhdGUpLnRvQmUoRElBTF9TVEFURV9JTl9DQUxMKVxuICAgIH1cblxuICAgIGl0KCdoYXMgZGlhbFN0YXRlIEhVTkdfVVAgYnkgZGVmYXVsdCcsICgpID0+IHtcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLmRpYWxTdGF0ZSkudG9CZShESUFMX1NUQVRFX0hVTkdfVVApXG4gICAgfSlcbiAgICBpdCgnY2hhbmdlcyBzdGF0ZSBmcm9tIERJQUxMSU5HIHRvIEhVTkdfVVAnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9taXNlID0gc3RvcmUuZGlzcGF0Y2goZGlhbCgpKVxuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkubWVkaWEuZGlhbFN0YXRlKS50b0JlKERJQUxfU1RBVEVfRElBTExJTkcpXG4gICAgICBqZXN0LnJ1bkFsbFRpbWVycygpXG4gICAgICBsZXQgZXJyITogRXJyb3JcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHByb21pc2VcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZXJyID0gZVxuICAgICAgfVxuICAgICAgZXhwZWN0KGVycikudG9CZVRydXRoeSgpXG4gICAgICBleHBlY3QoZXJyLm1lc3NhZ2UpLnRvTWF0Y2goL0RpYWwgdGltZWQgb3V0LylcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLmRpYWxTdGF0ZSkudG9CZShESUFMX1NUQVRFX0hVTkdfVVApXG4gICAgfSlcbiAgICBpdCgnY2hhbmdlcyBzdGF0ZSBmcm9tIERJQUxMSU5HIHRvIElOX0NBTEwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzdWNjZXNzZnVsRGlhbCgpXG4gICAgfSlcblxuICAgIGl0KCdjYWhuZ2VzIHN0YXRlIHRvIEhVTkdfVVAgd2hlbiBkZXN0cm95UGVlcnMgaXMgY2FsbGVkJywgYXN5bmMoKSA9PiB7XG4gICAgICBhd2FpdCBzdWNjZXNzZnVsRGlhbCgpXG4gICAgICBzdG9yZS5kaXNwYXRjaChoYW5nVXAoKSlcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLmRpYWxTdGF0ZSkudG9CZShESUFMX1NUQVRFX0hVTkdfVVApXG4gICAgfSlcbiAgfSlcblxufSlcbiJdfQ==