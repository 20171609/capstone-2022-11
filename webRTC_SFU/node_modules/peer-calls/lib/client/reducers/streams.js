"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __spreadArrays = (this && this.__spreadArrays) || function () {
    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;
    for (var r = Array(s), k = 0, i = 0; i < il; i++)
        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)
            r[k] = a[j];
    return r;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
var debug_1 = __importDefault(require("debug"));
var forEach_1 = __importDefault(require("lodash/forEach"));
var omit_1 = __importDefault(require("lodash/omit"));
var constants_1 = require("../constants");
var window_1 = require("../window");
var debug = debug_1["default"]('peercalls');
var defaultState = Object.freeze({});
function safeCreateObjectURL(stream) {
    try {
        return window_1.createObjectURL(stream);
    }
    catch (err) {
        debug('Error using createObjectURL: %s', err);
        return undefined;
    }
}
function addStream(state, payload) {
    var _a;
    var userId = payload.userId, stream = payload.stream;
    var userStreams = state[userId] || {
        userId: userId,
        streams: []
    };
    if (userStreams.streams.map(function (s) { return s.stream; }).indexOf(stream) >= 0) {
        return state;
    }
    var streamWithURL = {
        stream: stream,
        type: payload.type,
        url: safeCreateObjectURL(stream)
    };
    return __assign(__assign({}, state), (_a = {}, _a[userId] = {
        userId: userId,
        streams: __spreadArrays(userStreams.streams, [streamWithURL])
    }, _a));
}
function removeStream(state, payload) {
    var _a;
    var userId = payload.userId, stream = payload.stream;
    var userStreams = state[userId];
    if (!userStreams) {
        return state;
    }
    if (stream) {
        var streams_1 = userStreams.streams.filter(function (s) {
            var found = s.stream === stream;
            if (found) {
                stream.getTracks().forEach(function (track) { return track.stop(); });
                s.url && window_1.revokeObjectURL(s.url);
            }
            return !found;
        });
        if (streams_1.length > 0) {
            return __assign(__assign({}, state), (_a = {}, _a[userId] = {
                userId: userId,
                streams: streams_1
            }, _a));
        }
        else {
            omit_1["default"](state, [userId]);
        }
    }
    userStreams && userStreams.streams.forEach(function (s) {
        s.stream.getTracks().forEach(function (track) { return track.stop(); });
        s.url && window_1.revokeObjectURL(s.url);
    });
    return omit_1["default"](state, [userId]);
}
function removeStreamTrack(state, payload) {
    var userId = payload.userId, stream = payload.stream, track = payload.track;
    var userStreams = state[userId];
    if (!userStreams) {
        return state;
    }
    var index = userStreams.streams.map(function (s) { return s.stream; }).indexOf(stream);
    if (index < 0) {
        return state;
    }
    stream.removeTrack(track);
    if (stream.getTracks().length === 0) {
        return removeStream(state, { userId: userId, stream: stream });
    }
    // UI does not update when a stream track is removed so there is no need to
    // update the state object
    return state;
}
function addStreamTrack(state, payload) {
    var userId = payload.userId, stream = payload.stream, track = payload.track;
    var userStreams = state[userId];
    var existingUserStream = userStreams && userStreams.streams.find(function (s) { return s.stream === stream; });
    if (!stream.getTracks().includes(track)) {
        stream.addTrack(track);
    }
    if (!existingUserStream) {
        return addStream(state, {
            stream: payload.stream,
            userId: payload.userId
        });
    }
    return state;
}
function streams(state, action) {
    if (state === void 0) { state = defaultState; }
    switch (action.type) {
        case constants_1.STREAM_ADD:
            return addStream(state, action.payload);
        case constants_1.STREAM_REMOVE:
            return removeStream(state, action.payload);
        case constants_1.STREAM_TRACK_ADD:
            return addStreamTrack(state, action.payload);
        case constants_1.STREAM_TRACK_REMOVE:
            return removeStreamTrack(state, action.payload);
        case constants_1.HANG_UP:
            forEach_1["default"](state, function (userStreams) {
                userStreams.streams.forEach(function (s) {
                    s.stream.getTracks().forEach(function (track) {
                        track.onmute = null;
                        track.onunmute = null;
                    });
                });
            });
            return defaultState;
        case constants_1.MEDIA_STREAM:
            if (action.status === 'resolved') {
                return addStream(state, action.payload);
            }
            else {
                return state;
            }
        default:
            return state;
    }
}
exports["default"] = streams;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyZWFtcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvcmVkdWNlcnMvc3RyZWFtcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUEwQjtBQUMxQiwyREFBb0M7QUFDcEMscURBQThCO0FBSTlCLDBDQUFzSDtBQUN0SCxvQ0FBNEQ7QUFFNUQsSUFBTSxLQUFLLEdBQUcsa0JBQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtBQUNqQyxJQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0FBRXRDLFNBQVMsbUJBQW1CLENBQUUsTUFBbUI7SUFDL0MsSUFBSTtRQUNGLE9BQU8sd0JBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtLQUMvQjtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQzdDLE9BQU8sU0FBUyxDQUFBO0tBQ2pCO0FBQ0gsQ0FBQztBQWlCRCxTQUFTLFNBQVMsQ0FDaEIsS0FBbUIsRUFBRSxPQUFtQzs7SUFFaEQsSUFBQSx1QkFBTSxFQUFFLHVCQUFNLENBQVk7SUFFbEMsSUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJO1FBQ25DLE1BQU0sUUFBQTtRQUNOLE9BQU8sRUFBRSxFQUFFO0tBQ1osQ0FBQTtJQUVELElBQUksV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsTUFBTSxFQUFSLENBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDL0QsT0FBTyxLQUFLLENBQUE7S0FDYjtJQUVELElBQU0sYUFBYSxHQUFrQjtRQUNuQyxNQUFNLFFBQUE7UUFDTixJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7UUFDbEIsR0FBRyxFQUFF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QU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNqRCxLQUFLLG1CQUFPO1lBQ1Ysb0JBQU8sQ0FBQyxLQUFLLEVBQUUsVUFBQSxXQUFXO2dCQUN4QixXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLENBQUM7b0JBQzNCLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUEsS0FBSzt3QkFDaEMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUE7d0JBQ25CLEtBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFBO29CQUN2QixDQUFDLENBQUMsQ0FBQTtnQkFDSixDQUFDLENBQUMsQ0FBQTtZQUNKLENBQUMsQ0FBQyxDQUFBO1lBQ0YsT0FBTyxZQUFZLENBQUE7UUFDckIsS0FBSyx3QkFBWTtZQUNmLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxVQUFVLEVBQUU7Z0JBQ2hDLE9BQU8sU0FBUyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUE7YUFDeEM7aUJBQU07Z0JBQ0wsT0FBTyxLQUFLLENBQUE7YUFDYjtRQUNIO1lBQ0UsT0FBTyxLQUFLLENBQUE7S0FDZjtBQUNILENBQUM7QUFoQ0QsNkJBZ0NDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF9kZWJ1ZyBmcm9tICdkZWJ1ZydcbmltcG9ydCBmb3JFYWNoIGZyb20gJ2xvZGFzaC9mb3JFYWNoJ1xuaW1wb3J0IG9taXQgZnJvbSAnbG9kYXNoL29taXQnXG5pbXBvcnQgeyBIYW5nVXBBY3Rpb24gfSBmcm9tICcuLi9hY3Rpb25zL0NhbGxBY3Rpb25zJ1xuaW1wb3J0IHsgTWVkaWFTdHJlYW1BY3Rpb24gfSBmcm9tICcuLi9hY3Rpb25zL01lZGlhQWN0aW9ucydcbmltcG9ydCB7IEFkZFN0cmVhbUFjdGlvbiwgQWRkU3RyZWFtVHJhY2tBY3Rpb24sIFJlbW92ZVN0cmVhbUFjdGlvbiwgUmVtb3ZlU3RyZWFtVHJhY2tBY3Rpb24sIFN0cmVhbUFjdGlvbiwgU3RyZWFtVHlwZSB9IGZyb20gJy4uL2FjdGlvbnMvU3RyZWFtQWN0aW9ucydcbmltcG9ydCB7IEhBTkdfVVAsIE1FRElBX1NUUkVBTSwgU1RSRUFNX0FERCwgU1RSRUFNX1JFTU9WRSwgU1RSRUFNX1RSQUNLX0FERCwgU1RSRUFNX1RSQUNLX1JFTU9WRSB9IGZyb20gJy4uL2NvbnN0YW50cydcbmltcG9ydCB7IGNyZWF0ZU9iamVjdFVSTCwgcmV2b2tlT2JqZWN0VVJMIH0gZnJvbSAnLi4vd2luZG93J1xuXG5jb25zdCBkZWJ1ZyA9IF9kZWJ1ZygncGVlcmNhbGxzJylcbmNvbnN0IGRlZmF1bHRTdGF0ZSA9IE9iamVjdC5mcmVlemUoe30pXG5cbmZ1bmN0aW9uIHNhZmVDcmVhdGVPYmplY3RVUkwgKHN0cmVhbTogTWVkaWFTdHJlYW0pIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gY3JlYXRlT2JqZWN0VVJMKHN0cmVhbSlcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZGVidWcoJ0Vycm9yIHVzaW5nIGNyZWF0ZU9iamVjdFVSTDogJXMnLCBlcnIpXG4gICAgcmV0dXJuIHVuZGVmaW5lZFxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RyZWFtV2l0aFVSTCB7XG4gIHN0cmVhbTogTWVkaWFTdHJlYW1cbiAgdHlwZTogU3RyZWFtVHlwZSB8IHVuZGVmaW5lZFxuICB1cmw/OiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBVc2VyU3RyZWFtcyB7XG4gIHVzZXJJZDogc3RyaW5nXG4gIHN0cmVhbXM6IFN0cmVhbVdpdGhVUkxbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN0cmVhbXNTdGF0ZSB7XG4gIFt1c2VySWQ6IHN0cmluZ106IFVzZXJTdHJlYW1zXG59XG5cbmZ1bmN0aW9uIGFkZFN0cmVhbSAoXG4gIHN0YXRlOiBTdHJlYW1zU3RhdGUsIHBheWxvYWQ6IEFkZFN0cmVhbUFjdGlvblsncGF5bG9hZCddLFxuKTogU3RyZWFtc1N0YXRlIHtcbiAgY29uc3QgeyB1c2VySWQsIHN0cmVhbSB9ID0gcGF5bG9hZFxuXG4gIGNvbnN0IHVzZXJTdHJlYW1zID0gc3RhdGVbdXNlcklkXSB8fCB7XG4gICAgdXNlcklkLFxuICAgIHN0cmVhbXM6IFtdLFxuICB9XG5cbiAgaWYgKHVzZXJTdHJlYW1zLnN0cmVhbXMubWFwKHMgPT4gcy5zdHJlYW0pLmluZGV4T2Yoc3RyZWFtKSA+PSAwKSB7XG4gICAgcmV0dXJuIHN0YXRlXG4gIH1cblxuICBjb25zdCBzdHJlYW1XaXRoVVJMOiBTdHJlYW1XaXRoVVJMID0ge1xuICAgIHN0cmVhbSxcbiAgICB0eXBlOiBwYXlsb2FkLnR5cGUsXG4gICAgdXJsOiBzYWZlQ3JlYXRlT2JqZWN0VVJMKHN0cmVhbSksXG4gIH1cblxuICByZXR1cm4ge1xuICAgIC4uLnN0YXRlLFxuICAgIFt1c2VySWRdOiB7XG4gICAgICB1c2VySWQsXG4gICAgICBzdHJlYW1zOiBbLi4udXNlclN0cmVhbXMuc3RyZWFtcywgc3RyZWFtV2l0aFVSTF0sXG4gICAgfSxcbiAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVTdHJlYW0gKFxuICBzdGF0ZTogU3RyZWFtc1N0YXRlLCBwYXlsb2FkOiBSZW1vdmVTdHJlYW1BY3Rpb25bJ3BheWxvYWQnXSxcbik6IFN0cmVhbXNTdGF0ZSB7XG4gIGNvbnN0IHsgdXNlcklkLCBzdHJlYW0gfSA9IHBheWxvYWRcbiAgY29uc3QgdXNlclN0cmVhbXMgPSBzdGF0ZVt1c2VySWRdXG4gIGlmICghdXNlclN0cmVhbXMpIHtcbiAgICByZXR1cm4gc3RhdGVcbiAgfVxuXG4gIGlmIChzdHJlYW0pIHtcbiAgICBjb25zdCBzdHJlYW1zID0gdXNlclN0cmVhbXMuc3RyZWFtcy5maWx0ZXIocyA9PiB7XG4gICAgICBjb25zdCBmb3VuZCA9IHMuc3RyZWFtID09PSBzdHJlYW1cbiAgICAgIGlmIChmb3VuZCkge1xuICAgICAgICBzdHJlYW0uZ2V0VHJhY2tzKCkuZm9yRWFjaCh0cmFjayA9PiB0cmFjay5zdG9wKCkpXG4gICAgICAgIHMudXJsICYmIHJldm9rZU9iamVjdFVSTChzLnVybClcbiAgICAgIH1cbiAgICAgIHJldHVybiAhZm91bmRcbiAgICB9KVxuICAgIGlmIChzdHJlYW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBbdXNlcklkXToge1xuICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICBzdHJlYW1zLFxuICAgICAgICB9LFxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBvbWl0KHN0YXRlLCBbdXNlcklkXSlcbiAgICB9XG4gIH1cblxuICB1c2VyU3RyZWFtcyAmJiB1c2VyU3RyZWFtcy5zdHJlYW1zLmZvckVhY2gocyA9PiB7XG4gICAgcy5zdHJlYW0uZ2V0VHJhY2tzKCkuZm9yRWFjaCh0cmFjayA9PiB0cmFjay5zdG9wKCkpXG4gICAgcy51cmwgJiYgcmV2b2tlT2JqZWN0VVJMKHMudXJsKVxuICB9KVxuICByZXR1cm4gb21pdChzdGF0ZSwgW3VzZXJJZF0pXG59XG5cbmZ1bmN0aW9uIHJlbW92ZVN0cmVhbVRyYWNrKFxuICBzdGF0ZTogU3RyZWFtc1N0YXRlLCBwYXlsb2FkOiBSZW1vdmVTdHJlYW1UcmFja0FjdGlvblsncGF5bG9hZCddLFxuKTogU3RyZWFtc1N0YXRlIHtcbiAgY29uc3QgeyB1c2VySWQsIHN0cmVhbSwgdHJhY2sgfSA9IHBheWxvYWRcbiAgY29uc3QgdXNlclN0cmVhbXMgPSBzdGF0ZVt1c2VySWRdXG4gIGlmICghdXNlclN0cmVhbXMpIHtcbiAgICByZXR1cm4gc3RhdGVcbiAgfVxuICBjb25zdCBpbmRleCA9IHVzZXJTdHJlYW1zLnN0cmVhbXMubWFwKHMgPT4gcy5zdHJlYW0pLmluZGV4T2Yoc3RyZWFtKVxuICBpZiAoaW5kZXggPCAwKSB7XG4gICAgcmV0dXJuIHN0YXRlXG4gIH1cbiAgc3RyZWFtLnJlbW92ZVRyYWNrKHRyYWNrKVxuICBpZiAoc3RyZWFtLmdldFRyYWNrcygpLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiByZW1vdmVTdHJlYW0oc3RhdGUsIHt1c2VySWQsIHN0cmVhbX0pXG4gIH1cbiAgLy8gVUkgZG9lcyBub3QgdXBkYXRlIHdoZW4gYSBzdHJlYW0gdHJhY2sgaXMgcmVtb3ZlZCBzbyB0aGVyZSBpcyBubyBuZWVkIHRvXG4gIC8vIHVwZGF0ZSB0aGUgc3RhdGUgb2JqZWN0XG4gIHJldHVybiBzdGF0ZVxufVxuXG5mdW5jdGlvbiBhZGRTdHJlYW1UcmFjayhcbiAgc3RhdGU6IFN0cmVhbXNTdGF0ZSwgcGF5bG9hZDogQWRkU3RyZWFtVHJhY2tBY3Rpb25bJ3BheWxvYWQnXSxcbik6IFN0cmVhbXNTdGF0ZSB7XG4gIGNvbnN0IHsgdXNlcklkLCBzdHJlYW0sIHRyYWNrIH0gPSBwYXlsb2FkXG4gIGNvbnN0IHVzZXJTdHJlYW1zID0gc3RhdGVbdXNlcklkXVxuICBjb25zdCBleGlzdGluZ1VzZXJTdHJlYW0gPVxuICAgIHVzZXJTdHJlYW1zICYmIHVzZXJTdHJlYW1zLnN0cmVhbXMuZmluZChzID0+IHMuc3RyZWFtID09PSBzdHJlYW0pXG5cbiAgaWYgKCFzdHJlYW0uZ2V0VHJhY2tzKCkuaW5jbHVkZXModHJhY2spKSB7XG4gICAgc3RyZWFtLmFkZFRyYWNrKHRyYWNrKVxuICB9XG5cbiAgaWYgKCFleGlzdGluZ1VzZXJTdHJlYW0pIHtcbiAgICByZXR1cm4gYWRkU3RyZWFtKHN0YXRlLCB7XG4gICAgICBzdHJlYW06IHBheWxvYWQuc3RyZWFtLFxuICAgICAgdXNlcklkOiBwYXlsb2FkLnVzZXJJZCxcbiAgICB9KVxuICB9XG5cbiAgcmV0dXJuIHN0YXRlXG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHN0cmVhbXMoXG4gIHN0YXRlOiBTdHJlYW1zU3RhdGUgPSBkZWZhdWx0U3RhdGUsXG4gIGFjdGlvbjogU3RyZWFtQWN0aW9uIHwgTWVkaWFTdHJlYW1BY3Rpb24gfCBIYW5nVXBBY3Rpb24sXG4pOiBTdHJlYW1zU3RhdGUge1xuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgY2FzZSBTVFJFQU1fQUREOlxuICAgICAgcmV0dXJuIGFkZFN0cmVhbShzdGF0ZSwgYWN0aW9uLnBheWxvYWQpXG4gICAgY2FzZSBTVFJFQU1fUkVNT1ZFOlxuICAgICAgcmV0dXJuIHJlbW92ZVN0cmVhbShzdGF0ZSwgYWN0aW9uLnBheWxvYWQpXG4gICAgY2FzZSBTVFJFQU1fVFJBQ0tfQUREOlxuICAgICAgcmV0dXJuIGFkZFN0cmVhbVRyYWNrKHN0YXRlLCBhY3Rpb24ucGF5bG9hZClcbiAgICBjYXNlIFNUUkVBTV9UUkFDS19SRU1PVkU6XG4gICAgICByZXR1cm4gcmVtb3ZlU3RyZWFtVHJhY2soc3RhdGUsIGFjdGlvbi5wYXlsb2FkKVxuICAgIGNhc2UgSEFOR19VUDpcbiAgICAgIGZvckVhY2goc3RhdGUsIHVzZXJTdHJlYW1zID0+IHtcbiAgICAgICAgdXNlclN0cmVhbXMuc3RyZWFtcy5mb3JFYWNoKHMgPT4ge1xuICAgICAgICAgIHMuc3RyZWFtLmdldFRyYWNrcygpLmZvckVhY2godHJhY2sgPT4ge1xuICAgICAgICAgICAgdHJhY2sub25tdXRlID0gbnVsbFxuICAgICAgICAgICAgdHJhY2sub251bm11dGUgPSBudWxsXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICByZXR1cm4gZGVmYXVsdFN0YXRlXG4gICAgY2FzZSBNRURJQV9TVFJFQU06XG4gICAgICBpZiAoYWN0aW9uLnN0YXR1cyA9PT0gJ3Jlc29sdmVkJykge1xuICAgICAgICByZXR1cm4gYWRkU3RyZWFtKHN0YXRlLCBhY3Rpb24ucGF5bG9hZClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBzdGF0ZVxuICAgICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gc3RhdGVcbiAgfVxufVxuIl19