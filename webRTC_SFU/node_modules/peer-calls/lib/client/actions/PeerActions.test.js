"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
jest.mock('../window');
jest.mock('simple-peer');
jest.useFakeTimers();
var PeerActions = __importStar(require("./PeerActions"));
var simple_peer_1 = __importDefault(require("simple-peer"));
var events_1 = require("events");
var store_1 = require("../store");
var constants_1 = require("../constants");
describe('PeerActions', function () {
    function createSocket() {
        var socket = new events_1.EventEmitter();
        socket.id = 'socket-id-user-1';
        return socket;
    }
    var socket;
    var stream;
    var user;
    var store;
    var instances;
    var dispatch;
    var getState;
    var PeerMock;
    beforeEach(function () {
        store = store_1.createStore();
        dispatch = store.dispatch;
        getState = store.getState;
        user = { id: 'user1' };
        socket = createSocket();
        instances = simple_peer_1["default"].instances = [];
        simple_peer_1["default"].mockClear();
        stream = { stream: true };
        PeerMock = simple_peer_1["default"];
    });
    describe('create', function () {
        it('creates a new peer', function () {
            PeerActions.createPeer({ socket: socket, user: user, initiator: 'other-user', stream: stream })(dispatch, getState);
            expect(instances.length).toBe(1);
            expect(PeerMock.mock.calls.length).toBe(1);
            expect(PeerMock.mock.calls[0][0].initiator).toBe(false);
            expect(PeerMock.mock.calls[0][0].stream).toBe(stream);
        });
        it('sets initiator correctly', function () {
            PeerActions
                .createPeer({
                socket: socket, user: user, initiator: user.id, stream: stream
            })(dispatch, getState);
            expect(instances.length).toBe(1);
            expect(PeerMock.mock.calls.length).toBe(1);
            expect(PeerMock.mock.calls[0][0].initiator).toBe(true);
            expect(PeerMock.mock.calls[0][0].stream).toBe(stream);
        });
        it('destroys old peer before creating new one', function () {
            PeerActions.createPeer({ socket: socket, user: user, initiator: 'user2', stream: stream })(dispatch, getState);
            PeerActions.createPeer({ socket: socket, user: user, initiator: 'user2', stream: stream })(dispatch, getState);
            expect(instances.length).toBe(2);
            expect(PeerMock.mock.calls.length).toBe(2);
            expect(instances[0].destroy.mock.calls.length).toBe(1);
            expect(instances[1].destroy.mock.calls.length).toBe(0);
        });
    });
    describe('events', function () {
        function createPeer() {
            PeerActions.createPeer({ socket: socket, user: user, initiator: 'user1', stream: stream })(dispatch, getState);
            var peer = instances[instances.length - 1];
            return peer;
        }
        describe('connect', function () {
            it('dispatches peer connection established message', function () {
                createPeer().emit('connect');
                // TODO
            });
            it('sends existing local streams to new peer', function () {
                PeerActions.sendMessage({
                    payload: { nickname: 'john' },
                    type: 'nickname'
                })(dispatch, getState);
                var peer = createPeer();
                peer.emit('connect');
            });
            it('sends current nickname to new peer', function () {
            });
        });
        describe('data', function () {
            beforeEach(function () {
                window.TextDecoder = /** @class */ (function () {
                    function TextDecoder(encoding) {
                        this.encoding = encoding;
                    }
                    TextDecoder.prototype.decode = function (object) {
                        return object.toString(this.encoding);
                    };
                    return TextDecoder;
                }());
            });
            it('decodes a message', function () {
                var peer = createPeer();
                var message = {
                    type: 'text',
                    payload: 'test'
                };
                var object = JSON.stringify(message);
                peer.emit('data', Buffer.from(object, 'utf-8'));
                var list = store.getState().messages.list;
                expect(list.length).toBeGreaterThan(0);
                expect(list[list.length - 1]).toEqual({
                    userId: user.id,
                    timestamp: jasmine.any(String),
                    image: undefined,
                    message: 'test'
                });
            });
        });
    });
    describe('get', function () {
        it('returns undefined when not found', function () {
            var peers = store.getState().peers;
            expect(peers[user.id]).not.toBeDefined();
        });
        it('returns Peer instance when found', function () {
            PeerActions.createPeer({ socket: socket, user: user, initiator: 'user2', stream: stream })(dispatch, getState);
            var peers = store.getState().peers;
            expect(peers[user.id]).toBe(instances[0]);
        });
    });
    describe('destroyPeers', function () {
        it('destroys all peers and removes them', function () {
            PeerActions.createPeer({
                socket: socket, user: { id: 'user2' }, initiator: 'user2', stream: stream
            })(dispatch, getState);
            PeerActions.createPeer({
                socket: socket, user: { id: 'user3' }, initiator: 'user3', stream: stream
            })(dispatch, getState);
            store.dispatch({
                type: constants_1.HANG_UP
            });
            jest.runAllTimers();
            expect(instances[0].destroy.mock.calls.length).toEqual(1);
            expect(instances[1].destroy.mock.calls.length).toEqual(1);
            var peers = store.getState().peers;
            expect(Object.keys(peers)).toEqual([]);
        });
    });
    describe('sendMessage', function () {
        beforeEach(function () {
            PeerActions.createPeer({
                socket: socket, user: { id: 'user2' }, initiator: 'user2', stream: stream
            })(dispatch, getState);
            PeerActions.createPeer({
                socket: socket, user: { id: 'user3' }, initiator: 'user3', stream: stream
            })(dispatch, getState);
        });
        it('sends a text message to all peers', function () {
            PeerActions.sendMessage({ payload: 'test', type: 'text' })(dispatch, getState);
            var peers = store.getState().peers;
            expect(peers['user2'].send.mock.calls)
                .toEqual([['{"payload":"test","type":"text"}']]);
            expect(peers['user3'].send.mock.calls)
                .toEqual([['{"payload":"test","type":"text"}']]);
        });
        it('sends a nickname change to all peers', function () {
            PeerActions.sendMessage({
                payload: { nickname: 'john' },
                type: 'nickname'
            })(dispatch, getState);
            var _a = store.getState(), nicknames = _a.nicknames, peers = _a.peers;
            expect(peers['user2'].send.mock.calls)
                .toEqual([['{"payload":{"nickname":"john"},"type":"nickname"}']]);
            expect(peers['user3'].send.mock.calls)
                .toEqual([['{"payload":{"nickname":"john"},"type":"nickname"}']]);
            expect(nicknames[constants_1.ME]).toBe('john');
        });
    });
    describe('receive message (handleData)', function () {
        var peer;
        function emitData(message) {
            peer.emit(constants_1.PEER_EVENT_DATA, JSON.stringify(message));
        }
        beforeEach(function () {
            PeerActions.createPeer({
                socket: socket, user: { id: 'user2' }, initiator: 'user2', stream: stream
            })(dispatch, getState);
            peer = store.getState().peers['user2'];
        });
        it('handles a message', function () {
            emitData({
                payload: 'hello',
                type: 'text'
            });
            expect(store.getState().messages.list)
                .toEqual([{
                    message: 'Connecting to peer...',
                    userId: constants_1.PEERCALLS,
                    system: true,
                    timestamp: jasmine.any(String)
                }, {
                    message: 'hello',
                    userId: 'user2',
                    image: undefined,
                    timestamp: jasmine.any(String)
                }]);
        });
        it('handles nickname changes', function () {
            emitData({
                payload: { nickname: 'john' },
                type: 'nickname'
            });
            emitData({
                payload: { nickname: 'john2' },
                type: 'nickname'
            });
            expect(store.getState().messages.list)
                .toEqual([{
                    message: 'Connecting to peer...',
                    userId: constants_1.PEERCALLS,
                    system: true,
                    timestamp: jasmine.any(String)
                }, {
                    message: 'User user2 is now known as john',
                    system: true,
                    userId: constants_1.PEERCALLS,
                    image: undefined,
                    timestamp: jasmine.any(String)
                }, {
                    message: 'User john is now known as john2',
                    system: true,
                    userId: constants_1.PEERCALLS,
                    image: undefined,
                    timestamp: jasmine.any(String)
                }]);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGVlckFjdGlvbnMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvYWN0aW9ucy9QZWVyQWN0aW9ucy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUN4QixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7QUFFcEIseURBQTRDO0FBQzVDLDREQUE4QjtBQUM5QixpQ0FBcUM7QUFDckMsa0NBQXVEO0FBR3ZELDBDQUFzRTtBQUV0RSxRQUFRLENBQUMsYUFBYSxFQUFFO0lBQ3RCLFNBQVMsWUFBWTtRQUNuQixJQUFNLE1BQU0sR0FBRyxJQUFJLHFCQUFZLEVBQTZCLENBQUE7UUFDNUQsTUFBTSxDQUFDLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQTtRQUM5QixPQUFPLE1BQU0sQ0FBQTtJQUNmLENBQUM7SUFFRCxJQUFJLE1BQW9CLENBQUE7SUFDeEIsSUFBSSxNQUFtQixDQUFBO0lBQ3ZCLElBQUksSUFBb0IsQ0FBQTtJQUN4QixJQUFJLEtBQVksQ0FBQTtJQUNoQixJQUFJLFNBQTBCLENBQUE7SUFDOUIsSUFBSSxRQUFrQixDQUFBO0lBQ3RCLElBQUksUUFBa0IsQ0FBQTtJQUN0QixJQUFJLFFBQWtDLENBQUE7SUFFdEMsVUFBVSxDQUFDO1FBQ1QsS0FBSyxHQUFHLG1CQUFXLEVBQUUsQ0FBQTtRQUNyQixRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQTtRQUN6QixRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQTtRQUV6QixJQUFJLEdBQUcsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLENBQUE7UUFDdEIsTUFBTSxHQUFHLFlBQVksRUFBRSxDQUFBO1FBQ3ZCLFNBQVMsR0FBSSx3QkFBWSxDQUFDLFNBQVMsR0FBRyxFQUFFLENB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bXBsZS1wZWVyJylcbmplc3QudXNlRmFrZVRpbWVycygpXG5cbmltcG9ydCAqIGFzIFBlZXJBY3Rpb25zIGZyb20gJy4vUGVlckFjdGlvbnMnXG5pbXBvcnQgUGVlciBmcm9tICdzaW1wbGUtcGVlcidcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cydcbmltcG9ydCB7IGNyZWF0ZVN0b3JlLCBTdG9yZSwgR2V0U3RhdGUgfSBmcm9tICcuLi9zdG9yZSdcbmltcG9ydCB7IERpc3BhdGNoIH0gZnJvbSAncmVkdXgnXG5pbXBvcnQgeyBDbGllbnRTb2NrZXQgfSBmcm9tICcuLi9zb2NrZXQnXG5pbXBvcnQgeyBQRUVSQ0FMTFMsIFBFRVJfRVZFTlRfREFUQSwgTUUsIEhBTkdfVVAgfSBmcm9tICcuLi9jb25zdGFudHMnXG5cbmRlc2NyaWJlKCdQZWVyQWN0aW9ucycsICgpID0+IHtcbiAgZnVuY3Rpb24gY3JlYXRlU29ja2V0ICgpIHtcbiAgICBjb25zdCBzb2NrZXQgPSBuZXcgRXZlbnRFbWl0dGVyKCkgYXMgdW5rbm93biBhcyBDbGllbnRTb2NrZXRcbiAgICBzb2NrZXQuaWQgPSAnc29ja2V0LWlkLXVzZXItMSdcbiAgICByZXR1cm4gc29ja2V0XG4gIH1cblxuICBsZXQgc29ja2V0OiBDbGllbnRTb2NrZXRcbiAgbGV0IHN0cmVhbTogTWVkaWFTdHJlYW1cbiAgbGV0IHVzZXI6IHsgaWQ6IHN0cmluZyB9XG4gIGxldCBzdG9yZTogU3RvcmVcbiAgbGV0IGluc3RhbmNlczogUGVlci5JbnN0YW5jZVtdXG4gIGxldCBkaXNwYXRjaDogRGlzcGF0Y2hcbiAgbGV0IGdldFN0YXRlOiBHZXRTdGF0ZVxuICBsZXQgUGVlck1vY2s6IGplc3QuTW9jazxQZWVyLkluc3RhbmNlPlxuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHN0b3JlID0gY3JlYXRlU3RvcmUoKVxuICAgIGRpc3BhdGNoID0gc3RvcmUuZGlzcGF0Y2hcbiAgICBnZXRTdGF0ZSA9IHN0b3JlLmdldFN0YXRlXG5cbiAgICB1c2VyID0geyBpZDogJ3VzZXIxJyB9XG4gICAgc29ja2V0ID0gY3JlYXRlU29ja2V0KClcbiAgICBpbnN0YW5jZXMgPSAoUGVlciBhcyBhbnkpLmluc3RhbmNlcyA9IFtdO1xuICAgIChQZWVyIGFzIHVua25vd24gYXMgamVzdC5Nb2NrKS5tb2NrQ2xlYXIoKVxuICAgIHN0cmVhbSA9IHsgc3RyZWFtOiB0cnVlIH0gYXMgdW5rbm93biBhcyBNZWRpYVN0cmVhbVxuICAgIFBlZXJNb2NrID0gUGVlciBhcyB1bmtub3duIGFzIGplc3QuTW9jazxQZWVyLkluc3RhbmNlPlxuICB9KVxuXG4gIGRlc2NyaWJlKCdjcmVhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ2NyZWF0ZXMgYSBuZXcgcGVlcicsICgpID0+IHtcbiAgICAgIFBlZXJBY3Rpb25zLmNyZWF0ZVBlZXIoeyBzb2NrZXQsIHVzZXIsIGluaXRpYXRvcjogJ290aGVyLXVzZXInLCBzdHJlYW0gfSkoXG4gICAgICAgIGRpc3BhdGNoLCBnZXRTdGF0ZSlcblxuICAgICAgZXhwZWN0KGluc3RhbmNlcy5sZW5ndGgpLnRvQmUoMSlcbiAgICAgIGV4cGVjdChQZWVyTW9jay5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgZXhwZWN0KFBlZXJNb2NrLm1vY2suY2FsbHNbMF1bMF0uaW5pdGlhdG9yKS50b0JlKGZhbHNlKVxuICAgICAgZXhwZWN0KFBlZXJNb2NrLm1vY2suY2FsbHNbMF1bMF0uc3RyZWFtKS50b0JlKHN0cmVhbSlcbiAgICB9KVxuXG4gICAgaXQoJ3NldHMgaW5pdGlhdG9yIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAgIFBlZXJBY3Rpb25zXG4gICAgICAuY3JlYXRlUGVlcih7XG4gICAgICAgIHNvY2tldCwgdXNlciwgaW5pdGlhdG9yOiB1c2VyLmlkLCBzdHJlYW0sXG4gICAgICB9KShkaXNwYXRjaCwgZ2V0U3RhdGUpXG5cbiAgICAgIGV4cGVjdChpbnN0YW5jZXMubGVuZ3RoKS50b0JlKDEpXG4gICAgICBleHBlY3QoUGVlck1vY2subW9jay5jYWxscy5sZW5ndGgpLnRvQmUoMSlcbiAgICAgIGV4cGVjdChQZWVyTW9jay5tb2NrLmNhbGxzWzBdWzBdLmluaXRpYXRvcikudG9CZSh0cnVlKVxuICAgICAgZXhwZWN0KFBlZXJNb2NrLm1vY2suY2FsbHNbMF1bMF0uc3RyZWFtKS50b0JlKHN0cmVhbSlcbiAgICB9KVxuXG4gICAgaXQoJ2Rlc3Ryb3lzIG9sZCBwZWVyIGJlZm9yZSBjcmVhdGluZyBuZXcgb25lJywgKCkgPT4ge1xuICAgICAgUGVlckFjdGlvbnMuY3JlYXRlUGVlcih7IHNvY2tldCwgdXNlciwgaW5pdGlhdG9yOiAndXNlcjInLCBzdHJlYW0gfSkoXG4gICAgICAgIGRpc3BhdGNoLCBnZXRTdGF0ZSlcbiAgICAgIFBlZXJBY3Rpb25zLmNyZWF0ZVBlZXIoeyBzb2NrZXQsIHVzZXIsIGluaXRpYXRvcjogJ3VzZXIyJywgc3RyZWFtIH0pKFxuICAgICAgICBkaXNwYXRjaCwgZ2V0U3RhdGUpXG5cbiAgICAgIGV4cGVjdChpbnN0YW5jZXMubGVuZ3RoKS50b0JlKDIpXG4gICAgICBleHBlY3QoUGVlck1vY2subW9jay5jYWxscy5sZW5ndGgpLnRvQmUoMilcbiAgICAgIGV4cGVjdCgoaW5zdGFuY2VzWzBdLmRlc3Ryb3kgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgZXhwZWN0KChpbnN0YW5jZXNbMV0uZGVzdHJveSBhcyBqZXN0Lk1vY2spLm1vY2suY2FsbHMubGVuZ3RoKS50b0JlKDApXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnZXZlbnRzJywgKCkgPT4ge1xuICAgIGZ1bmN0aW9uIGNyZWF0ZVBlZXIoKSB7XG4gICAgICBQZWVyQWN0aW9ucy5jcmVhdGVQZWVyKHsgc29ja2V0LCB1c2VyLCBpbml0aWF0b3I6ICd1c2VyMScsIHN0cmVhbSB9KShcbiAgICAgICAgZGlzcGF0Y2gsIGdldFN0YXRlKVxuICAgICAgY29uc3QgcGVlciA9IGluc3RhbmNlc1tpbnN0YW5jZXMubGVuZ3RoIC0gMV1cbiAgICAgIHJldHVybiBwZWVyXG4gICAgfVxuXG4gICAgZGVzY3JpYmUoJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICBpdCgnZGlzcGF0Y2hlcyBwZWVyIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQgbWVzc2FnZScsICgpID0+IHtcbiAgICAgICAgY3JlYXRlUGVlcigpLmVtaXQoJ2Nvbm5lY3QnKVxuICAgICAgICAvLyBUT0RPXG4gICAgICB9KVxuXG4gICAgICBpdCgnc2VuZHMgZXhpc3RpbmcgbG9jYWwgc3RyZWFtcyB0byBuZXcgcGVlcicsICgpID0+IHtcbiAgICAgICAgUGVlckFjdGlvbnMuc2VuZE1lc3NhZ2Uoe1xuICAgICAgICAgIHBheWxvYWQ6IHtuaWNrbmFtZTogJ2pvaG4nfSxcbiAgICAgICAgICB0eXBlOiAnbmlja25hbWUnLFxuICAgICAgICB9KShkaXNwYXRjaCwgZ2V0U3RhdGUpXG4gICAgICAgIGNvbnN0IHBlZXIgPSBjcmVhdGVQZWVyKClcbiAgICAgICAgcGVlci5lbWl0KCdjb25uZWN0JylcbiAgICAgIH0pXG5cbiAgICAgIGl0KCdzZW5kcyBjdXJyZW50IG5pY2tuYW1lIHRvIG5ldyBwZWVyJywgKCkgPT4ge1xuICAgICAgfSlcbiAgICB9KVxuXG4gICAgZGVzY3JpYmUoJ2RhdGEnLCAoKSA9PiB7XG5cbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICAod2luZG93IGFzIGFueSkuVGV4dERlY29kZXIgPSBjbGFzcyBUZXh0RGVjb2RlciB7XG4gICAgICAgICAgY29uc3RydWN0b3IgKHJlYWRvbmx5IGVuY29kaW5nOiBzdHJpbmcpIHtcbiAgICAgICAgICB9XG4gICAgICAgICAgZGVjb2RlIChvYmplY3Q6IGFueSkge1xuICAgICAgICAgICAgcmV0dXJuIG9iamVjdC50b1N0cmluZyh0aGlzLmVuY29kaW5nKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgaXQoJ2RlY29kZXMgYSBtZXNzYWdlJywgKCkgPT4ge1xuICAgICAgICBjb25zdCBwZWVyID0gY3JlYXRlUGVlcigpXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB7XG4gICAgICAgICAgdHlwZTogJ3RleHQnLFxuICAgICAgICAgIHBheWxvYWQ6ICd0ZXN0JyxcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBvYmplY3QgPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKVxuICAgICAgICBwZWVyLmVtaXQoJ2RhdGEnLCBCdWZmZXIuZnJvbShvYmplY3QsICd1dGYtOCcpKVxuICAgICAgICBjb25zdCB7IGxpc3QgfSA9IHN0b3JlLmdldFN0YXRlKCkubWVzc2FnZXNcbiAgICAgICAgZXhwZWN0KGxpc3QubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMClcbiAgICAgICAgZXhwZWN0KGxpc3RbbGlzdC5sZW5ndGggLSAxXSkudG9FcXVhbCh7XG4gICAgICAgICAgdXNlcklkOiB1c2VyLmlkLFxuICAgICAgICAgIHRpbWVzdGFtcDogamFzbWluZS5hbnkoU3RyaW5nKSxcbiAgICAgICAgICBpbWFnZTogdW5kZWZpbmVkLFxuICAgICAgICAgIG1lc3NhZ2U6ICd0ZXN0JyxcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnZ2V0JywgKCkgPT4ge1xuICAgIGl0KCdyZXR1cm5zIHVuZGVmaW5lZCB3aGVuIG5vdCBmb3VuZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcGVlcnMgfSA9IHN0b3JlLmdldFN0YXRlKClcbiAgICAgIGV4cGVjdChwZWVyc1t1c2VyLmlkXSkubm90LnRvQmVEZWZpbmVkKClcbiAgICB9KVxuXG4gICAgaXQoJ3JldHVybnMgUGVlciBpbnN0YW5jZSB3aGVuIGZvdW5kJywgKCkgPT4ge1xuICAgICAgUGVlckFjdGlvbnMuY3JlYXRlUGVlcih7IHNvY2tldCwgdXNlciwgaW5pdGlhdG9yOiAndXNlcjInLCBzdHJlYW0gfSkoXG4gICAgICAgIGRpc3BhdGNoLCBnZXRTdGF0ZSlcblxuICAgICAgY29uc3QgeyBwZWVycyB9ID0gc3RvcmUuZ2V0U3RhdGUoKVxuICAgICAgZXhwZWN0KHBlZXJzW3VzZXIuaWRdKS50b0JlKGluc3RhbmNlc1swXSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdkZXN0cm95UGVlcnMnLCAoKSA9PiB7XG4gICAgaXQoJ2Rlc3Ryb3lzIGFsbCBwZWVycyBhbmQgcmVtb3ZlcyB0aGVtJywgKCkgPT4ge1xuICAgICAgUGVlckFjdGlvbnMuY3JlYXRlUGVlcih7XG4gICAgICAgIHNvY2tldCwgdXNlcjogeyBpZDogJ3VzZXIyJyB9LCBpbml0aWF0b3I6ICd1c2VyMicsIHN0cmVhbSxcbiAgICAgIH0pKGRpc3BhdGNoLCBnZXRTdGF0ZSlcbiAgICAgIFBlZXJBY3Rpb25zLmNyZWF0ZVBlZXIoe1xuICAgICAgICBzb2NrZXQsIHVzZXI6IHsgaWQ6ICd1c2VyMycgfSwgaW5pdGlhdG9yOiAndXNlcjMnLCBzdHJlYW0sXG4gICAgICB9KShkaXNwYXRjaCwgZ2V0U3RhdGUpXG5cbiAgICAgIHN0b3JlLmRpc3BhdGNoKHtcbiAgICAgICAgdHlwZTogSEFOR19VUCxcbiAgICAgIH0pXG5cbiAgICAgIGplc3QucnVuQWxsVGltZXJzKClcblxuICAgICAgZXhwZWN0KChpbnN0YW5jZXNbMF0uZGVzdHJveSBhcyBqZXN0Lk1vY2spLm1vY2suY2FsbHMubGVuZ3RoKS50b0VxdWFsKDEpXG4gICAgICBleHBlY3QoKGluc3RhbmNlc1sxXS5kZXN0cm95IGFzIGplc3QuTW9jaykubW9jay5jYWxscy5sZW5ndGgpLnRvRXF1YWwoMSlcblxuICAgICAgY29uc3QgeyBwZWVycyB9ID0gc3RvcmUuZ2V0U3RhdGUoKVxuICAgICAgZXhwZWN0KE9iamVjdC5rZXlzKHBlZXJzKSkudG9FcXVhbChbXSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdzZW5kTWVzc2FnZScsICgpID0+IHtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgUGVlckFjdGlvbnMuY3JlYXRlUGVlcih7XG4gICAgICAgIHNvY2tldCwgdXNlcjogeyBpZDogJ3VzZXIyJyB9LCBpbml0aWF0b3I6ICd1c2VyMicsIHN0cmVhbSxcbiAgICAgIH0pKGRpc3BhdGNoLCBnZXRTdGF0ZSlcbiAgICAgIFBlZXJBY3Rpb25zLmNyZWF0ZVBlZXIoe1xuICAgICAgICBzb2NrZXQsIHVzZXI6IHsgaWQ6ICd1c2VyMycgfSwgaW5pdGlhdG9yOiAndXNlcjMnLCBzdHJlYW0sXG4gICAgICB9KShkaXNwYXRjaCwgZ2V0U3RhdGUpXG4gICAgfSlcblxuICAgIGl0KCdzZW5kcyBhIHRleHQgbWVzc2FnZSB0byBhbGwgcGVlcnMnLCAoKSA9PiB7XG4gICAgICBQZWVyQWN0aW9ucy5zZW5kTWVzc2FnZSh7IHBheWxvYWQ6ICd0ZXN0JywgdHlwZTogJ3RleHQnIH0pKFxuICAgICAgICBkaXNwYXRjaCwgZ2V0U3RhdGUpXG4gICAgICBjb25zdCB7IHBlZXJzIH0gPSBzdG9yZS5nZXRTdGF0ZSgpXG4gICAgICBleHBlY3QoKHBlZXJzWyd1c2VyMiddLnNlbmQgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzKVxuICAgICAgLnRvRXF1YWwoW1sgJ3tcInBheWxvYWRcIjpcInRlc3RcIixcInR5cGVcIjpcInRleHRcIn0nIF1dKVxuICAgICAgZXhwZWN0KChwZWVyc1sndXNlcjMnXS5zZW5kIGFzIGplc3QuTW9jaykubW9jay5jYWxscylcbiAgICAgIC50b0VxdWFsKFtbICd7XCJwYXlsb2FkXCI6XCJ0ZXN0XCIsXCJ0eXBlXCI6XCJ0ZXh0XCJ9JyBdXSlcbiAgICB9KVxuXG4gICAgaXQoJ3NlbmRzIGEgbmlja25hbWUgY2hhbmdlIHRvIGFsbCBwZWVycycsICgpID0+IHtcbiAgICAgIFBlZXJBY3Rpb25zLnNlbmRNZXNzYWdlKHtcbiAgICAgICAgcGF5bG9hZDoge25pY2tuYW1lOiAnam9obid9LFxuICAgICAgICB0eXBlOiAnbmlja25hbWUnLFxuICAgICAgfSkoZGlzcGF0Y2gsIGdldFN0YXRlKVxuICAgICAgY29uc3QgeyBuaWNrbmFtZXMsIHBlZXJzIH0gPSBzdG9yZS5nZXRTdGF0ZSgpXG4gICAgICBleHBlY3QoKHBlZXJzWyd1c2VyMiddLnNlbmQgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzKVxuICAgICAgLnRvRXF1YWwoW1sgJ3tcInBheWxvYWRcIjp7XCJuaWNrbmFtZVwiOlwiam9oblwifSxcInR5cGVcIjpcIm5pY2tuYW1lXCJ9JyBdXSlcbiAgICAgIGV4cGVjdCgocGVlcnNbJ3VzZXIzJ10uc2VuZCBhcyBqZXN0Lk1vY2spLm1vY2suY2FsbHMpXG4gICAgICAudG9FcXVhbChbWyAne1wicGF5bG9hZFwiOntcIm5pY2tuYW1lXCI6XCJqb2huXCJ9LFwidHlwZVwiOlwibmlja25hbWVcIn0nIF1dKVxuICAgICAgZXhwZWN0KG5pY2tuYW1lc1tNRV0pLnRvQmUoJ2pvaG4nKVxuICAgIH0pXG5cbiAgfSlcblxuICBkZXNjcmliZSgncmVjZWl2ZSBtZXNzYWdlIChoYW5kbGVEYXRhKScsICgpID0+IHtcbiAgICBsZXQgcGVlcjogUGVlci5JbnN0YW5jZVxuICAgIGZ1bmN0aW9uIGVtaXREYXRhKG1lc3NhZ2U6IFBlZXJBY3Rpb25zLk1lc3NhZ2UpIHtcbiAgICAgIHBlZXIuZW1pdChQRUVSX0VWRU5UX0RBVEEsIEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKVxuICAgIH1cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIFBlZXJBY3Rpb25zLmNyZWF0ZVBlZXIoe1xuICAgICAgICBzb2NrZXQsIHVzZXI6IHsgaWQ6ICd1c2VyMicgfSwgaW5pdGlhdG9yOiAndXNlcjInLCBzdHJlYW0sXG4gICAgICB9KShkaXNwYXRjaCwgZ2V0U3RhdGUpXG4gICAgICBwZWVyID0gc3RvcmUuZ2V0U3RhdGUoKS5wZWVyc1sndXNlcjInXVxuICAgIH0pXG5cbiAgICBpdCgnaGFuZGxlcyBhIG1lc3NhZ2UnLCAoKSA9PiB7XG4gICAgICBlbWl0RGF0YSh7XG4gICAgICAgIHBheWxvYWQ6ICdoZWxsbycsXG4gICAgICAgIHR5cGU6ICd0ZXh0JyxcbiAgICAgIH0pXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZXNzYWdlcy5saXN0KVxuICAgICAgLnRvRXF1YWwoW3tcbiAgICAgICAgbWVzc2FnZTogJ0Nvbm5lY3RpbmcgdG8gcGVlci4uLicsXG4gICAgICAgIHVzZXJJZDogUEVFUkNBTExTLFxuICAgICAgICBzeXN0ZW06IHRydWUsXG4gICAgICAgIHRpbWVzdGFtcDogamFzbWluZS5hbnkoU3RyaW5nKSxcbiAgICAgIH0sIHtcbiAgICAgICAgbWVzc2FnZTogJ2hlbGxvJyxcbiAgICAgICAgdXNlcklkOiAndXNlcjInLFxuICAgICAgICBpbWFnZTogdW5kZWZpbmVkLFxuICAgICAgICB0aW1lc3RhbXA6IGphc21pbmUuYW55KFN0cmluZyksXG4gICAgICB9XSlcbiAgICB9KVxuXG4gICAgaXQoJ2hhbmRsZXMgbmlja25hbWUgY2hhbmdlcycsICgpID0+IHtcbiAgICAgIGVtaXREYXRhKHtcbiAgICAgICAgcGF5bG9hZDoge25pY2tuYW1lOiAnam9obid9LFxuICAgICAgICB0eXBlOiAnbmlja25hbWUnLFxuICAgICAgfSlcbiAgICAgIGVtaXREYXRhKHtcbiAgICAgICAgcGF5bG9hZDoge25pY2tuYW1lOiAnam9objInfSxcbiAgICAgICAgdHlwZTogJ25pY2tuYW1lJyxcbiAgICAgIH0pXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZXNzYWdlcy5saXN0KVxuICAgICAgLnRvRXF1YWwoW3tcbiAgICAgICAgbWVzc2FnZTogJ0Nvbm5lY3RpbmcgdG8gcGVlci4uLicsXG4gICAgICAgIHVzZXJJZDogUEVFUkNBTExTLFxuICAgICAgICBzeXN0ZW06IHRydWUsXG4gICAgICAgIHRpbWVzdGFtcDogamFzbWluZS5hbnkoU3RyaW5nKSxcbiAgICAgIH0sIHtcbiAgICAgICAgbWVzc2FnZTogJ1VzZXIgdXNlcjIgaXMgbm93IGtub3duIGFzIGpvaG4nLFxuICAgICAgICBzeXN0ZW06IHRydWUsXG4gICAgICAgIHVzZXJJZDogUEVFUkNBTExTLFxuICAgICAgICBpbWFnZTogdW5kZWZpbmVkLFxuICAgICAgICB0aW1lc3RhbXA6IGphc21pbmUuYW55KFN0cmluZyksXG4gICAgICB9LCB7XG4gICAgICAgIG1lc3NhZ2U6ICdVc2VyIGpvaG4gaXMgbm93IGtub3duIGFzIGpvaG4yJyxcbiAgICAgICAgc3lzdGVtOiB0cnVlLFxuICAgICAgICB1c2VySWQ6IFBFRVJDQUxMUyxcbiAgICAgICAgaW1hZ2U6IHVuZGVmaW5lZCxcbiAgICAgICAgdGltZXN0YW1wOiBqYXNtaW5lLmFueShTdHJpbmcpLFxuICAgICAgfV0pXG4gICAgfSlcbiAgfSlcbn0pXG4iXX0=