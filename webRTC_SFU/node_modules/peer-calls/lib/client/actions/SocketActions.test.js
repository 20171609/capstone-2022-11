"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
jest.mock('simple-peer');
jest.mock('../window');
var SocketActions = __importStar(require("./SocketActions"));
var constants = __importStar(require("../constants"));
var simple_peer_1 = __importDefault(require("simple-peer"));
var events_1 = require("events");
var store_1 = require("../store");
var window_1 = require("../window");
describe('SocketActions', function () {
    var roomName = 'bla';
    var socket;
    var store;
    var dispatch;
    var getState;
    var instances;
    beforeEach(function () {
        socket = new events_1.EventEmitter();
        socket.id = 'a';
        store = store_1.createStore();
        getState = store.getState;
        dispatch = store.dispatch;
        instances = simple_peer_1["default"].instances = [];
    });
    var userA = {
        socketId: 'socket-a',
        userId: 'user-a'
    };
    var userId = userA.userId;
    var userB = {
        socketId: 'socket-b',
        userId: 'user-b'
    };
    var userC = {
        socketId: 'socket-c',
        userId: 'user-c'
    };
    describe('handshake', function () {
        describe('users', function () {
            beforeEach(function () {
                SocketActions.handshake({ socket: socket, roomName: roomName, userId: userId, store: store });
                var payload = {
                    users: [userA, userB],
                    initiator: userA.userId
                };
                socket.emit('users', payload);
                expect(instances.length).toBe(1);
            });
            it('adds a peer for each new user and keeps active connections', function () {
                var payload = {
                    users: [userA, userC],
                    initiator: userC.userId
                };
                socket.emit(constants.SOCKET_EVENT_USERS, payload);
                // then
                expect(instances.length).toBe(2);
                expect(instances[0].destroy.mock.calls.length).toBe(0);
                expect(instances[1].destroy.mock.calls.length).toBe(0);
            });
        });
        describe('signal', function () {
            var data;
            beforeEach(function () {
                data = {};
                SocketActions.handshake({ socket: socket, roomName: roomName, userId: userId, store: store });
                socket.emit('users', {
                    initiator: userA.userId,
                    users: [userA, userB]
                });
            });
            it('should forward signal to peer', function () {
                socket.emit('signal', {
                    userId: userB.userId,
                    signal: data
                });
                expect(instances.length).toBe(1);
                expect(instances[0].signal.mock.calls.length).toBe(1);
            });
            it('does nothing if no peer', function () {
                socket.emit('signal', {
                    userId: 'a',
                    signal: data
                });
                expect(instances.length).toBe(1);
                expect(instances[0].signal.mock.calls.length).toBe(0);
            });
        });
    });
    describe('peer events', function () {
        var peer;
        beforeEach(function () {
            var ready = false;
            socket.once('ready', function () { ready = true; });
            SocketActions.handshake({ socket: socket, roomName: roomName, userId: userId, store: store });
            socket.emit('users', {
                initiator: userA.userId,
                users: [userA, userB]
            });
            expect(instances.length).toBe(1);
            peer = instances[0];
            expect(ready).toBeDefined();
        });
        describe('error', function () {
            it('destroys peer', function () {
                peer.emit(constants.PEER_EVENT_ERROR, new Error('bla'));
                expect(peer.destroy.mock.calls.length).toBe(1);
            });
        });
        describe('signal', function () {
            it('emits socket signal with user id', function (done) {
                var signal = { bla: 'bla' };
                socket.once('signal', function (payload) {
                    expect(payload.userId).toEqual(userB.userId);
                    expect(payload.signal).toBe(signal);
                    done();
                });
                peer.emit('signal', signal);
            });
        });
        describe('stream', function () {
            it('adds a stream to streamStore', function () {
                var _a;
                var stream = {
                    getTracks: function () {
                        return [{
                                stop: jest.fn()
                            }];
                    }
                };
                peer.emit(constants.PEER_EVENT_TRACK, stream.getTracks()[0], stream);
                expect(store.getState().streams).toEqual((_a = {},
                    _a[userB.userId] = {
                        userId: userB.userId,
                        streams: [{
                                stream: stream,
                                type: undefined,
                                url: jasmine.any(String)
                            }]
                    },
                    _a));
            });
        });
        describe('close', function () {
            beforeEach(function () {
                var _a;
                var stream = new window_1.MediaStream();
                var track = {};
                peer.emit(constants.PEER_EVENT_TRACK, track, stream);
                // test stream with two tracks
                peer.emit(constants.PEER_EVENT_TRACK, track, stream);
                expect(store.getState().streams).toEqual((_a = {},
                    _a[userB.userId] = {
                        userId: userB.userId,
                        streams: [{
                                stream: stream,
                                type: undefined,
                                url: jasmine.any(String)
                            }]
                    },
                    _a));
            });
            it('removes stream & peer from store', function () {
                var _a;
                expect(store.getState().peers).toEqual((_a = {}, _a[userB.userId] = peer, _a));
                peer.emit('close');
                expect(store.getState().streams).toEqual({});
                expect(store.getState().peers).toEqual({});
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU29ja2V0QWN0aW9ucy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NsaWVudC9hY3Rpb25zL1NvY2tldEFjdGlvbnMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7QUFFdEIsNkRBQWdEO0FBQ2hELHNEQUF5QztBQUN6Qyw0REFBOEI7QUFDOUIsaUNBQXFDO0FBQ3JDLGtDQUF1RDtBQUd2RCxvQ0FBdUM7QUFHdkMsUUFBUSxDQUFDLGVBQWUsRUFBRTtJQUN4QixJQUFNLFFBQVEsR0FBRyxLQUFLLENBQUE7SUFFdEIsSUFBSSxNQUFvQixDQUFBO0lBQ3hCLElBQUksS0FBWSxDQUFBO0lBQ2hCLElBQUksUUFBa0IsQ0FBQTtJQUN0QixJQUFJLFFBQWtCLENBQUE7SUFDdEIsSUFBSSxTQUEwQixDQUFBO0lBQzlCLFVBQVUsQ0FBQztRQUNULE1BQU0sR0FBRyxJQUFJLHFCQUFZLEVBQVMsQ0FBQztRQUNsQyxNQUFjLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQTtRQUV4QixLQUFLLEdBQUcsbUJBQVcsRUFBRSxDQUFBO1FBQ3JCLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFBO1FBQ3pCLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFBO1FBRXpCLFNBQVMsR0FBSSx3QkFBWSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUE7SUFDMUMsQ0FBQyxDQUFDLENBQUE7SUFFRixJQUFNLEtBQUssR0FBRztRQUNaLFFBQVEsRUFBRSxVQUFVO1FBQ3BCLE1BQU0sRUFBRSxRQUFRO0tBQ2pCLENBQUE7SUFDRCxJQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFBO0lBRTNCLElBQU0sS0FBSyxHQUFHO1FBQ1osUUFBUSxFQUFFLFVBQVU7UUFD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O1lBQ0osQ0FBQyxDQUFDLENBQUE7WUFFRixFQUFFLENBQUMsa0NBQWtDLEVBQUU7O2dCQUNyQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sV0FBRyxHQUFDLEtBQUssQ0FBQyxNQUFNLElBQUcsSUFBSSxNQUFHLENBQUE7Z0JBQ2hFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7Z0JBQ2xCLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dCQUM1QyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUM1QyxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImplc3QubW9jaygnc2ltcGxlLXBlZXInKVxuamVzdC5tb2NrKCcuLi93aW5kb3cnKVxuXG5pbXBvcnQgKiBhcyBTb2NrZXRBY3Rpb25zIGZyb20gJy4vU29ja2V0QWN0aW9ucydcbmltcG9ydCAqIGFzIGNvbnN0YW50cyBmcm9tICcuLi9jb25zdGFudHMnXG5pbXBvcnQgUGVlciBmcm9tICdzaW1wbGUtcGVlcidcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cydcbmltcG9ydCB7IGNyZWF0ZVN0b3JlLCBTdG9yZSwgR2V0U3RhdGUgfSBmcm9tICcuLi9zdG9yZSdcbmltcG9ydCB7IENsaWVudFNvY2tldCB9IGZyb20gJy4uL3NvY2tldCdcbmltcG9ydCB7IERpc3BhdGNoIH0gZnJvbSAncmVkdXgnXG5pbXBvcnQgeyBNZWRpYVN0cmVhbSB9IGZyb20gJy4uL3dpbmRvdydcbmltcG9ydCB7IFNvY2tldEV2ZW50IH0gZnJvbSAnLi4vLi4vc2hhcmVkJ1xuXG5kZXNjcmliZSgnU29ja2V0QWN0aW9ucycsICgpID0+IHtcbiAgY29uc3Qgcm9vbU5hbWUgPSAnYmxhJ1xuXG4gIGxldCBzb2NrZXQ6IENsaWVudFNvY2tldFxuICBsZXQgc3RvcmU6IFN0b3JlXG4gIGxldCBkaXNwYXRjaDogRGlzcGF0Y2hcbiAgbGV0IGdldFN0YXRlOiBHZXRTdGF0ZVxuICBsZXQgaW5zdGFuY2VzOiBQZWVyLkluc3RhbmNlW11cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgc29ja2V0ID0gbmV3IEV2ZW50RW1pdHRlcigpIGFzIGFueTtcbiAgICAoc29ja2V0IGFzIGFueSkuaWQgPSAnYSdcblxuICAgIHN0b3JlID0gY3JlYXRlU3RvcmUoKVxuICAgIGdldFN0YXRlID0gc3RvcmUuZ2V0U3RhdGVcbiAgICBkaXNwYXRjaCA9IHN0b3JlLmRpc3BhdGNoXG5cbiAgICBpbnN0YW5jZXMgPSAoUGVlciBhcyBhbnkpLmluc3RhbmNlcyA9IFtdXG4gIH0pXG5cbiAgY29uc3QgdXNlckEgPSB7XG4gICAgc29ja2V0SWQ6ICdzb2NrZXQtYScsXG4gICAgdXNlcklkOiAndXNlci1hJyxcbiAgfVxuICBjb25zdCB1c2VySWQgPSB1c2VyQS51c2VySWRcblxuICBjb25zdCB1c2VyQiA9IHtcbiAgICBzb2NrZXRJZDogJ3NvY2tldC1iJyxcbiAgICB1c2VySWQ6ICd1c2VyLWInLFxuICB9XG5cbiAgY29uc3QgdXNlckMgPSB7XG4gICAgc29ja2V0SWQ6ICdzb2NrZXQtYycsXG4gICAgdXNlcklkOiAndXNlci1jJyxcbiAgfVxuXG4gIGRlc2NyaWJlKCdoYW5kc2hha2UnLCAoKSA9PiB7XG4gICAgZGVzY3JpYmUoJ3VzZXJzJywgKCkgPT4ge1xuICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIFNvY2tldEFjdGlvbnMuaGFuZHNoYWtlKHsgc29ja2V0LCByb29tTmFtZSwgdXNlcklkLCBzdG9yZSB9KVxuICAgICAgICBjb25zdCBwYXlsb2FkID0ge1xuICAgICAgICAgIHVzZXJzOiBbdXNlckEsIHVzZXJCXSxcbiAgICAgICAgICBpbml0aWF0b3I6IHVzZXJBLnVzZXJJZCxcbiAgICAgICAgfVxuICAgICAgICBzb2NrZXQuZW1pdCgndXNlcnMnLCBwYXlsb2FkKVxuICAgICAgICBleHBlY3QoaW5zdGFuY2VzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgfSlcblxuICAgICAgaXQoJ2FkZHMgYSBwZWVyIGZvciBlYWNoIG5ldyB1c2VyIGFuZCBrZWVwcyBhY3RpdmUgY29ubmVjdGlvbnMnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgICAgICAgdXNlcnM6IFt1c2VyQSwgdXNlckNdLFxuICAgICAgICAgIGluaXRpYXRvcjogIHVzZXJDLnVzZXJJZCxcbiAgICAgICAgfVxuICAgICAgICBzb2NrZXQuZW1pdChjb25zdGFudHMuU09DS0VUX0VWRU5UX1VTRVJTLCBwYXlsb2FkKVxuXG4gICAgICAgIC8vIHRoZW5cbiAgICAgICAgZXhwZWN0KGluc3RhbmNlcy5sZW5ndGgpLnRvQmUoMilcbiAgICAgICAgZXhwZWN0KChpbnN0YW5jZXNbMF0uZGVzdHJveSBhcyBqZXN0Lk1vY2spLm1vY2suY2FsbHMubGVuZ3RoKS50b0JlKDApXG4gICAgICAgIGV4cGVjdCgoaW5zdGFuY2VzWzFdLmRlc3Ryb3kgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgwKVxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgZGVzY3JpYmUoJ3NpZ25hbCcsICgpID0+IHtcbiAgICAgIGxldCBkYXRhOiBQZWVyLlNpZ25hbERhdGFcbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBkYXRhID0ge30gYXMgYW55XG4gICAgICAgIFNvY2tldEFjdGlvbnMuaGFuZHNoYWtlKHsgc29ja2V0LCByb29tTmFtZSwgdXNlcklkLCBzdG9yZSB9KVxuICAgICAgICBzb2NrZXQuZW1pdCgndXNlcnMnLCB7XG4gICAgICAgICAgaW5pdGlhdG9yOiB1c2VyQS51c2VySWQsXG4gICAgICAgICAgdXNlcnM6IFt1c2VyQSwgdXNlckJdLFxuICAgICAgICB9KVxuICAgICAgfSlcblxuICAgICAgaXQoJ3Nob3VsZCBmb3J3YXJkIHNpZ25hbCB0byBwZWVyJywgKCkgPT4ge1xuICAgICAgICBzb2NrZXQuZW1pdCgnc2lnbmFsJywge1xuICAgICAgICAgIHVzZXJJZDogdXNlckIudXNlcklkLFxuICAgICAgICAgIHNpZ25hbDogZGF0YSxcbiAgICAgICAgfSlcblxuICAgICAgICBleHBlY3QoaW5zdGFuY2VzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgICBleHBlY3QoKGluc3RhbmNlc1swXS5zaWduYWwgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgfSlcblxuICAgICAgaXQoJ2RvZXMgbm90aGluZyBpZiBubyBwZWVyJywgKCkgPT4ge1xuICAgICAgICBzb2NrZXQuZW1pdCgnc2lnbmFsJywge1xuICAgICAgICAgIHVzZXJJZDogJ2EnLFxuICAgICAgICAgIHNpZ25hbDogZGF0YSxcbiAgICAgICAgfSlcblxuICAgICAgICBleHBlY3QoaW5zdGFuY2VzLmxlbmd0aCkudG9CZSgxKVxuICAgICAgICBleHBlY3QoKGluc3RhbmNlc1swXS5zaWduYWwgYXMgamVzdC5Nb2NrKS5tb2NrLmNhbGxzLmxlbmd0aCkudG9CZSgwKVxuICAgICAgfSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdwZWVyIGV2ZW50cycsICgpID0+IHtcbiAgICBsZXQgcGVlcjogUGVlci5JbnN0YW5jZVxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgbGV0IHJlYWR5ID0gZmFsc2VcbiAgICAgIHNvY2tldC5vbmNlKCdyZWFkeScsICgpID0+IHsgcmVhZHkgPSB0cnVlIH0pXG5cbiAgICAgIFNvY2tldEFjdGlvbnMuaGFuZHNoYWtlKHsgc29ja2V0LCByb29tTmFtZSwgdXNlcklkLCBzdG9yZSB9KVxuXG4gICAgICBzb2NrZXQuZW1pdCgndXNlcnMnLCB7XG4gICAgICAgIGluaXRpYXRvcjogdXNlckEudXNlcklkLFxuICAgICAgICB1c2VyczogW3VzZXJBLCB1c2VyQl0sXG4gICAgICB9KVxuICAgICAgZXhwZWN0KGluc3RhbmNlcy5sZW5ndGgpLnRvQmUoMSlcbiAgICAgIHBlZXIgPSBpbnN0YW5jZXNbMF1cblxuICAgICAgZXhwZWN0KHJlYWR5KS50b0JlRGVmaW5lZCgpXG4gICAgfSlcblxuICAgIGRlc2NyaWJlKCdlcnJvcicsICgpID0+IHtcbiAgICAgIGl0KCdkZXN0cm95cyBwZWVyJywgKCkgPT4ge1xuICAgICAgICBwZWVyLmVtaXQoY29uc3RhbnRzLlBFRVJfRVZFTlRfRVJST1IsIG5ldyBFcnJvcignYmxhJykpXG4gICAgICAgIGV4cGVjdCgocGVlci5kZXN0cm95IGFzIGplc3QuTW9jaykubW9jay5jYWxscy5sZW5ndGgpLnRvQmUoMSlcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGRlc2NyaWJlKCdzaWduYWwnLCAoKSA9PiB7XG4gICAgICBpdCgnZW1pdHMgc29ja2V0IHNpZ25hbCB3aXRoIHVzZXIgaWQnLCBkb25lID0+IHtcbiAgICAgICAgY29uc3Qgc2lnbmFsID0geyBibGE6ICdibGEnIH1cblxuICAgICAgICBzb2NrZXQub25jZSgnc2lnbmFsJywgKHBheWxvYWQ6IFNvY2tldEV2ZW50WydzaWduYWwnXSkgPT4ge1xuICAgICAgICAgIGV4cGVjdChwYXlsb2FkLnVzZXJJZCkudG9FcXVhbCh1c2VyQi51c2VySWQpXG4gICAgICAgICAgZXhwZWN0KHBheWxvYWQuc2lnbmFsKS50b0JlKHNpZ25hbClcbiAgICAgICAgICBkb25lKClcbiAgICAgICAgfSlcblxuICAgICAgICBwZWVyLmVtaXQoJ3NpZ25hbCcsIHNpZ25hbClcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGRlc2NyaWJlKCdzdHJlYW0nLCAoKSA9PiB7XG4gICAgICBpdCgnYWRkcyBhIHN0cmVhbSB0byBzdHJlYW1TdG9yZScsICgpID0+IHtcbiAgICAgICAgY29uc3Qgc3RyZWFtID0ge1xuICAgICAgICAgIGdldFRyYWNrcygpIHtcbiAgICAgICAgICAgIHJldHVybiBbe1xuICAgICAgICAgICAgICBzdG9wOiBqZXN0LmZuKCksXG4gICAgICAgICAgICB9XVxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICAgcGVlci5lbWl0KGNvbnN0YW50cy5QRUVSX0VWRU5UX1RSQUNLLCBzdHJlYW0uZ2V0VHJhY2tzKClbMF0sIHN0cmVhbSlcblxuICAgICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zKS50b0VxdWFsKHtcbiAgICAgICAgICBbdXNlckIudXNlcklkXToge1xuICAgICAgICAgICAgdXNlcklkOiB1c2VyQi51c2VySWQsXG4gICAgICAgICAgICBzdHJlYW1zOiBbe1xuICAgICAgICAgICAgICBzdHJlYW0sXG4gICAgICAgICAgICAgIHR5cGU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgdXJsOiBqYXNtaW5lLmFueShTdHJpbmcpLFxuICAgICAgICAgICAgfV0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGRlc2NyaWJlKCdjbG9zZScsICgpID0+IHtcbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBjb25zdCBzdHJlYW0gPSBuZXcgTWVkaWFTdHJlYW0oKVxuICAgICAgICBjb25zdCB0cmFjayA9IHt9IGFzIHVua25vd24gYXMgTWVkaWFTdHJlYW1UcmFja1xuICAgICAgICBwZWVyLmVtaXQoY29uc3RhbnRzLlBFRVJfRVZFTlRfVFJBQ0ssIHRyYWNrLCBzdHJlYW0pXG4gICAgICAgIC8vIHRlc3Qgc3RyZWFtIHdpdGggdHdvIHRyYWNrc1xuICAgICAgICBwZWVyLmVtaXQoY29uc3RhbnRzLlBFRVJfRVZFTlRfVFJBQ0ssIHRyYWNrLCBzdHJlYW0pXG4gICAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLnN0cmVhbXMpLnRvRXF1YWwoe1xuICAgICAgICAgIFt1c2VyQi51c2VySWRdOiB7XG4gICAgICAgICAgICB1c2VySWQ6IHVzZXJCLnVzZXJJZCxcbiAgICAgICAgICAgIHN0cmVhbXM6IFt7XG4gICAgICAgICAgICAgIHN0cmVhbSxcbiAgICAgICAgICAgICAgdHlwZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICB1cmw6IGphc21pbmUuYW55KFN0cmluZyksXG4gICAgICAgICAgICB9XSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgICAgfSlcblxuICAgICAgaXQoJ3JlbW92ZXMgc3RyZWFtICYgcGVlciBmcm9tIHN0b3JlJywgKCkgPT4ge1xuICAgICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5wZWVycykudG9FcXVhbCh7IFt1c2VyQi51c2VySWRdOiBwZWVyIH0pXG4gICAgICAgIHBlZXIuZW1pdCgnY2xvc2UnKVxuICAgICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5zdHJlYW1zKS50b0VxdWFsKHt9KVxuICAgICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5wZWVycykudG9FcXVhbCh7fSlcbiAgICAgIH0pXG4gICAgfSlcbiAgfSlcbn0pXG4iXX0=