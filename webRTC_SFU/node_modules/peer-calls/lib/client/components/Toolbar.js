"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
var classnames_1 = __importDefault(require("classnames"));
var react_1 = __importDefault(require("react"));
var screenfull_1 = __importDefault(require("screenfull"));
var constants_1 = require("../constants");
var hidden = {
    display: 'none'
};
function ToolbarButton(props) {
    var blink = props.blink, on = props.on;
    var icon = !on && props.offIcon ? props.offIcon : props.icon;
    return (react_1["default"].createElement("a", { className: classnames_1["default"]('button', props.className, { blink: blink, on: on }), onClick: props.onClick, href: '#' },
        react_1["default"].createElement("span", { className: classnames_1["default"]('icon', icon) }, !!props.badge && react_1["default"].createElement("span", { className: 'badge' }, props.badge)),
        react_1["default"].createElement("span", { className: "tooltip" }, props.title)));
}
var Toolbar = /** @class */ (function (_super) {
    __extends(Toolbar, _super);
    function Toolbar(props) {
        var _this = _super.call(this, props) || this;
        _this.file = react_1["default"].createRef();
        _this.handleMicClick = function () {
            var stream = _this.props.stream;
            stream.stream.getAudioTracks().forEach(function (track) {
                track.enabled = !track.enabled;
            });
            _this.setState(__assign(__assign({}, _this.state), { micMuted: !_this.state.micMuted }));
        };
        _this.handleCamClick = function () {
            var stream = _this.props.stream;
            stream.stream.getVideoTracks().forEach(function (track) {
                track.enabled = !track.enabled;
            });
            _this.setState(__assign(__assign({}, _this.state), { camDisabled: !_this.state.camDisabled }));
        };
        _this.handleFullscreenClick = function () {
            if (screenfull_1["default"].isEnabled) {
                screenfull_1["default"].toggle();
                _this.setState(__assign(__assign({}, _this.state), { fullScreenEnabled: !screenfull_1["default"].isFullscreen }));
            }
        };
        _this.handleHangoutClick = function () {
            window.location.href = '/';
        };
        _this.handleSendFile = function () {
            _this.file.current.click();
        };
        _this.handleSelectFiles = function (event) {
            Array
                .from(event.target.files)
                .forEach(function (file) { return _this.props.onSendFile(file); });
        };
        _this.handleToggleChat = function () {
            _this.setState({
                readMessages: _this.props.messagesCount
            });
            _this.props.onToggleChat();
        };
        _this.handleToggleShareDesktop = function () {
            if (_this.props.desktopStream) {
                _this.props.onRemoveStream(constants_1.ME, _this.props.desktopStream.stream);
            }
            else {
                _this.props.onGetDesktopStream()["catch"](function () { });
            }
        };
        _this.state = {
            readMessages: props.messagesCount,
            camDisabled: false,
            micMuted: false,
            fullScreenEnabled: false
        };
        return _this;
    }
    Toolbar.prototype.render = function () {
        var _a = this.props, messagesCount = _a.messagesCount, stream = _a.stream;
        var unreadCount = messagesCount - this.state.readMessages;
        var hasUnread = unreadCount > 0;
        return (react_1["default"].createElement("div", { className: "toolbar active" },
            react_1["default"].createElement("input", { style: hidden, type: "file", multiple: true, ref: this.file, onChange: this.handleSelectFiles }),
            react_1["default"].createElement(ToolbarButton, { badge: unreadCount, className: 'chat', icon: 'icon-question_answer', blink: !this.props.chatVisible && hasUnread, onClick: this.handleToggleChat, on: this.props.chatVisible, title: 'Toggle Chat' }),
            react_1["default"].createElement(ToolbarButton, { className: 'send-file', icon: 'icon-file-text2', onClick: this.handleSendFile, title: 'Send File' }),
            react_1["default"].createElement(ToolbarButton, { className: 'stream-desktop', icon: 'icon-display', onClick: this.handleToggleShareDesktop, on: !!this.props.desktopStream, title: 'Share Desktop' }),
            stream && (react_1["default"].createElement(react_1["default"].Fragment, null,
                react_1["default"].createElement(ToolbarButton, { onClick: this.handleMicClick, className: 'mute-audio', on: this.state.micMuted, icon: 'icon-mic_off', offIcon: 'icon-mic', title: 'Toggle Microphone' }),
                react_1["default"].createElement(ToolbarButton, { onClick: this.handleCamClick, className: 'mute-video', on: this.state.camDisabled, icon: 'icon-videocam_off', offIcon: 'icon-videocam', title: 'Toggle Camera' }))),
            react_1["default"].createElement(ToolbarButton, { onClick: this.handleFullscreenClick, className: 'fullscreen', icon: 'icon-fullscreen_exit', offIcon: 'icon-fullscreen', on: this.state.fullScreenEnabled, title: 'Toggle Fullscreen' }),
            this.props.dialState === constants_1.DIAL_STATE_IN_CALL && (react_1["default"].createElement(ToolbarButton, { onClick: this.props.onHangup, className: 'hangup', icon: 'icon-call_end', title: "Hang Up" }))));
    };
    return Toolbar;
}(react_1["default"].PureComponent));
exports["default"] = Toolbar;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVG9vbGJhci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvY29tcG9uZW50cy9Ub29sYmFyLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDBEQUFtQztBQUNuQyxnREFBeUI7QUFDekIsMERBQW1DO0FBSW5DLDBDQUFnRTtBQUVoRSxJQUFNLE1BQU0sR0FBRztJQUNiLE9BQU8sRUFBRSxNQUFNO0NBQ2hCLENBQUE7QUFrQ0QsU0FBUyxhQUFhLENBQUMsS0FBeUI7SUFDdEMsSUFBQSxtQkFBSyxFQUFFLGFBQUUsQ0FBVTtJQUMzQixJQUFNLElBQUksR0FBRyxDQUFDLEVBQUUsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFBO0lBRTlELE9BQU8sQ0FDTCx3Q0FDRSxTQUFTLEVBQUUsdUJBQVUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLFNBQVMsRUFBRSxFQUFFLEtBQUssT0FBQSxFQUFFLEVBQUUsSUFBQSxFQUFFLENBQUMsRUFDL0QsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQ3RCLElBQUksRUFBQyxHQUFHO1FBRVIsMkNBQU0sU0FBUyxFQUFFLHVCQUFVLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUN0QyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSwyQ0FBTSxTQUFTLEVBQUMsT0FBTyxJQUFFLEtBQUssQ0FBQyxLQUFLLENBQVEsQ0FDekQ7UUFDUCwyQ0FBTSxTQUFTLEVBQUMsU0FBUyxJQUFFLEtBQUssQ0FBQyxLQUFLLENBQVEsQ0FDNUMsQ0FDTCxDQUFBO0FBQ0gsQ0FBQztBQUVEO0lBQ1EsMkJBQStDO0lBR3JELGlCQUFZLEtBQW1CO1FBQS9CLFlBQ0Usa0JBQU0sS0FBSyxDQUFDLFNBT2I7UUFWRCxVQUFJLEdBQUcs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LENBQUMsUUFBUSxFQUN2QixJQUFJLEVBQUMsY0FBYyxFQUNuQixPQUFPLEVBQUMsVUFBVSxFQUNsQixLQUFLLEVBQUMsbUJBQW1CLEdBQ3pCO2dCQUNGLGlDQUFDLGFBQWEsSUFDWixPQUFPLEVBQUUsSUFBSSxDQUFDLGNBQWMsRUFDNUIsU0FBUyxFQUFDLFlBQVksRUFDdEIsRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUMxQixJQUFJLEVBQUMsbUJBQW1CLEVBQ3hCLE9BQU8sRUFBQyxlQUFlLEVBQ3ZCLEtBQUssRUFBQyxlQUFlLEdBQ3JCLENBQ2EsQ0FDbEI7WUFFRCxpQ0FBQyxhQUFhLElBQ1osT0FBTyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsRUFDbkMsU0FBUyxFQUFDLFlBQVksRUFDdEIsSUFBSSxFQUFDLHNCQUFzQixFQUMzQixPQUFPLEVBQUMsaUJBQWlCLEVBQ3pCLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUNoQyxLQUFLLEVBQUMsbUJBQW1CLEdBQ3pCO1lBRUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssOEJBQWtCLElBQUksQ0FDOUMsaUNBQUMsYUFBYSxJQUNaLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFDNUIsU0FBUyxFQUFDLFFBQVEsRUFDbEIsSUFBSSxFQUFDLGVBQWUsRUFDcEIsS0FBSyxFQUFDLFNBQVMsR0FDZixDQUNILENBRUMsQ0FDUCxDQUFBO0lBQ0gsQ0FBQztJQUNILGNBQUM7QUFBRCxDQUFDLEFBckpELENBQ1Esa0JBQUssQ0FBQyxhQUFhLEdBb0oxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgc2NyZWVuZnVsbCBmcm9tICdzY3JlZW5mdWxsJ1xuaW1wb3J0IHsgcmVtb3ZlU3RyZWFtIH0gZnJvbSAnLi4vYWN0aW9ucy9TdHJlYW1BY3Rpb25zJ1xuaW1wb3J0IHsgZ2V0RGVza3RvcFN0cmVhbSB9IGZyb20gJy4uL2FjdGlvbnMvTWVkaWFBY3Rpb25zJ1xuaW1wb3J0IHsgU3RyZWFtV2l0aFVSTCB9IGZyb20gJy4uL3JlZHVjZXJzL3N0cmVhbXMnXG5pbXBvcnQgeyBNRSwgRElBTF9TVEFURV9JTl9DQUxMLCBEaWFsU3RhdGUgfSBmcm9tICcuLi9jb25zdGFudHMnXG5cbmNvbnN0IGhpZGRlbiA9IHtcbiAgZGlzcGxheTogJ25vbmUnLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRvb2xiYXJQcm9wcyB7XG4gIGRpYWxTdGF0ZTogRGlhbFN0YXRlXG4gIG1lc3NhZ2VzQ291bnQ6IG51bWJlclxuICBzdHJlYW06IFN0cmVhbVdpdGhVUkxcbiAgZGVza3RvcFN0cmVhbTogU3RyZWFtV2l0aFVSTCB8IHVuZGVmaW5lZFxuICBvblRvZ2dsZUNoYXQ6ICgpID0+IHZvaWRcbiAgb25HZXREZXNrdG9wU3RyZWFtOiB0eXBlb2YgZ2V0RGVza3RvcFN0cmVhbVxuICBvblJlbW92ZVN0cmVhbTogdHlwZW9mIHJlbW92ZVN0cmVhbVxuICBvblNlbmRGaWxlOiAoZmlsZTogRmlsZSkgPT4gdm9pZFxuICBvbkhhbmd1cDogKCkgPT4gdm9pZFxuICBjaGF0VmlzaWJsZTogYm9vbGVhblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRvb2xiYXJTdGF0ZSB7XG4gIHJlYWRNZXNzYWdlczogbnVtYmVyXG4gIGNhbURpc2FibGVkOiBib29sZWFuXG4gIG1pY011dGVkOiBib29sZWFuXG4gIGZ1bGxTY3JlZW5FbmFibGVkOiBib29sZWFuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9vbGJhckJ1dHRvblByb3BzIHtcbiAgY2xhc3NOYW1lPzogc3RyaW5nXG4gIGJhZGdlPzogc3RyaW5nIHwgbnVtYmVyXG4gIGJsaW5rPzogYm9vbGVhblxuICBvbkNsaWNrOiAoKSA9PiB2b2lkXG4gIGljb246IHN0cmluZ1xuICBvZmZJY29uPzogc3RyaW5nXG4gIG9uPzogYm9vbGVhblxuICB0aXRsZTogc3RyaW5nXG59XG5cblxuZnVuY3Rpb24gVG9vbGJhckJ1dHRvbihwcm9wczogVG9vbGJhckJ1dHRvblByb3BzKSB7XG4gIGNvbnN0IHsgYmxpbmssIG9uIH0gPSBwcm9wc1xuICBjb25zdCBpY29uID0gIW9uICYmIHByb3BzLm9mZkljb24gPyBwcm9wcy5vZmZJY29uIDogcHJvcHMuaWNvblxuXG4gIHJldHVybiAoXG4gICAgPGFcbiAgICAgIGNsYXNzTmFtZT17Y2xhc3NuYW1lcygnYnV0dG9uJywgcHJvcHMuY2xhc3NOYW1lLCB7IGJsaW5rLCBvbiB9KX1cbiAgICAgIG9uQ2xpY2s9e3Byb3BzLm9uQ2xpY2t9XG4gICAgICBocmVmPScjJ1xuICAgID5cbiAgICAgIDxzcGFuIGNsYXNzTmFtZT17Y2xhc3NuYW1lcygnaWNvbicsIGljb24pfT5cbiAgICAgICAgeyEhcHJvcHMuYmFkZ2UgJiYgPHNwYW4gY2xhc3NOYW1lPSdiYWRnZSc+e3Byb3BzLmJhZGdlfTwvc3Bhbj59XG4gICAgICA8L3NwYW4+XG4gICAgICA8c3BhbiBjbGFzc05hbWU9XCJ0b29sdGlwXCI+e3Byb3BzLnRpdGxlfTwvc3Bhbj5cbiAgICA8L2E+XG4gIClcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVG9vbGJhclxuZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PFRvb2xiYXJQcm9wcywgVG9vbGJhclN0YXRlPiB7XG4gIGZpbGUgPSBSZWFjdC5jcmVhdGVSZWY8SFRNTElucHV0RWxlbWVudD4oKVxuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBUb29sYmFyUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcylcbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgcmVhZE1lc3NhZ2VzOiBwcm9wcy5tZXNzYWdlc0NvdW50LFxuICAgICAgY2FtRGlzYWJsZWQ6IGZhbHNlLFxuICAgICAgbWljTXV0ZWQ6IGZhbHNlLFxuICAgICAgZnVsbFNjcmVlbkVuYWJsZWQ6IGZhbHNlLFxuICAgIH1cbiAgfVxuXG4gIGhhbmRsZU1pY0NsaWNrID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgc3RyZWFtIH0gPSB0aGlzLnByb3BzXG4gICAgc3RyZWFtLnN0cmVhbS5nZXRBdWRpb1RyYWNrcygpLmZvckVhY2godHJhY2sgPT4ge1xuICAgICAgdHJhY2suZW5hYmxlZCA9ICF0cmFjay5lbmFibGVkXG4gICAgfSlcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICBtaWNNdXRlZDogIXRoaXMuc3RhdGUubWljTXV0ZWQsXG4gICAgfSlcbiAgfVxuICBoYW5kbGVDYW1DbGljayA9ICgpID0+IHtcbiAgICBjb25zdCB7IHN0cmVhbSB9ID0gdGhpcy5wcm9wc1xuICAgIHN0cmVhbS5zdHJlYW0uZ2V0VmlkZW9UcmFja3MoKS5mb3JFYWNoKHRyYWNrID0+IHtcbiAgICAgIHRyYWNrLmVuYWJsZWQgPSAhdHJhY2suZW5hYmxlZFxuICAgIH0pXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgY2FtRGlzYWJsZWQ6ICF0aGlzLnN0YXRlLmNhbURpc2FibGVkLFxuICAgIH0pXG4gIH1cbiAgaGFuZGxlRnVsbHNjcmVlbkNsaWNrID0gKCkgPT4ge1xuICAgIGlmIChzY3JlZW5mdWxsLmlzRW5hYmxlZCkge1xuICAgICAgc2NyZWVuZnVsbC50b2dnbGUoKVxuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICAgIGZ1bGxTY3JlZW5FbmFibGVkOiAhc2NyZWVuZnVsbC5pc0Z1bGxzY3JlZW4sXG4gICAgICB9KVxuICAgIH1cbiAgfVxuICBoYW5kbGVIYW5nb3V0Q2xpY2sgPSAoKSA9PiB7XG4gICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSAnLydcbiAgfVxuICBoYW5kbGVTZW5kRmlsZSA9ICgpID0+IHtcbiAgICB0aGlzLmZpbGUuY3VycmVudCEuY2xpY2soKVxuICB9XG4gIGhhbmRsZVNlbGVjdEZpbGVzID0gKGV2ZW50OiBSZWFjdC5DaGFuZ2VFdmVudDxIVE1MSW5wdXRFbGVtZW50PikgPT4ge1xuICAgIEFycmF5XG4gICAgLmZyb20oZXZlbnQudGFyZ2V0IS5maWxlcyEpXG4gICAgLmZvckVhY2goZmlsZSA9PiB0aGlzLnByb3BzLm9uU2VuZEZpbGUoZmlsZSkpXG4gIH1cbiAgaGFuZGxlVG9nZ2xlQ2hhdCA9ICgpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIHJlYWRNZXNzYWdlczogdGhpcy5wcm9wcy5tZXNzYWdlc0NvdW50LFxuICAgIH0pXG4gICAgdGhpcy5wcm9wcy5vblRvZ2dsZUNoYXQoKVxuICB9XG4gIGhhbmRsZVRvZ2dsZVNoYXJlRGVza3RvcCA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5wcm9wcy5kZXNrdG9wU3RyZWFtKSB7XG4gICAgICB0aGlzLnByb3BzLm9uUmVtb3ZlU3RyZWFtKE1FLCB0aGlzLnByb3BzLmRlc2t0b3BTdHJlYW0uc3RyZWFtKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnByb3BzLm9uR2V0RGVza3RvcFN0cmVhbSgpLmNhdGNoKCgpID0+IHt9KVxuICAgIH1cbiAgfVxuICByZW5kZXIgKCkge1xuICAgIGNvbnN0IHsgbWVzc2FnZXNDb3VudCwgc3RyZWFtIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3QgdW5yZWFkQ291bnQgPSBtZXNzYWdlc0NvdW50IC0gdGhpcy5zdGF0ZS5yZWFkTWVzc2FnZXNcbiAgICBjb25zdCBoYXNVbnJlYWQgPSB1bnJlYWRDb3VudCA+IDBcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cInRvb2xiYXIgYWN0aXZlXCI+XG4gICAgICAgIDxpbnB1dFxuICAgICAgICAgIHN0eWxlPXtoaWRkZW59XG4gICAgICAgICAgdHlwZT1cImZpbGVcIlxuICAgICAgICAgIG11bHRpcGxlXG4gICAgICAgICAgcmVmPXt0aGlzLmZpbGV9XG4gICAgICAgICAgb25DaGFuZ2U9e3RoaXMuaGFuZGxlU2VsZWN0RmlsZXN9XG4gICAgICAgIC8+XG5cbiAgICAgICAgPFRvb2xiYXJCdXR0b25cbiAgICAgICAgICBiYWRnZT17dW5yZWFkQ291bnR9XG4gICAgICAgICAgY2xhc3NOYW1lPSdjaGF0J1xuICAgICAgICAgIGljb249J2ljb24tcXVlc3Rpb25fYW5zd2VyJ1xuICAgICAgICAgIGJsaW5rPXshdGhpcy5wcm9wcy5jaGF0VmlzaWJsZSAmJiBoYXNVbnJlYWR9XG4gICAgICAgICAgb25DbGljaz17dGhpcy5oYW5kbGVUb2dnbGVDaGF0fVxuICAgICAgICAgIG9uPXt0aGlzLnByb3BzLmNoYXRWaXNpYmxlfVxuICAgICAgICAgIHRpdGxlPSdUb2dnbGUgQ2hhdCdcbiAgICAgICAgLz5cblxuICAgICAgICA8VG9vbGJhckJ1dHRvblxuICAgICAgICAgIGNsYXNzTmFtZT0nc2VuZC1maWxlJ1xuICAgICAgICAgIGljb249J2ljb24tZmlsZS10ZXh0MidcbiAgICAgICAgICBvbkNsaWNrPXt0aGlzLmhhbmRsZVNlbmRGaWxlfVxuICAgICAgICAgIHRpdGxlPSdTZW5kIEZpbGUnXG4gICAgICAgIC8+XG5cbiAgICAgICAgPFRvb2xiYXJCdXR0b25cbiAgICAgICAgICBjbGFzc05hbWU9J3N0cmVhbS1kZXNrdG9wJ1xuICAgICAgICAgIGljb249J2ljb24tZGlzcGxheSdcbiAgICAgICAgICBvbkNsaWNrPXt0aGlzLmhhbmRsZVRvZ2dsZVNoYXJlRGVza3RvcH1cbiAgICAgICAgICBvbj17ISF0aGlzLnByb3BzLmRlc2t0b3BTdHJlYW19XG4gICAgICAgICAgdGl0bGU9J1NoYXJlIERlc2t0b3AnXG4gICAgICAgIC8+XG5cbiAgICAgICAge3N0cmVhbSAmJiAoXG4gICAgICAgICAgPFJlYWN0LkZyYWdtZW50PlxuICAgICAgICAgICAgPFRvb2xiYXJCdXR0b25cbiAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5oYW5kbGVNaWNDbGlja31cbiAgICAgICAgICAgICAgY2xhc3NOYW1lPSdtdXRlLWF1ZGlvJ1xuICAgICAgICAgICAgICBvbj17dGhpcy5zdGF0ZS5taWNNdXRlZH1cbiAgICAgICAgICAgICAgaWNvbj0naWNvbi1taWNfb2ZmJ1xuICAgICAgICAgICAgICBvZmZJY29uPSdpY29uLW1pYydcbiAgICAgICAgICAgICAgdGl0bGU9J1RvZ2dsZSBNaWNyb3Bob25lJ1xuICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIDxUb29sYmFyQnV0dG9uXG4gICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMuaGFuZGxlQ2FtQ2xpY2t9XG4gICAgICAgICAgICAgIGNsYXNzTmFtZT0nbXV0ZS12aWRlbydcbiAgICAgICAgICAgICAgb249e3RoaXMuc3RhdGUuY2FtRGlzYWJsZWR9XG4gICAgICAgICAgICAgIGljb249J2ljb24tdmlkZW9jYW1fb2ZmJ1xuICAgICAgICAgICAgICBvZmZJY29uPSdpY29uLXZpZGVvY2FtJ1xuICAgICAgICAgICAgICB0aXRsZT0nVG9nZ2xlIENhbWVyYSdcbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgPC9SZWFjdC5GcmFnbWVudD5cbiAgICAgICAgKX1cblxuICAgICAgICA8VG9vbGJhckJ1dHRvblxuICAgICAgICAgIG9uQ2xpY2s9e3RoaXMuaGFuZGxlRnVsbHNjcmVlbkNsaWNrfVxuICAgICAgICAgIGNsYXNzTmFtZT0nZnVsbHNjcmVlbidcbiAgICAgICAgICBpY29uPSdpY29uLWZ1bGxzY3JlZW5fZXhpdCdcbiAgICAgICAgICBvZmZJY29uPSdpY29uLWZ1bGxzY3JlZW4nXG4gICAgICAgICAgb249e3RoaXMuc3RhdGUuZnVsbFNjcmVlbkVuYWJsZWR9XG4gICAgICAgICAgdGl0bGU9J1RvZ2dsZSBGdWxsc2NyZWVuJ1xuICAgICAgICAvPlxuXG4gICAgICAgICAge3RoaXMucHJvcHMuZGlhbFN0YXRlID09PSBESUFMX1NUQVRFX0lOX0NBTEwgJiYgKFxuICAgICAgICAgICAgPFRvb2xiYXJCdXR0b25cbiAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5wcm9wcy5vbkhhbmd1cH1cbiAgICAgICAgICAgICAgY2xhc3NOYW1lPSdoYW5ndXAnXG4gICAgICAgICAgICAgIGljb249J2ljb24tY2FsbF9lbmQnXG4gICAgICAgICAgICAgIHRpdGxlPVwiSGFuZyBVcFwiXG4gICAgICAgICAgICAvPlxuICAgICAgICAgICl9XG5cbiAgICAgIDwvZGl2PlxuICAgIClcbiAgfVxufVxuIl19