"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
jest.mock('../window');
jest.mock('../actions/CallActions');
var react_1 = __importDefault(require("react"));
var react_dom_1 = __importDefault(require("react-dom"));
var test_utils_1 = __importDefault(require("react-dom/test-utils"));
var react_redux_1 = require("react-redux");
var store_1 = require("../store");
var Media_1 = require("./Media");
var constants_1 = require("../constants");
var CallActions_1 = require("../actions/CallActions");
describe('Media', function () {
    beforeEach(function () {
        store = store_1.createStore();
        store.dispatch({
            type: constants_1.MEDIA_ENUMERATE,
            status: 'resolved',
            payload: [{
                    id: '123',
                    name: 'Audio Input',
                    type: 'audioinput'
                }, {
                    id: '456',
                    label: 'Video Input',
                    name: 'videoinput'
                }]
        });
    });
    var store;
    function render() {
        return __awaiter(this, void 0, void 0, function () {
            var div, node;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        div = document.createElement('div');
                        return [4 /*yield*/, new Promise(function (resolve) {
                                react_dom_1["default"].render(react_1["default"].createElement("div", { ref: function (div) { return resolve(div); } },
                                    react_1["default"].createElement(react_redux_1.Provider, { store: store },
                                        react_1["default"].createElement(Media_1.Media, null))), div);
                            })];
                    case 1:
                        node = _a.sent();
                        return [2 /*return*/, node.children[0]];
                }
            });
        });
    }
    describe('submit', function () {
        var stream = {};
        var promise1;
        var dialPromise;
        var dialResolve;
        var dialReject;
        beforeEach(function () {
            navigator.mediaDevices.getUserMedia = function () { return __awaiter(void 0, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    promise1 = Promise.resolve(stream);
                    return [2 /*return*/, promise1];
                });
            }); };
            dialPromise = new Promise(function (resolve, reject) {
                dialResolve = resolve;
                dialReject = reject;
            });
            CallActions_1.dial.mockImplementation(function () {
                dialResolve();
                return {
                    status: 'resolved',
                    type: constants_1.DIAL
                };
            });
        });
        it('retrieves audio/video stream and dials the call', function () { return __awaiter(void 0, void 0, void 0, function () {
            var node;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, render()];
                    case 1:
                        node = (_a.sent()).querySelector('.media');
                        expect(node.tagName).toBe('FORM');
                        test_utils_1["default"].Simulate.submit(node);
                        expect(promise1).toBeDefined();
                        return [4 /*yield*/, promise1];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, dialPromise];
                    case 3:
                        _a.sent();
                        expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_IN_CALL);
                        return [2 /*return*/];
                }
            });
        }); });
        it('dials even when stream is unavailable', function () { return __awaiter(void 0, void 0, void 0, function () {
            var node, err, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        navigator.mediaDevices.getUserMedia = function () { return __awaiter(void 0, void 0, void 0, function () {
                            return __generator(this, function (_a) {
                                promise1 = Promise.reject(new Error('test stream error'));
                                return [2 /*return*/, promise1];
                            });
                        }); };
                        return [4 /*yield*/, render()];
                    case 1:
                        node = (_a.sent()).querySelector('.media');
                        expect(node.tagName).toBe('FORM');
                        test_utils_1["default"].Simulate.submit(node);
                        expect(promise1).toBeDefined();
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 4, , 5]);
                        return [4 /*yield*/, promise1];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        e_1 = _a.sent();
                        err = e_1;
                        return [3 /*break*/, 5];
                    case 5:
                        expect(err).toBeTruthy();
                        expect(err.message).toBe('test stream error');
                        return [4 /*yield*/, dialPromise];
                    case 6:
                        _a.sent();
                        expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_IN_CALL);
                        return [2 /*return*/];
                }
            });
        }); });
        it('returns  to hung up state when dialling fails', function () { return __awaiter(void 0, void 0, void 0, function () {
            var node, err, e_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        CallActions_1.dial.mockImplementation(function () {
                            dialReject(new Error('test dial error'));
                            return {
                                status: 'rejected',
                                type: constants_1.DIAL
                            };
                        });
                        return [4 /*yield*/, render()];
                    case 1:
                        node = (_a.sent()).querySelector('.media');
                        expect(node.tagName).toBe('FORM');
                        test_utils_1["default"].Simulate.submit(node);
                        expect(promise1).toBeDefined();
                        return [4 /*yield*/, promise1];
                    case 2:
                        _a.sent();
                        _a.label = 3;
                    case 3:
                        _a.trys.push([3, 5, , 6]);
                        return [4 /*yield*/, dialPromise];
                    case 4:
                        _a.sent();
                        return [3 /*break*/, 6];
                    case 5:
                        e_2 = _a.sent();
                        err = e_2;
                        return [3 /*break*/, 6];
                    case 6:
                        expect(err).toBeTruthy();
                        expect(err.message).toBe('test dial error');
                        expect(store.getState().media.dialState).toBe(constants_1.DIAL_STATE_HUNG_UP);
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('onVideoChange', function () {
        it('calls onSetVideoConstraint', function () { return __awaiter(void 0, void 0, void 0, function () {
            var node, select;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, render()];
                    case 1:
                        node = _a.sent();
                        select = node.querySelector('select[name=video-input]');
                        test_utils_1["default"].Simulate.change(select, {
                            target: {
                                value: '{"deviceId":123}'
                            }
                        });
                        expect(store.getState().media.video).toEqual({ deviceId: 123 });
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('onAudioChange', function () {
        it('calls onSetAudioConstraint', function () { return __awaiter(void 0, void 0, void 0, function () {
            var node, select;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, render()];
                    case 1:
                        node = _a.sent();
                        select = node.querySelector('select[name="audio-input"]');
                        test_utils_1["default"].Simulate.change(select, {
                            target: {
                                value: '{"deviceId":456}'
                            }
                        });
                        expect(store.getState().media.audio).toEqual({ deviceId: 456 });
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('onNicknameChange', function () {
        it('changes nickname', function () { return __awaiter(void 0, void 0, void 0, function () {
            var node, nickname;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, render()];
                    case 1:
                        node = _a.sent();
                        nickname = node.querySelector('input[name="nickname"]');
                        test_utils_1["default"].Simulate.change(nickname, {
                            target: {
                                value: 'john123'
                            }
                        });
                        expect(store.getState().nicknames[constants_1.ME]).toEqual('john123');
                        return [2 /*return*/];
                }
            });
        }); });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWVkaWEudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQvY29tcG9uZW50cy9NZWRpYS50ZXN0LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO0FBRW5DLGdEQUF5QjtBQUN6Qix3REFBZ0M7QUFDaEMsb0VBQTRDO0FBQzVDLDJDQUFzQztBQUN0QyxrQ0FBNkM7QUFDN0MsaUNBQStCO0FBQy9CLDBDQUFnRztBQUNoRyxzREFBNkM7QUFFN0MsUUFBUSxDQUFDLE9BQU8sRUFBRTtJQUVoQixVQUFVLENBQUM7UUFDVCxLQUFLLEdBQUcsbUJBQVcsRUFBRSxDQUFBO1FBQ3JCLEtBQUssQ0FBQyxRQUFRLENBQUM7WUFDYixJQUFJLEVBQUUsMkJBQWU7WUFDckIsTUFBTSxFQUFFLFVBQVU7WUFDbEIsT0FBTyxFQUFFLENBQUM7b0JBQ1IsRUFBRSxFQUFFLEtBQUs7b0JBQ1QsSUFBSSxFQUFFLGFBQWE7b0JBQ25CLElBQUksRUFBRSxZQUFZO2lCQUNuQixFQUFFO29CQUNELEVBQUUsRUFBRSxLQUFLO29CQUNULEtBQUssRUFBRSxhQUFhO29CQUNwQixJQUFJLEVBQUUsWUFBWTtpQkFDbkIsQ0FBQztTQUNILENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxLQUFZLENBQUE7SUFDaEIsU0FBZSxNQUFNOzs7Ozs7d0JBQ2IsR0FBRyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7d0JBQzVCLHFCQUFNLElBQUksT0FBTyxDQUFpQixVQUFBLE9BQU87Z0NBQ3BELHNCQUFRLENBQUMsTUFBTSxDQUNiLDBDQUFLLEdBQUcsRUFBRSxVQUFBLEdBQUcsSUFB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QyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUE7Ozs7YUFDaEUsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7SUFFRixRQUFRLENBQUMsa0JBQWtCLEVBQUU7UUFDM0IsRUFBRSxDQUFDLGtCQUFrQixFQUFFOzs7OzRCQUNSLHFCQUFNLE1BQU0sRUFBRSxFQUFBOzt3QkFBckIsSUFBSSxHQUFHLFNBQWM7d0JBQ3JCLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFFLENBQUE7d0JBQzlELHVCQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7NEJBQ2xDLE1BQU0sRUFBRTtnQ0FDTixLQUFLLEVBQUUsU0FBUzs2QkFDVjt5QkFDVCxDQUFDLENBQUE7d0JBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxTQUFTLENBQUMsY0FBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUE7Ozs7YUFDMUQsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFFSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImplc3QubW9jaygnLi4vd2luZG93Jylcbmplc3QubW9jaygnLi4vYWN0aW9ucy9DYWxsQWN0aW9ucycpXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCBSZWFjdERPTSBmcm9tICdyZWFjdC1kb20nXG5pbXBvcnQgVGVzdFV0aWxzIGZyb20gJ3JlYWN0LWRvbS90ZXN0LXV0aWxzJ1xuaW1wb3J0IHsgUHJvdmlkZXIgfSBmcm9tICdyZWFjdC1yZWR1eCdcbmltcG9ydCB7IGNyZWF0ZVN0b3JlLCBTdG9yZSB9IGZyb20gJy4uL3N0b3JlJ1xuaW1wb3J0IHsgTWVkaWEgfSBmcm9tICcuL01lZGlhJ1xuaW1wb3J0IHsgTUVESUFfRU5VTUVSQVRFLCBNRSwgRElBTCwgRElBTF9TVEFURV9JTl9DQUxMLCBESUFMX1NUQVRFX0hVTkdfVVAgfSBmcm9tICcuLi9jb25zdGFudHMnXG5pbXBvcnQgeyBkaWFsIH0gZnJvbSAnLi4vYWN0aW9ucy9DYWxsQWN0aW9ucydcblxuZGVzY3JpYmUoJ01lZGlhJywgKCkgPT4ge1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHN0b3JlID0gY3JlYXRlU3RvcmUoKVxuICAgIHN0b3JlLmRpc3BhdGNoKHtcbiAgICAgIHR5cGU6IE1FRElBX0VOVU1FUkFURSxcbiAgICAgIHN0YXR1czogJ3Jlc29sdmVkJyxcbiAgICAgIHBheWxvYWQ6IFt7XG4gICAgICAgIGlkOiAnMTIzJyxcbiAgICAgICAgbmFtZTogJ0F1ZGlvIElucHV0JyxcbiAgICAgICAgdHlwZTogJ2F1ZGlvaW5wdXQnLFxuICAgICAgfSwge1xuICAgICAgICBpZDogJzQ1NicsXG4gICAgICAgIGxhYmVsOiAnVmlkZW8gSW5wdXQnLFxuICAgICAgICBuYW1lOiAndmlkZW9pbnB1dCcsXG4gICAgICB9XSxcbiAgICB9KVxuICB9KVxuXG4gIGxldCBzdG9yZTogU3RvcmVcbiAgYXN5bmMgZnVuY3Rpb24gcmVuZGVyKCkge1xuICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gICAgY29uc3Qgbm9kZSA9IGF3YWl0IG5ldyBQcm9taXNlPEhUTUxEaXZFbGVtZW50PihyZXNvbHZlID0+IHtcbiAgICAgIFJlYWN0RE9NLnJlbmRlcihcbiAgICAgICAgPGRpdiByZWY9e2RpdiA9PiByZXNvbHZlKGRpdiEpfT5cbiAgICAgICAgICA8UHJvdmlkZXIgc3RvcmU9e3N0b3JlfT5cbiAgICAgICAgICAgIDxNZWRpYSAvPlxuICAgICAgICAgIDwvUHJvdmlkZXI+XG4gICAgICAgIDwvZGl2PixcbiAgICAgICAgZGl2LFxuICAgICAgKVxuICAgIH0pXG4gICAgcmV0dXJuIG5vZGUuY2hpbGRyZW5bMF1cbiAgfVxuXG4gIGRlc2NyaWJlKCdzdWJtaXQnLCAoKSA9PiB7XG4gICAgY29uc3Qgc3RyZWFtID0ge30gYXMgTWVkaWFTdHJlYW1cbiAgICBsZXQgcHJvbWlzZTE6IFByb21pc2U8TWVkaWFTdHJlYW0+XG5cbiAgICBsZXQgZGlhbFByb21pc2U6IFByb21pc2U8dm9pZD5cbiAgICBsZXQgZGlhbFJlc29sdmU6ICgpID0+IHZvaWRcbiAgICBsZXQgZGlhbFJlamVjdDogKGVycjogRXJyb3IpID0+IHZvaWRcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBwcm9taXNlMSA9IFByb21pc2UucmVzb2x2ZShzdHJlYW0pXG4gICAgICAgIHJldHVybiBwcm9taXNlMVxuICAgICAgfVxuICAgICAgZGlhbFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGRpYWxSZXNvbHZlID0gcmVzb2x2ZVxuICAgICAgICBkaWFsUmVqZWN0ID0gcmVqZWN0XG4gICAgICB9KVxuICAgICAgOyhkaWFsIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHtcbiAgICAgICAgZGlhbFJlc29sdmUoKVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1czogJ3Jlc29sdmVkJyxcbiAgICAgICAgICB0eXBlOiBESUFMLFxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gICAgaXQoJ3JldHJpZXZlcyBhdWRpby92aWRlbyBzdHJlYW0gYW5kIGRpYWxzIHRoZSBjYWxsJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgbm9kZSA9IChhd2FpdCByZW5kZXIoKSkucXVlcnlTZWxlY3RvcignLm1lZGlhJykhXG4gICAgICBleHBlY3Qobm9kZS50YWdOYW1lKS50b0JlKCdGT1JNJylcbiAgICAgIFRlc3RVdGlscy5TaW11bGF0ZS5zdWJtaXQobm9kZSlcbiAgICAgIGV4cGVjdChwcm9taXNlMSkudG9CZURlZmluZWQoKVxuICAgICAgYXdhaXQgcHJvbWlzZTFcbiAgICAgIGF3YWl0IGRpYWxQcm9taXNlXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5tZWRpYS5kaWFsU3RhdGUpLnRvQmUoRElBTF9TVEFURV9JTl9DQUxMKVxuICAgIH0pXG4gICAgaXQoJ2RpYWxzIGV2ZW4gd2hlbiBzdHJlYW0gaXMgdW5hdmFpbGFibGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgcHJvbWlzZTEgPSBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ3Rlc3Qgc3RyZWFtIGVycm9yJykpXG4gICAgICAgIHJldHVybiBwcm9taXNlMVxuICAgICAgfVxuICAgICAgY29uc3Qgbm9kZSA9IChhd2FpdCByZW5kZXIoKSkucXVlcnlTZWxlY3RvcignLm1lZGlhJykhXG4gICAgICBleHBlY3Qobm9kZS50YWdOYW1lKS50b0JlKCdGT1JNJylcbiAgICAgIFRlc3RVdGlscy5TaW11bGF0ZS5zdWJtaXQobm9kZSlcbiAgICAgIGV4cGVjdChwcm9taXNlMSkudG9CZURlZmluZWQoKVxuICAgICAgbGV0IGVyciE6IEVycm9yXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBwcm9taXNlMVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBlcnIgPSBlXG4gICAgICB9XG4gICAgICBleHBlY3QoZXJyKS50b0JlVHJ1dGh5KClcbiAgICAgIGV4cGVjdChlcnIubWVzc2FnZSkudG9CZSgndGVzdCBzdHJlYW0gZXJyb3InKVxuICAgICAgYXdhaXQgZGlhbFByb21pc2VcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLmRpYWxTdGF0ZSkudG9CZShESUFMX1NUQVRFX0lOX0NBTEwpXG4gICAgfSlcbiAgICBpdCgncmV0dXJucyAgdG8gaHVuZyB1cCBzdGF0ZSB3aGVuIGRpYWxsaW5nIGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKGRpYWwgYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge1xuICAgICAgICBkaWFsUmVqZWN0KG5ldyBFcnJvcigndGVzdCBkaWFsIGVycm9yJykpXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzOiAncmVqZWN0ZWQnLFxuICAgICAgICAgIHR5cGU6IERJQUwsXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICBjb25zdCBub2RlID0gKGF3YWl0IHJlbmRlcigpKS5xdWVyeVNlbGVjdG9yKCcubWVkaWEnKSFcbiAgICAgIGV4cGVjdChub2RlLnRhZ05hbWUpLnRvQmUoJ0ZPUk0nKVxuICAgICAgVGVzdFV0aWxzLlNpbXVsYXRlLnN1Ym1pdChub2RlKVxuICAgICAgZXhwZWN0KHByb21pc2UxKS50b0JlRGVmaW5lZCgpXG4gICAgICBhd2FpdCBwcm9taXNlMVxuICAgICAgbGV0IGVyciE6IEVycm9yXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBkaWFsUHJvbWlzZVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBlcnIgPSBlXG4gICAgICB9XG4gICAgICBleHBlY3QoZXJyKS50b0JlVHJ1dGh5KClcbiAgICAgIGV4cGVjdChlcnIubWVzc2FnZSkudG9CZSgndGVzdCBkaWFsIGVycm9yJylcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLmRpYWxTdGF0ZSkudG9CZShESUFMX1NUQVRFX0hVTkdfVVApXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnb25WaWRlb0NoYW5nZScsICgpID0+IHtcbiAgICBpdCgnY2FsbHMgb25TZXRWaWRlb0NvbnN0cmFpbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBub2RlID0gYXdhaXQgcmVuZGVyKClcbiAgICAgIGNvbnN0IHNlbGVjdCA9IG5vZGUucXVlcnlTZWxlY3Rvcignc2VsZWN0W25hbWU9dmlkZW8taW5wdXRdJykhXG4gICAgICBUZXN0VXRpbHMuU2ltdWxhdGUuY2hhbmdlKHNlbGVjdCwge1xuICAgICAgICB0YXJnZXQ6IHtcbiAgICAgICAgICB2YWx1ZTogJ3tcImRldmljZUlkXCI6MTIzfScsXG4gICAgICAgIH0gYXMgYW55LFxuICAgICAgfSlcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpLm1lZGlhLnZpZGVvKS50b0VxdWFsKHsgZGV2aWNlSWQ6IDEyMyB9KVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ29uQXVkaW9DaGFuZ2UnLCAoKSA9PiB7XG4gICAgaXQoJ2NhbGxzIG9uU2V0QXVkaW9Db25zdHJhaW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHJlbmRlcigpXG4gICAgICBjb25zdCBzZWxlY3QgPSBub2RlLnF1ZXJ5U2VsZWN0b3IoJ3NlbGVjdFtuYW1lPVwiYXVkaW8taW5wdXRcIl0nKSFcbiAgICAgIFRlc3RVdGlscy5TaW11bGF0ZS5jaGFuZ2Uoc2VsZWN0LCB7XG4gICAgICAgIHRhcmdldDoge1xuICAgICAgICAgIHZhbHVlOiAne1wiZGV2aWNlSWRcIjo0NTZ9JyxcbiAgICAgICAgfSBhcyBhbnksXG4gICAgICB9KVxuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkubWVkaWEuYXVkaW8pLnRvRXF1YWwoeyBkZXZpY2VJZDogNDU2IH0pXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnb25OaWNrbmFtZUNoYW5nZScsICgpID0+IHtcbiAgICBpdCgnY2hhbmdlcyBuaWNrbmFtZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG5vZGUgPSBhd2FpdCByZW5kZXIoKVxuICAgICAgY29uc3Qgbmlja25hbWUgPSBub2RlLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWU9XCJuaWNrbmFtZVwiXScpIVxuICAgICAgVGVzdFV0aWxzLlNpbXVsYXRlLmNoYW5nZShuaWNrbmFtZSwge1xuICAgICAgICB0YXJnZXQ6IHtcbiAgICAgICAgICB2YWx1ZTogJ2pvaG4xMjMnLFxuICAgICAgICB9IGFzIGFueSxcbiAgICAgIH0pXG4gICAgICBleHBlY3Qoc3RvcmUuZ2V0U3RhdGUoKS5uaWNrbmFtZXNbTUVdKS50b0VxdWFsKCdqb2huMTIzJylcbiAgICB9KVxuICB9KVxuXG59KVxuIl19