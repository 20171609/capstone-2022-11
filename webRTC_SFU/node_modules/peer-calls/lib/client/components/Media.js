"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
var react_1 = __importDefault(require("react"));
var react_redux_1 = require("react-redux");
var MediaActions_1 = require("../actions/MediaActions");
var Alerts_1 = require("./Alerts");
var NotifyActions_1 = require("../actions/NotifyActions");
var constants_1 = require("../constants");
var CallActions_1 = require("../actions/CallActions");
var NicknameActions_1 = require("../actions/NicknameActions");
function mapStateToProps(state) {
    return __assign(__assign({}, state.media), { nickname: state.nicknames[constants_1.ME], visible: state.media.dialState === constants_1.DIAL_STATE_HUNG_UP });
}
var mapDispatchToProps = {
    enumerateDevices: MediaActions_1.enumerateDevices,
    dial: CallActions_1.dial,
    onSetVideoConstraint: MediaActions_1.setVideoConstraint,
    onSetAudioConstraint: MediaActions_1.setAudioConstraint,
    onSetNickname: NicknameActions_1.setNickname,
    getMediaStream: MediaActions_1.getMediaStream,
    play: MediaActions_1.play,
    logInfo: NotifyActions_1.info,
    logWarning: NotifyActions_1.warning,
    logError: NotifyActions_1.error
};
var c = react_redux_1.connect(mapStateToProps, mapDispatchToProps);
var MediaForm = /** @class */ (function (_super) {
    __extends(MediaForm, _super);
    function MediaForm() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.handleSubmit = function (event) { return __awaiter(_this, void 0, void 0, function () {
            var props, audio, video, err_1, err_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        event.preventDefault();
                        props = this.props;
                        audio = props.audio, video = props.video;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, props.getMediaStream({ audio: audio, video: video })];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        err_1 = _a.sent();
                        props.logError('Error getting media stream: {0}', err_1);
                        return [3 /*break*/, 4];
                    case 4:
                        props.logInfo('Dialling...');
                        _a.label = 5;
                    case 5:
                        _a.trys.push([5, 7, , 8]);
                        return [4 /*yield*/, props.dial()];
                    case 6:
                        _a.sent();
                        return [3 /*break*/, 8];
                    case 7:
                        err_2 = _a.sent();
                        props.logError('Error dialling: {0}', err_2);
                        return [3 /*break*/, 8];
                    case 8: return [2 /*return*/];
                }
            });
        }); };
        _this.handleVideoChange = function (event) {
            var constraint = JSON.parse(event.target.value);
            _this.props.onSetVideoConstraint(constraint);
        };
        _this.handleAudioChange = function (event) {
            var constraint = JSON.parse(event.target.value);
            _this.props.onSetAudioConstraint(constraint);
        };
        _this.handleNicknameChange = function (event) {
            _this.props.onSetNickname({
                nickname: event.target.value,
                userId: constants_1.ME
            });
        };
        return _this;
    }
    MediaForm.prototype.componentDidMount = function () {
        this.props.enumerateDevices();
    };
    MediaForm.prototype.render = function () {
        var props = this.props;
        if (!props.visible) {
            return null;
        }
        var videoId = JSON.stringify(props.video);
        var audioId = JSON.stringify(props.audio);
        return (react_1["default"].createElement("form", { className: 'media', onSubmit: this.handleSubmit },
            react_1["default"].createElement("input", { required: true, name: 'nickname', type: 'text', placeholder: 'Nickname', onChange: this.handleNicknameChange, value: props.nickname }),
            react_1["default"].createElement("select", { name: 'video-input', onChange: this.handleVideoChange, value: videoId },
                react_1["default"].createElement(Options, { devices: props.devices, "default": '{"facingMode":"user"}', type: 'videoinput' })),
            react_1["default"].createElement("select", { name: 'audio-input', onChange: this.handleAudioChange, value: audioId },
                react_1["default"].createElement(Options, { devices: props.devices, "default": 'true', type: 'audioinput' })),
            react_1["default"].createElement("button", { type: 'submit' }, "Join Call")));
    };
    return MediaForm;
}(react_1["default"].PureComponent));
exports.MediaForm = MediaForm;
exports.AutoplayMessage = react_1["default"].memo(function Autoplay(props) {
    return (react_1["default"].createElement(react_1["default"].Fragment, null,
        "Your browser has blocked video autoplay on this page. To continue with your call, please press the play button: \u00A0",
        react_1["default"].createElement("button", { className: 'button', onClick: props.play }, "Play")));
});
exports.Media = c(react_1["default"].memo(function Media(props) {
    return (react_1["default"].createElement("div", { className: 'media-container' },
        react_1["default"].createElement(Alerts_1.Alerts, null, props.autoplayError && (react_1["default"].createElement(Alerts_1.Alert, null,
            react_1["default"].createElement(exports.AutoplayMessage, { play: props.play })))),
        react_1["default"].createElement(MediaForm, __assign({}, props))));
}));
var labels = {
    audioinput: 'Audio',
    videoinput: 'Video'
};
function Options(props) {
    var label = labels[props.type];
    return (react_1["default"].createElement(react_1["default"].Fragment, null,
        react_1["default"].createElement("option", { value: 'false' },
            "No ",
            label),
        react_1["default"].createElement("option", { value: props["default"] },
            "Default ",
            label),
        props.devices
            .filter(function (device) { return device.type === props.type; })
            .map(function (device) {
            return react_1["default"].createElement("option", { key: device.id, value: JSON.stringify({ deviceId: device.id }) }, device.name || device.type);
        })));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWVkaWEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpZW50L2NvbXBvbmVudHMvTWVkaWEudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsZ0RBQXlCO0FBQ3pCLDJDQUFxQztBQUNyQyx3REFBdUs7QUFHdkssbUNBQXdDO0FBQ3hDLDBEQUErRDtBQUMvRCwwQ0FBZ0U7QUFDaEUsc0RBQTZDO0FBQzdDLDhEQUF3RDtBQWtCeEQsU0FBUyxlQUFlLENBQUMsS0FBWTtJQUNuQyw2QkFDSyxLQUFLLENBQUMsS0FBSyxLQUNkLFFBQVEsRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLGNBQUUsQ0FBQyxFQUM3QixPQUFPLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssOEJBQWtCLElBQ3REO0FBQ0gsQ0FBQztBQUVELElBQU0sa0JBQWtCLEdBQUc7SUFDekIsZ0JBQWdCLGlDQUFBO0lBQ2hCLElBQUksb0JBQUE7SUFDSixvQkFBb0IsRUFBRSxpQ0FBa0I7SUFDeEMsb0JBQW9CLEVBQUUsaUNBQWtCO0lBQ3hDLGFBQWEsRUFBRSw2QkFBVztJQUMxQixjQUFjLCtCQUFBO0lBQ2QsSUFBSSxxQkFBQTtJQUNKLE9BQU8sRUFBRSxvQkFBSTtJQUNiLFVBQVUsRUFBRSx1QkFBTztJQUNuQixRQUFRLEVBQUUscUJBQUs7Q0FDaEIsQ0FBQTtBQUVELElBQU0sQ0FBQyxHQUFHLHFCQUFPLENBQUMsZUFBZSxFQUFFLGtCQUFrQixDQUFDLENBQUE7QUFFdEQ7SUFBK0IsNkJBQStCO0lBQTlEO1FBQUEscUVBdUZDO1FBbkZDLGtCQUFZLEdBQUcsVUFBTyxLQUF1Qzs7Ozs7d0JBQzNELEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQTt3QkFDZCxLQUFLLEdBQUssSUFBSSxNQUFULENBQVM7d0JBQ2QsS0FBSyxH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VTtRQUVwRCxLQUFLLENBQUMsT0FBTzthQUNaLE1BQU0sQ0FBQyxVQUFBLE1BQU0sSUFBSSxPQUFBLE1BQU0sQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLElBQUksRUFBMUIsQ0FBMEIsQ0FBQzthQUM1QyxHQUFHLENBQUMsVUFBQSxNQUFNO1lBQ1QsT0FBQSw2Q0FDRSxHQUFHLEVBQUUsTUFBTSxDQUFDLEVBQUUsRUFDZCxLQUFLLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRSxFQUFDLENBQUMsSUFFM0MsTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUNwQjtRQUxULENBS1MsQ0FDVixDQUVZLENBQ2xCLENBQUE7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgY29ubmVjdCB9IGZyb20gJ3JlYWN0LXJlZHV4J1xuaW1wb3J0IHsgQXVkaW9Db25zdHJhaW50LCBNZWRpYURldmljZSwgc2V0QXVkaW9Db25zdHJhaW50LCBzZXRWaWRlb0NvbnN0cmFpbnQsIFZpZGVvQ29uc3RyYWludCwgZ2V0TWVkaWFTdHJlYW0sIGVudW1lcmF0ZURldmljZXMsIHBsYXkgfSBmcm9tICcuLi9hY3Rpb25zL01lZGlhQWN0aW9ucydcbmltcG9ydCB7IE1lZGlhU3RhdGUgfSBmcm9tICcuLi9yZWR1Y2Vycy9tZWRpYSdcbmltcG9ydCB7IFN0YXRlIH0gZnJvbSAnLi4vc3RvcmUnXG5pbXBvcnQgeyBBbGVydHMsIEFsZXJ0IH0gZnJvbSAnLi9BbGVydHMnXG5pbXBvcnQgeyBpbmZvLCB3YXJuaW5nLCBlcnJvciB9IGZyb20gJy4uL2FjdGlvbnMvTm90aWZ5QWN0aW9ucydcbmltcG9ydCB7IE1FLCBEaWFsU3RhdGUsIERJQUxfU1RBVEVfSFVOR19VUCB9IGZyb20gJy4uL2NvbnN0YW50cydcbmltcG9ydCB7IGRpYWwgfSBmcm9tICcuLi9hY3Rpb25zL0NhbGxBY3Rpb25zJ1xuaW1wb3J0IHsgc2V0Tmlja25hbWUgfSBmcm9tICcuLi9hY3Rpb25zL05pY2tuYW1lQWN0aW9ucydcblxuZXhwb3J0IHR5cGUgTWVkaWFQcm9wcyA9IE1lZGlhU3RhdGUgJiB7XG4gIGRpYWw6IHR5cGVvZiBkaWFsXG4gIGRpYWxTdGF0ZTogRGlhbFN0YXRlXG4gIHZpc2libGU6IGJvb2xlYW5cbiAgZW51bWVyYXRlRGV2aWNlczogdHlwZW9mIGVudW1lcmF0ZURldmljZXNcbiAgb25TZXRWaWRlb0NvbnN0cmFpbnQ6IHR5cGVvZiBzZXRWaWRlb0NvbnN0cmFpbnRcbiAgb25TZXRBdWRpb0NvbnN0cmFpbnQ6IHR5cGVvZiBzZXRBdWRpb0NvbnN0cmFpbnRcbiAgZ2V0TWVkaWFTdHJlYW06IHR5cGVvZiBnZXRNZWRpYVN0cmVhbVxuICBwbGF5OiB0eXBlb2YgcGxheVxuICBsb2dJbmZvOiB0eXBlb2YgaW5mb1xuICBsb2dXYXJuaW5nOiB0eXBlb2Ygd2FybmluZ1xuICBsb2dFcnJvcjogdHlwZW9mIGVycm9yXG4gIG9uU2V0Tmlja25hbWU6IHR5cGVvZiBzZXROaWNrbmFtZVxuICBuaWNrbmFtZT86IHN0cmluZ1xufVxuXG5mdW5jdGlvbiBtYXBTdGF0ZVRvUHJvcHMoc3RhdGU6IFN0YXRlKSB7XG4gIHJldHVybiB7XG4gICAgLi4uc3RhdGUubWVkaWEsXG4gICAgbmlja25hbWU6IHN0YXRlLm5pY2tuYW1lc1tNRV0sXG4gICAgdmlzaWJsZTogc3RhdGUubWVkaWEuZGlhbFN0YXRlID09PSBESUFMX1NUQVRFX0hVTkdfVVAsXG4gIH1cbn1cblxuY29uc3QgbWFwRGlzcGF0Y2hUb1Byb3BzID0ge1xuICBlbnVtZXJhdGVEZXZpY2VzLFxuICBkaWFsLFxuICBvblNldFZpZGVvQ29uc3RyYWludDogc2V0VmlkZW9Db25zdHJhaW50LFxuICBvblNldEF1ZGlvQ29uc3RyYWludDogc2V0QXVkaW9Db25zdHJhaW50LFxuICBvblNldE5pY2tuYW1lOiBzZXROaWNrbmFtZSxcbiAgZ2V0TWVkaWFTdHJlYW0sXG4gIHBsYXksXG4gIGxvZ0luZm86IGluZm8sXG4gIGxvZ1dhcm5pbmc6IHdhcm5pbmcsXG4gIGxvZ0Vycm9yOiBlcnJvcixcbn1cblxuY29uc3QgYyA9IGNvbm5lY3QobWFwU3RhdGVUb1Byb3BzLCBtYXBEaXNwYXRjaFRvUHJvcHMpXG5cbmV4cG9ydCBjbGFzcyBNZWRpYUZvcm0gZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PE1lZGlhUHJvcHM+IHtcbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgdGhpcy5wcm9wcy5lbnVtZXJhdGVEZXZpY2VzKClcbiAgfVxuICBoYW5kbGVTdWJtaXQgPSBhc3luYyAoZXZlbnQ6IFJlYWN0LkZvcm1FdmVudDxIVE1MRm9ybUVsZW1lbnQ+KSA9PiB7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuICAgIGNvbnN0IHsgcHJvcHMgfSA9IHRoaXNcbiAgICBjb25zdCB7IGF1ZGlvLCB2aWRlbyB9ID0gcHJvcHNcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcHJvcHMuZ2V0TWVkaWFTdHJlYW0oeyBhdWRpbywgdmlkZW8gfSlcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHByb3BzLmxvZ0Vycm9yKCdFcnJvciBnZXR0aW5nIG1lZGlhIHN0cmVhbTogezB9JywgZXJyKVxuICAgIH1cblxuICAgIHByb3BzLmxvZ0luZm8oJ0RpYWxsaW5nLi4uJylcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcHJvcHMuZGlhbCgpXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBwcm9wcy5sb2dFcnJvcignRXJyb3IgZGlhbGxpbmc6IHswfScsIGVycilcbiAgICB9XG4gIH1cbiAgaGFuZGxlVmlkZW9DaGFuZ2UgPSAoZXZlbnQ6IFJlYWN0LkNoYW5nZUV2ZW50PEhUTUxTZWxlY3RFbGVtZW50PikgPT4ge1xuICAgIGNvbnN0IGNvbnN0cmFpbnQ6IFZpZGVvQ29uc3RyYWludCA9IEpTT04ucGFyc2UoZXZlbnQudGFyZ2V0LnZhbHVlKVxuICAgIHRoaXMucHJvcHMub25TZXRWaWRlb0NvbnN0cmFpbnQoY29uc3RyYWludClcbiAgfVxuXG4gIGhhbmRsZUF1ZGlvQ2hhbmdlID0gKGV2ZW50OiBSZWFjdC5DaGFuZ2VFdmVudDxIVE1MU2VsZWN0RWxlbWVudD4pID0+IHtcbiAgICBjb25zdCBjb25zdHJhaW50OiBBdWRpb0NvbnN0cmFpbnQgPSBKU09OLnBhcnNlKGV2ZW50LnRhcmdldC52YWx1ZSlcbiAgICB0aGlzLnByb3BzLm9uU2V0QXVkaW9Db25zdHJhaW50KGNvbnN0cmFpbnQpXG4gIH1cblxuICBoYW5kbGVOaWNrbmFtZUNoYW5nZSA9IChldmVudDogUmVhY3QuQ2hhbmdlRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHtcbiAgICB0aGlzLnByb3BzLm9uU2V0Tmlja25hbWUoe1xuICAgICAgbmlja25hbWU6IGV2ZW50LnRhcmdldC52YWx1ZSxcbiAgICAgIHVzZXJJZDogTUUsXG4gICAgfSlcbiAgfVxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpc1xuICAgIGlmICghcHJvcHMudmlzaWJsZSkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBjb25zdCB2aWRlb0lkID0gSlNPTi5zdHJpbmdpZnkocHJvcHMudmlkZW8pXG4gICAgY29uc3QgYXVkaW9JZCA9IEpTT04uc3RyaW5naWZ5KHByb3BzLmF1ZGlvKVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxmb3JtIGNsYXNzTmFtZT0nbWVkaWEnIG9uU3VibWl0PXt0aGlzLmhhbmRsZVN1Ym1pdH0+XG4gICAgICAgIDxpbnB1dFxuICAgICAgICAgIHJlcXVpcmVkXG4gICAgICAgICAgbmFtZT0nbmlja25hbWUnXG4gICAgICAgICAgdHlwZT0ndGV4dCdcbiAgICAgICAgICBwbGFjZWhvbGRlcj0nTmlja25hbWUnXG4gICAgICAgICAgb25DaGFuZ2U9e3RoaXMuaGFuZGxlTmlja25hbWVDaGFuZ2V9XG4gICAgICAgICAgdmFsdWU9e3Byb3BzLm5pY2tuYW1lfVxuICAgICAgICAvPlxuXG4gICAgICAgIDxzZWxlY3RcbiAgICAgICAgICBuYW1lPSd2aWRlby1pbnB1dCdcbiAgICAgICAgICBvbkNoYW5nZT17dGhpcy5oYW5kbGVWaWRlb0NoYW5nZX1cbiAgICAgICAgICB2YWx1ZT17dmlkZW9JZH1cbiAgICAgICAgPlxuICAgICAgICAgIDxPcHRpb25zXG4gICAgICAgICAgICBkZXZpY2VzPXtwcm9wcy5kZXZpY2VzfVxuICAgICAgICAgICAgZGVmYXVsdD0ne1wiZmFjaW5nTW9kZVwiOlwidXNlclwifSdcbiAgICAgICAgICAgIHR5cGU9J3ZpZGVvaW5wdXQnXG4gICAgICAgICAgLz5cbiAgICAgICAgPC9zZWxlY3Q+XG5cbiAgICAgICAgPHNlbGVjdFxuICAgICAgICAgIG5hbWU9J2F1ZGlvLWlucHV0J1xuICAgICAgICAgIG9uQ2hhbmdlPXt0aGlzLmhhbmRsZUF1ZGlvQ2hhbmdlfVxuICAgICAgICAgIHZhbHVlPXthdWRpb0lkfVxuICAgICAgICA+XG4gICAgICAgICAgPE9wdGlvbnNcbiAgICAgICAgICAgIGRldmljZXM9e3Byb3BzLmRldmljZXN9XG4gICAgICAgICAgICBkZWZhdWx0PSd0cnVlJ1xuICAgICAgICAgICAgdHlwZT0nYXVkaW9pbnB1dCdcbiAgICAgICAgICAvPlxuICAgICAgICA8L3NlbGVjdD5cblxuICAgICAgICA8YnV0dG9uIHR5cGU9J3N1Ym1pdCc+XG4gICAgICAgICAgSm9pbiBDYWxsXG4gICAgICAgIDwvYnV0dG9uPlxuICAgICAgPC9mb3JtPlxuICAgIClcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dG9wbGF5UHJvcHMge1xuICBwbGF5OiAoKSA9PiB2b2lkXG59XG5cbmV4cG9ydCBjb25zdCBBdXRvcGxheU1lc3NhZ2UgPSBSZWFjdC5tZW1vKFxuICBmdW5jdGlvbiBBdXRvcGxheShwcm9wczogQXV0b3BsYXlQcm9wcykge1xuICAgIHJldHVybiAoXG4gICAgICA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICAgIFlvdXIgYnJvd3NlciBoYXMgYmxvY2tlZCB2aWRlbyBhdXRvcGxheSBvbiB0aGlzIHBhZ2UuXG4gICAgICAgIFRvIGNvbnRpbnVlIHdpdGggeW91ciBjYWxsLCBwbGVhc2UgcHJlc3MgdGhlIHBsYXkgYnV0dG9uOlxuICAgICAgICAmbmJzcDtcbiAgICAgICAgPGJ1dHRvbiBjbGFzc05hbWU9J2J1dHRvbicgb25DbGljaz17cHJvcHMucGxheX0+XG4gICAgICAgICAgUGxheVxuICAgICAgICA8L2J1dHRvbj5cbiAgICAgIDwvUmVhY3QuRnJhZ21lbnQ+XG4gICAgKVxuICB9LFxuKVxuXG5leHBvcnQgY29uc3QgTWVkaWEgPSBjKFJlYWN0Lm1lbW8oZnVuY3Rpb24gTWVkaWEocHJvcHM6IE1lZGlhUHJvcHMpIHtcbiAgcmV0dXJuIChcbiAgICA8ZGl2IGNsYXNzTmFtZT0nbWVkaWEtY29udGFpbmVyJz5cbiAgICAgIDxBbGVydHM+XG4gICAgICAgIHtwcm9wcy5hdXRvcGxheUVycm9yICYmIChcbiAgICAgICAgICA8QWxlcnQ+XG4gICAgICAgICAgICA8QXV0b3BsYXlNZXNzYWdlIHBsYXk9e3Byb3BzLnBsYXl9IC8+XG4gICAgICAgICAgPC9BbGVydD5cbiAgICAgICAgKX1cbiAgICAgIDwvQWxlcnRzPlxuXG4gICAgICA8TWVkaWFGb3JtIHsuLi5wcm9wc30gLz5cbiAgICA8L2Rpdj5cbiAgKVxufSkpXG5cbmludGVyZmFjZSBPcHRpb25zUHJvcHMge1xuICBkZXZpY2VzOiBNZWRpYURldmljZVtdXG4gIHR5cGU6ICdhdWRpb2lucHV0JyB8ICd2aWRlb2lucHV0J1xuICBkZWZhdWx0OiBzdHJpbmdcbn1cblxuY29uc3QgbGFiZWxzID0ge1xuICBhdWRpb2lucHV0OiAnQXVkaW8nLFxuICB2aWRlb2lucHV0OiAnVmlkZW8nLFxufVxuXG5mdW5jdGlvbiBPcHRpb25zKHByb3BzOiBPcHRpb25zUHJvcHMpIHtcbiAgY29uc3QgbGFiZWwgPSBsYWJlbHNbcHJvcHMudHlwZV1cbiAgcmV0dXJuIChcbiAgICA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICA8b3B0aW9uIHZhbHVlPSdmYWxzZSc+Tm8ge2xhYmVsfTwvb3B0aW9uPlxuICAgICAgPG9wdGlvbiB2YWx1ZT17cHJvcHMuZGVmYXVsdH0+RGVmYXVsdCB7bGFiZWx9PC9vcHRpb24+XG4gICAgICB7XG4gICAgICAgIHByb3BzLmRldmljZXNcbiAgICAgICAgLmZpbHRlcihkZXZpY2UgPT4gZGV2aWNlLnR5cGUgPT09IHByb3BzLnR5cGUpXG4gICAgICAgIC5tYXAoZGV2aWNlID0+XG4gICAgICAgICAgPG9wdGlvblxuICAgICAgICAgICAga2V5PXtkZXZpY2UuaWR9XG4gICAgICAgICAgICB2YWx1ZT17SlNPTi5zdHJpbmdpZnkoe2RldmljZUlkOiBkZXZpY2UuaWR9KX1cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7ZGV2aWNlLm5hbWUgfHwgZGV2aWNlLnR5cGV9XG4gICAgICAgICAgPC9vcHRpb24+LFxuICAgICAgICApXG4gICAgICB9XG4gICAgPC9SZWFjdC5GcmFnbWVudD5cbiAgKVxufVxuIl19