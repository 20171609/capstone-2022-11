"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
exports.__esModule = true;
jest.mock('../actions/CallActions');
jest.mock('../socket');
jest.mock('../window');
jest.useFakeTimers();
var react_1 = __importDefault(require("react"));
var react_dom_1 = __importDefault(require("react-dom"));
var test_utils_1 = __importDefault(require("react-dom/test-utils"));
var react_redux_1 = require("react-redux");
var redux_1 = require("redux");
var CallActions_1 = require("../actions/CallActions");
var constants = __importStar(require("../constants"));
var reducers_1 = __importDefault(require("../reducers"));
var store_1 = require("../store");
var window_1 = require("../window");
var App_1 = __importDefault(require("./App"));
describe('App', function () {
    var initAction = { type: 'INIT' };
    var store;
    var state;
    var dispatchSpy;
    beforeEach(function () {
        state = {};
        CallActions_1.init.mockReturnValue(initAction);
        window.HTMLMediaElement.prototype.play = jest.fn();
    });
    afterEach(function () {
        if (dispatchSpy) {
            dispatchSpy.mockReset();
            dispatchSpy.mockRestore();
        }
    });
    var node;
    function render() {
        return __awaiter(this, void 0, void 0, function () {
            var div;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        store = redux_1.createStore(reducers_1["default"], state, redux_1.applyMiddleware.apply(void 0, store_1.middlewares));
                        dispatchSpy = jest.spyOn(store, 'dispatch');
                        div = document.createElement('div');
                        return [4 /*yield*/, new Promise(function (resolve) {
                                react_dom_1["default"].render(react_1["default"].createElement(react_redux_1.Provider, { store: store },
                                    react_1["default"].createElement("div", { ref: function (div) { return resolve(div); } },
                                        react_1["default"].createElement(App_1["default"], null))), div);
                            })];
                    case 1:
                        node = _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    }
    describe('render', function () {
        it('renders without issues', function () { return __awaiter(void 0, void 0, void 0, function () {
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, render()];
                    case 1:
                        _a.sent();
                        expect(node).toBeTruthy();
                        expect(CallActions_1.init.mock.calls.length).toBe(1);
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('chat toggle', function () {
        it('toggles chat state', function () { return __awaiter(void 0, void 0, void 0, function () {
            var chatButton;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, render()];
                    case 1:
                        _a.sent();
                        chatButton = node.querySelector('.toolbar .button.chat');
                        expect(chatButton).toBeTruthy();
                        test_utils_1["default"].Simulate.click(chatButton);
                        test_utils_1["default"].Simulate.click(chatButton);
                        return [2 /*return*/];
                }
            });
        }); });
    });
    describe('state', function () {
        beforeEach(function () { return __awaiter(void 0, void 0, void 0, function () {
            var _a;
            return __generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        state.streams = (_a = {},
                            _a[constants.ME] = {
                                userId: constants.ME,
                                streams: [{
                                        stream: new window_1.MediaStream(),
                                        type: constants.STREAM_TYPE_CAMERA,
                                        url: 'blob://'
                                    }]
                            },
                            _a['other-user'] = {
                                userId: 'other-user',
                                streams: [{
                                        stream: new window_1.MediaStream(),
                                        type: undefined,
                                        url: 'blob://'
                                    }]
                            },
                            _a);
                        state.peers = {
                            'other-user': {}
                        };
                        state.notifications = {
                            'notification1': {
                                id: 'notification1',
                                message: 'test',
                                type: 'warning'
                            }
                        };
                        return [4 /*yield*/, render()];
                    case 1:
                        _b.sent();
                        return [2 /*return*/];
                }
            });
        }); });
        describe('video', function () {
            beforeEach(function () {
                dispatchSpy.mockClear();
            });
            it('forces play on click', function () {
                var video = node.querySelector('video');
                test_utils_1["default"].Simulate.mouseDown(video);
                test_utils_1["default"].Simulate.mouseUp(video);
                test_utils_1["default"].Simulate.click(video);
                expect(dispatchSpy.mock.calls[0][0].type).toBe(constants.MEDIA_PLAY);
            });
        });
        describe('video menu', function () {
            beforeEach(function () {
                dispatchSpy.mockClear();
            });
            it('minimizes the video on "Maximize" click', function () {
                var minimized = node.querySelectorAll('.videos-toolbar video');
                expect(minimized.length).toBe(0);
                var maximized = node.querySelectorAll('.videos-grid video');
                expect(maximized.length).toBe(2);
                var item = node.querySelector('.dropdown .action-minimize');
                expect(item).toBeTruthy();
                test_utils_1["default"].Simulate.click(item);
                expect(dispatchSpy.mock.calls).toEqual([[{
                            type: constants.MINIMIZE_TOGGLE,
                            payload: {
                                userId: constants.ME,
                                streamId: store.getState()
                                    .streams[constants.ME].streams[0].stream.id
                            }
                        }]]);
                minimized = node.querySelectorAll('.videos-toolbar video');
                expect(minimized.length).toBe(1);
                maximized = node.querySelectorAll('.videos-grid video');
                expect(maximized.length).toBe(1);
            });
            it('toggles object-fit on "Toggle Fit" click', function () {
                ['contain', ''].forEach(function (objectFit) {
                    var item = node.querySelector('.dropdown .action-toggle-fit');
                    expect(item).toBeTruthy();
                    test_utils_1["default"].Simulate.click(item);
                    var video = node.querySelector('video');
                    expect((video).style.objectFit).toBe(objectFit);
                    expect(dispatchSpy.mock.calls).toEqual([]);
                });
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2xpZW50L2NvbnRhaW5lcnMvQXBwLnRlc3QudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtBQUNuQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDdEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO0FBRXBCLGdEQUF5QjtBQUN6Qix3REFBZ0M7QUFDaEMsb0VBQTRDO0FBQzVDLDJDQUFzQztBQUN0QywrQkFBK0Q7QUFDL0Qsc0RBQTZDO0FBQzdDLHNEQUF5QztBQUN6Qyx5REFBa0M7QUFDbEMsa0NBQW9EO0FBQ3BELG9DQUF1QztBQUN2Qyw4Q0FBdUI7QUFFdkIsUUFBUSxDQUFDLEtBQUssRUFBRTtJQUVkLElBQU0sVUFBVSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFBO0lBRW5DLElBQUksS0FBWSxDQUFBO0lBQ2hCLElBQUksS0FBcUIsQ0FBQTtJQUN6QixJQUFJLFdBQXFELENBQUE7SUFDekQsVUFBVSxDQUFDO1FBQ1QsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNWLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUUvQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUE7SUFDcEQsQ0FBQyxDQUFDLENBQUE7SUFFRixTQUFTLENBQUM7UUFDUixJQUFJLFdBQVcsRUFBRTtZQUNmLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtZQUN2QixXQUFXLENBQUMsV0FBVyxFQUFFLENBQUE7U0FDMUI7SUFD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VUFBVSxFQUFFLENBQUE7b0JBQ3pCLHVCQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtvQkFDOUIsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQXNCLENBQUE7b0JBQzlELE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7b0JBQy9DLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDNUMsQ0FBQyxDQUFDLENBQUE7WUFDSixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBRUosQ0FBQyxDQUFDLENBQUE7QUFFSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImplc3QubW9jaygnLi4vYWN0aW9ucy9DYWxsQWN0aW9ucycpXG5qZXN0Lm1vY2soJy4uL3NvY2tldCcpXG5qZXN0Lm1vY2soJy4uL3dpbmRvdycpXG5qZXN0LnVzZUZha2VUaW1lcnMoKVxuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJ1xuaW1wb3J0IFRlc3RVdGlscyBmcm9tICdyZWFjdC1kb20vdGVzdC11dGlscydcbmltcG9ydCB7IFByb3ZpZGVyIH0gZnJvbSAncmVhY3QtcmVkdXgnXG5pbXBvcnQgeyBBbnlBY3Rpb24sIGFwcGx5TWlkZGxld2FyZSwgY3JlYXRlU3RvcmUgfSBmcm9tICdyZWR1eCdcbmltcG9ydCB7IGluaXQgfSBmcm9tICcuLi9hY3Rpb25zL0NhbGxBY3Rpb25zJ1xuaW1wb3J0ICogYXMgY29uc3RhbnRzIGZyb20gJy4uL2NvbnN0YW50cydcbmltcG9ydCByZWR1Y2VycyBmcm9tICcuLi9yZWR1Y2VycydcbmltcG9ydCB7IG1pZGRsZXdhcmVzLCBTdGF0ZSwgU3RvcmUgfSBmcm9tICcuLi9zdG9yZSdcbmltcG9ydCB7IE1lZGlhU3RyZWFtIH0gZnJvbSAnLi4vd2luZG93J1xuaW1wb3J0IEFwcCBmcm9tICcuL0FwcCdcblxuZGVzY3JpYmUoJ0FwcCcsICgpID0+IHtcblxuICBjb25zdCBpbml0QWN0aW9uID0geyB0eXBlOiAnSU5JVCcgfVxuXG4gIGxldCBzdG9yZTogU3RvcmVcbiAgbGV0IHN0YXRlOiBQYXJ0aWFsPFN0YXRlPlxuICBsZXQgZGlzcGF0Y2hTcHk6IGplc3QuU3B5SW5zdGFuY2U8QW55QWN0aW9uLCBBbnlBY3Rpb25bXT5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgc3RhdGUgPSB7fTtcbiAgICAoaW5pdCBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZShpbml0QWN0aW9uKVxuXG4gICAgd2luZG93LkhUTUxNZWRpYUVsZW1lbnQucHJvdG90eXBlLnBsYXkgPSBqZXN0LmZuKClcbiAgfSlcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGlmIChkaXNwYXRjaFNweSkge1xuICAgICAgZGlzcGF0Y2hTcHkubW9ja1Jlc2V0KClcbiAgICAgIGRpc3BhdGNoU3B5Lm1vY2tSZXN0b3JlKClcbiAgICB9XG4gIH0pXG5cbiAgbGV0IG5vZGU6IEVsZW1lbnRcbiAgYXN5bmMgZnVuY3Rpb24gcmVuZGVyICgpIHtcbiAgICBzdG9yZSA9IGNyZWF0ZVN0b3JlKFxuICAgICAgcmVkdWNlcnMsXG4gICAgICBzdGF0ZSxcbiAgICAgIGFwcGx5TWlkZGxld2FyZSguLi5taWRkbGV3YXJlcyksXG4gICAgKVxuICAgIGRpc3BhdGNoU3B5ID0gamVzdC5zcHlPbihzdG9yZSwgJ2Rpc3BhdGNoJylcbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIG5vZGUgPSBhd2FpdCBuZXcgUHJvbWlzZTxIVE1MRGl2RWxlbWVudD4ocmVzb2x2ZSA9PiB7XG4gICAgICBSZWFjdERPTS5yZW5kZXIoXG4gICAgICAgIDxQcm92aWRlciBzdG9yZT17c3RvcmV9PlxuICAgICAgICAgIDxkaXYgcmVmPXtkaXYgPT4gcmVzb2x2ZShkaXYhKX0+XG4gICAgICAgICAgICA8QXBwIC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvUHJvdmlkZXI+LFxuICAgICAgICBkaXYsXG4gICAgICApXG4gICAgfSlcbiAgfVxuXG4gIGRlc2NyaWJlKCdyZW5kZXInLCAoKSA9PiB7XG4gICAgaXQoJ3JlbmRlcnMgd2l0aG91dCBpc3N1ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCByZW5kZXIoKVxuICAgICAgZXhwZWN0KG5vZGUpLnRvQmVUcnV0aHkoKVxuICAgICAgZXhwZWN0KChpbml0IGFzIGplc3QuTW9jaykubW9jay5jYWxscy5sZW5ndGgpLnRvQmUoMSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdjaGF0IHRvZ2dsZScsICgpID0+IHtcbiAgICBpdCgndG9nZ2xlcyBjaGF0IHN0YXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgcmVuZGVyKClcbiAgICAgIGNvbnN0IGNoYXRCdXR0b24gPSBub2RlLnF1ZXJ5U2VsZWN0b3IoJy50b29sYmFyIC5idXR0b24uY2hhdCcpIVxuICAgICAgZXhwZWN0KGNoYXRCdXR0b24pLnRvQmVUcnV0aHkoKVxuICAgICAgVGVzdFV0aWxzLlNpbXVsYXRlLmNsaWNrKGNoYXRCdXR0b24pXG4gICAgICBUZXN0VXRpbHMuU2ltdWxhdGUuY2xpY2soY2hhdEJ1dHRvbilcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdzdGF0ZScsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgIHN0YXRlLnN0cmVhbXMgPSB7XG4gICAgICAgIFtjb25zdGFudHMuTUVdOiB7XG4gICAgICAgICAgdXNlcklkOiBjb25zdGFudHMuTUUsXG4gICAgICAgICAgc3RyZWFtczogW3tcbiAgICAgICAgICAgIHN0cmVhbTogbmV3IE1lZGlhU3RyZWFtKCksXG4gICAgICAgICAgICB0eXBlOiBjb25zdGFudHMuU1RSRUFNX1RZUEVfQ0FNRVJBLFxuICAgICAgICAgICAgdXJsOiAnYmxvYjovLycsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0sXG4gICAgICAgICdvdGhlci11c2VyJzoge1xuICAgICAgICAgIHVzZXJJZDogJ290aGVyLXVzZXInLFxuICAgICAgICAgIHN0cmVhbXM6IFt7XG4gICAgICAgICAgICBzdHJlYW06IG5ldyBNZWRpYVN0cmVhbSgpLFxuICAgICAgICAgICAgdHlwZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgdXJsOiAnYmxvYjovLycsXG4gICAgICAgICAgfV0sXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgICBzdGF0ZS5wZWVycyA9IHtcbiAgICAgICAgJ290aGVyLXVzZXInOiB7fSBhcyBhbnksXG4gICAgICB9XG4gICAgICBzdGF0ZS5ub3RpZmljYXRpb25zID0ge1xuICAgICAgICAnbm90aWZpY2F0aW9uMSc6IHtcbiAgICAgICAgICBpZDogJ25vdGlmaWNhdGlvbjEnLFxuICAgICAgICAgIG1lc3NhZ2U6ICd0ZXN0JyxcbiAgICAgICAgICB0eXBlOiAnd2FybmluZycsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgICBhd2FpdCByZW5kZXIoKVxuICAgIH0pXG5cbiAgICBkZXNjcmliZSgndmlkZW8nLCAoKSA9PiB7XG4gICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgZGlzcGF0Y2hTcHkubW9ja0NsZWFyKClcbiAgICAgIH0pXG5cbiAgICAgIGl0KCdmb3JjZXMgcGxheSBvbiBjbGljaycsICgpID0+IHtcbiAgICAgICAgY29uc3QgdmlkZW8gPSBub2RlLnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJykhXG4gICAgICAgIFRlc3RVdGlscy5TaW11bGF0ZS5tb3VzZURvd24odmlkZW8pXG4gICAgICAgIFRlc3RVdGlscy5TaW11bGF0ZS5tb3VzZVVwKHZpZGVvKVxuICAgICAgICBUZXN0VXRpbHMuU2ltdWxhdGUuY2xpY2sodmlkZW8pXG4gICAgICAgIGV4cGVjdChkaXNwYXRjaFNweS5tb2NrLmNhbGxzWzBdWzBdLnR5cGUpLnRvQmUoY29uc3RhbnRzLk1FRElBX1BMQVkpXG4gICAgICB9KVxuXG4gICAgfSlcblxuICAgIGRlc2NyaWJlKCd2aWRlbyBtZW51JywgKCkgPT4ge1xuICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIGRpc3BhdGNoU3B5Lm1vY2tDbGVhcigpXG4gICAgICB9KVxuXG4gICAgICBpdCgnbWluaW1pemVzIHRoZSB2aWRlbyBvbiBcIk1heGltaXplXCIgY2xpY2snLCAoKSA9PiB7XG4gICAgICAgIGxldCBtaW5pbWl6ZWQgPSBub2RlLnF1ZXJ5U2VsZWN0b3JBbGwoJy52aWRlb3MtdG9vbGJhciB2aWRlbycpXG4gICAgICAgIGV4cGVjdChtaW5pbWl6ZWQubGVuZ3RoKS50b0JlKDApXG4gICAgICAgIGxldCBtYXhpbWl6ZWQgPSBub2RlLnF1ZXJ5U2VsZWN0b3JBbGwoJy52aWRlb3MtZ3JpZCB2aWRlbycpXG4gICAgICAgIGV4cGVjdChtYXhpbWl6ZWQubGVuZ3RoKS50b0JlKDIpXG5cbiAgICAgICAgY29uc3QgaXRlbSA9IG5vZGUucXVlcnlTZWxlY3RvcignLmRyb3Bkb3duIC5hY3Rpb24tbWluaW1pemUnKSFcbiAgICAgICAgZXhwZWN0KGl0ZW0pLnRvQmVUcnV0aHkoKVxuICAgICAgICBUZXN0VXRpbHMuU2ltdWxhdGUuY2xpY2soaXRlbSlcbiAgICAgICAgZXhwZWN0KGRpc3BhdGNoU3B5Lm1vY2suY2FsbHMpLnRvRXF1YWwoW1t7XG4gICAgICAgICAgdHlwZTogY29uc3RhbnRzLk1JTklNSVpFX1RPR0dMRSxcbiAgICAgICAgICBwYXlsb2FkOiB7XG4gICAgICAgICAgICB1c2VySWQ6IGNvbnN0YW50cy5NRSxcbiAgICAgICAgICAgIHN0cmVhbUlkOiBzdG9yZS5nZXRTdGF0ZSgpXG4gICAgICAgICAgICAuc3RyZWFtcyFbY29uc3RhbnRzLk1FXS5zdHJlYW1zWzBdLnN0cmVhbS5pZCxcbiAgICAgICAgICB9LFxuICAgICAgICB9XV0pXG5cbiAgICAgICAgbWluaW1pemVkID0gbm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcudmlkZW9zLXRvb2xiYXIgdmlkZW8nKVxuICAgICAgICBleHBlY3QobWluaW1pemVkLmxlbmd0aCkudG9CZSgxKVxuICAgICAgICBtYXhpbWl6ZWQgPSBub2RlLnF1ZXJ5U2VsZWN0b3JBbGwoJy52aWRlb3MtZ3JpZCB2aWRlbycpXG4gICAgICAgIGV4cGVjdChtYXhpbWl6ZWQubGVuZ3RoKS50b0JlKDEpXG4gICAgICB9KVxuXG4gICAgICBpdCgndG9nZ2xlcyBvYmplY3QtZml0IG9uIFwiVG9nZ2xlIEZpdFwiIGNsaWNrJywgKCkgPT4ge1xuICAgICAgICBbJ2NvbnRhaW4nLCAnJ10uZm9yRWFjaChvYmplY3RGaXQgPT4ge1xuICAgICAgICAgIGNvbnN0IGl0ZW0gPSBub2RlLnF1ZXJ5U2VsZWN0b3IoJy5kcm9wZG93biAuYWN0aW9uLXRvZ2dsZS1maXQnKSFcbiAgICAgICAgICBleHBlY3QoaXRlbSkudG9CZVRydXRoeSgpXG4gICAgICAgICAgVGVzdFV0aWxzLlNpbXVsYXRlLmNsaWNrKGl0ZW0pXG4gICAgICAgICAgY29uc3QgdmlkZW8gPSBub2RlLnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJykhIGFzIEhUTUxWaWRlb0VsZW1lbnRcbiAgICAgICAgICBleHBlY3QoKHZpZGVvKS5zdHlsZS5vYmplY3RGaXQpLnRvQmUob2JqZWN0Rml0KVxuICAgICAgICAgIGV4cGVjdChkaXNwYXRjaFNweS5tb2NrLmNhbGxzKS50b0VxdWFsKFtdKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9KVxuXG4gIH0pXG5cbn0pXG4iXX0=