"use strict";
var __spreadArrays = (this && this.__spreadArrays) || function () {
    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;
    for (var r = Array(s), k = 0, i = 0; i < il; i++)
        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)
            r[k] = a[j];
    return r;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
exports.__esModule = true;
/* eslint @typescript-eslint/no-explicit-any: 0 */
var fs_1 = require("fs");
var path_1 = require("path");
var js_yaml_1 = require("js-yaml");
var debug_1 = __importDefault(require("debug"));
var debug = debug_1["default"]('peercalls:config');
var isObject = function (value) { return value !== null && typeof value === 'object'; };
var ReadConfig = /** @class */ (function () {
    function ReadConfig(config) {
        this.config = config;
    }
    ReadConfig.prototype.get = function (key, defaultValue) {
        var value = this.config;
        try {
            key.split('.').forEach(function (k) {
                if (!Object.prototype.hasOwnProperty.call(value, k)) {
                    throw new Error("Property \"" + k + "\" from \"" + key + "\" does not exist");
                }
                value = value[k];
            });
        }
        catch (err) {
            if (arguments.length === 2) {
                return defaultValue;
            }
            else {
                throw err;
            }
        }
        return value;
    };
    ReadConfig.prototype.has = function (key) {
        var c = this.config;
        return key.split('.').every(function (k) {
            var has = Object.prototype.hasOwnProperty.call(c, k);
            if (has) {
                c = c[k];
            }
            return has;
        });
    };
    ReadConfig.prototype.value = function () {
        return this.config;
    };
    return ReadConfig;
}());
exports.ReadConfig = ReadConfig;
function readConfigFile(filename) {
    return js_yaml_1.safeLoad(fs_1.readFileSync(filename, 'utf8'));
}
function mergeConfig(source, destination) {
    var stack = [{ src: source, dest: destination }];
    var _loop_1 = function () {
        var _a = stack.pop(), src = _a.src, dest = _a.dest;
        var keys = Object.keys(src);
        keys.forEach(function (key) {
            var value = src[key];
            if (isObject(value) && !Array.isArray(value)) {
                if (!Object.prototype.hasOwnProperty.call(dest, key) ||
                    Array.isArray(dest[key]) ||
                    !isObject(dest[key])) {
                    dest[key] = {};
                }
                stack.push({ src: value, dest: dest[key] });
                return;
            }
            dest[key] = value;
        });
    };
    while (stack.length) {
        _loop_1();
    }
    return destination;
}
exports.mergeConfig = mergeConfig;
function findPackageRoot(path) {
    if (path === void 0) { path = __dirname; }
    path = path_1.resolve(path);
    var lastPath;
    while (lastPath !== path) {
        var file = path_1.join(path, 'package.json');
        try {
            var result = fs_1.statSync(file);
            if (result.isFile()) {
                return path;
            }
        }
        catch (err) {
            // ignore error
        }
        lastPath = path;
        path = path_1.join(path, '..');
    }
    throw new Error('No package.json found');
}
exports.findPackageRoot = findPackageRoot;
function getAllConfigFilesInDirectory(dir, environment) {
    var files = [path_1.join(dir, 'default.yaml')];
    if (environment) {
        files.push(path_1.join(dir, environment + '.yaml'));
    }
    files.push(path_1.join(dir, 'local.yaml'));
    return files;
}
exports.getAllConfigFilesInDirectory = getAllConfigFilesInDirectory;
function getAllConfigLocations(packageDir, localDir, environment, extraConfigFile) {
    var locations = __spreadArrays(getAllConfigFilesInDirectory(packageDir, environment));
    if (localDir !== packageDir) {
        locations.push.apply(locations, getAllConfigFilesInDirectory(localDir, environment));
    }
    if (extraConfigFile && locations.every(function (loc) { return loc !== extraConfigFile; })) {
        locations.push(path_1.resolve(extraConfigFile));
    }
    return locations;
}
exports.getAllConfigLocations = getAllConfigLocations;
function toSnakeCase(string) {
    var value = string.split('_')
        .map(function (item) { return item[0].toUpperCase() + item.slice(1).toLowerCase(); })
        .join('');
    return value[0].toLowerCase() + value.slice(1);
}
exports.toSnakeCase = toSnakeCase;
function readConfig(env, packageDir, localDir, extraConfigFile) {
    if (env === void 0) { env = process.env; }
    if (packageDir === void 0) { packageDir = path_1.join(findPackageRoot(), 'config'); }
    if (localDir === void 0) { localDir = path_1.join(process.cwd(), 'config'); }
    var locations = getAllConfigLocations(packageDir, localDir, env.NODE_ENV, extraConfigFile);
    var readFiles = locations
        .map(function (location) {
        try {
            var result = readConfigFile(location);
            debug('Read config file: %s', location);
            return result;
        }
        catch (err) {
            if (!/ENOENT/.test(err.message)) {
                throw err;
            }
            return undefined;
        }
    })
        .filter(function (item) { return item !== undefined; });
    var config = readFiles
        .reduce(function (merged, config) { return mergeConfig(config, merged); }, {});
    var envConfig = {};
    Object.keys(env)
        .filter(function (key) { return key.startsWith('PEERCALLS__'); })
        .forEach(function (key) {
        var value = env[key];
        key = key.slice('PEERCALLS__'.length);
        var cfg = envConfig;
        var keys = key.split('__').map(toSnakeCase);
        var lastKey = keys[keys.length - 1];
        keys
            .slice(0, keys.length - 1)
            .forEach(function (shortKey) {
            cfg = cfg[shortKey] = cfg[shortKey] || {};
        });
        try {
            cfg[lastKey] = JSON.parse(value);
        }
        catch (err) {
            cfg[lastKey] = value;
        }
    });
    var configWithEnv = mergeConfig(envConfig, config);
    debug('Read configuration: %j', configWithEnv);
    return new ReadConfig(configWithEnv);
}
exports.readConfig = readConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZENvbmZpZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvcmVhZENvbmZpZy9yZWFkQ29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLGtEQUFrRDtBQUNsRCx5QkFBMkM7QUFDM0MsNkJBQW9DO0FBQ3BDLG1DQUFrQztBQUNsQyxnREFBMEI7QUFFMUIsSUFBTSxLQUFLLEdBQUcsa0JBQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO0FBRXhDLElBQU0sUUFBUSxHQUFHLFVBQUMsS0FBYyxJQUFLLE9BQUEsS0FBSyxLQUFLLElBQUksSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQTNDLENBQTJDLENBQUE7QUFFaEY7SUFDRSxvQkFBK0IsTUFBVztRQUFYLFdBQU0sR0FBTixNQUFNLENBQUs7SUFBRyxDQUFDO0lBRTlDLHdCQUFHLEdBQUgsVUFBSSxHQUFXLEVBQUUsWUFBa0I7UUFDakMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQTtRQUN2QixJQUFJO1lBQ0YsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDO2dCQUN0QixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRTtvQkFDbkQsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBYSxDQUFDLGtCQUFXLEdBQUcsc0JBQWtCLENBQUMsQ0FBQTtpQkFDaEU7Z0JBQ0QsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNsQixDQUFDLENBQUMsQ0FBQTtTQUNIO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUMxQixPQUFPLFlBQVksQ0FBQTthQUNwQjtpQkFBTTtnQkFDTCxNQUFNLEdBQUcsQ0FB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QUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtRQUMzQyxDQUFDLENBQUMsQ0FBQTtRQUVGLElBQUk7WUFDRixHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQTtTQUNqQztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUssQ0FBQTtTQUNyQjtJQUNILENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUNwRCxLQUFLLENBQUMsd0JBQXdCLEVBQUUsYUFBYSxDQUFDLENBQUE7SUFDOUMsT0FBTyxJQUFJLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUN0QyxDQUFDO0FBcERELGdDQW9EQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55OiAwICovXG5pbXBvcnQgeyByZWFkRmlsZVN5bmMsIHN0YXRTeW5jIH0gZnJvbSAnZnMnXG5pbXBvcnQgeyByZXNvbHZlLCBqb2luIH0gZnJvbSAncGF0aCdcbmltcG9ydCB7IHNhZmVMb2FkIH0gZnJvbSAnanMteWFtbCdcbmltcG9ydCBfZGVidWcgZnJvbSAnZGVidWcnXG5cbmNvbnN0IGRlYnVnID0gX2RlYnVnKCdwZWVyY2FsbHM6Y29uZmlnJylcblxuY29uc3QgaXNPYmplY3QgPSAodmFsdWU6IHVua25vd24pID0+IHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCdcblxuZXhwb3J0IGNsYXNzIFJlYWRDb25maWcge1xuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcmVhZG9ubHkgY29uZmlnOiBhbnkpIHt9XG5cbiAgZ2V0KGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBhbnkpIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLmNvbmZpZ1xuICAgIHRyeSB7XG4gICAgICBrZXkuc3BsaXQoJy4nKS5mb3JFYWNoKGsgPT4ge1xuICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgaykpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3BlcnR5IFwiJHtrfVwiIGZyb20gXCIke2tleX1cIiBkb2VzIG5vdCBleGlzdGApXG4gICAgICAgIH1cbiAgICAgICAgdmFsdWUgPSB2YWx1ZVtrXVxuICAgICAgfSlcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWVcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVyclxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdmFsdWVcbiAgfVxuXG4gIGhhcyhrZXk6IHN0cmluZykge1xuICAgIGxldCBjID0gdGhpcy5jb25maWdcbiAgICByZXR1cm4ga2V5LnNwbGl0KCcuJykuZXZlcnkoayA9PiB7XG4gICAgICBjb25zdCBoYXMgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYywgaylcbiAgICAgIGlmIChoYXMpIHtcbiAgICAgICAgYyA9IGNba11cbiAgICAgIH1cbiAgICAgIHJldHVybiBoYXNcbiAgICB9KVxuICB9XG5cbiAgdmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnXG4gIH1cblxufVxuXG5mdW5jdGlvbiByZWFkQ29uZmlnRmlsZShmaWxlbmFtZTogc3RyaW5nKTogYW55IHtcbiAgcmV0dXJuIHNhZmVMb2FkKHJlYWRGaWxlU3luYyhmaWxlbmFtZSwgJ3V0ZjgnKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlQ29uZmlnKHNvdXJjZTogYW55LCBkZXN0aW5hdGlvbjogYW55KTogYW55IHtcbiAgY29uc3Qgc3RhY2sgPSBbe3NyYzogc291cmNlLCBkZXN0OiBkZXN0aW5hdGlvbn1dXG5cbiAgd2hpbGUgKHN0YWNrLmxlbmd0aCkge1xuICAgIGNvbnN0IHtzcmMsIGRlc3R9ID0gc3RhY2sucG9wKCkhXG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHNyYylcblxuICAgIGtleXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBzcmNba2V5XVxuICAgICAgaWYgKGlzT2JqZWN0KHZhbHVlKSAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZGVzdCwga2V5KSB8fFxuICAgICAgICAgIEFycmF5LmlzQXJyYXkoZGVzdFtrZXldKSB8fFxuICAgICAgICAgICFpc09iamVjdChkZXN0W2tleV0pXG4gICAgICAgICkge1xuICAgICAgICAgIGRlc3Rba2V5XSA9IHt9XG4gICAgICAgIH1cbiAgICAgICAgc3RhY2sucHVzaCh7c3JjOiB2YWx1ZSwgZGVzdDogZGVzdFtrZXldfSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBkZXN0W2tleV0gPSB2YWx1ZVxuICAgIH0pXG4gIH1cblxuICByZXR1cm4gZGVzdGluYXRpb25cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRQYWNrYWdlUm9vdChwYXRoID0gX19kaXJuYW1lKTogc3RyaW5nIHtcbiAgcGF0aCA9IHJlc29sdmUocGF0aClcbiAgbGV0IGxhc3RQYXRoOiB1bmRlZmluZWQgfCBzdHJpbmdcbiAgd2hpbGUgKGxhc3RQYXRoICE9PSBwYXRoKSB7XG4gICAgY29uc3QgZmlsZSA9IGpvaW4ocGF0aCwgJ3BhY2thZ2UuanNvbicpXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHN0YXRTeW5jKGZpbGUpXG4gICAgICBpZiAocmVzdWx0LmlzRmlsZSgpKSB7XG4gICAgICAgIHJldHVybiBwYXRoXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZ25vcmUgZXJyb3JcbiAgICB9XG4gICAgbGFzdFBhdGggPSBwYXRoXG4gICAgcGF0aCA9IGpvaW4ocGF0aCwgJy4uJylcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ05vIHBhY2thZ2UuanNvbiBmb3VuZCcpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBbGxDb25maWdGaWxlc0luRGlyZWN0b3J5KFxuICBkaXI6IHN0cmluZyxcbiAgZW52aXJvbm1lbnQ6IHN0cmluZyB8IHVuZGVmaW5lZCxcbik6IHN0cmluZ1tdIHtcbiAgY29uc3QgZmlsZXM6IHN0cmluZ1tdID0gW2pvaW4oZGlyLCAnZGVmYXVsdC55YW1sJyldXG4gIGlmIChlbnZpcm9ubWVudCkge1xuICAgIGZpbGVzLnB1c2goam9pbihkaXIsIGVudmlyb25tZW50ICsgJy55YW1sJykpXG4gIH1cbiAgZmlsZXMucHVzaChqb2luKGRpciwgJ2xvY2FsLnlhbWwnKSlcbiAgcmV0dXJuIGZpbGVzXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBbGxDb25maWdMb2NhdGlvbnMoXG4gIHBhY2thZ2VEaXI6IHN0cmluZyxcbiAgbG9jYWxEaXI6IHN0cmluZyxcbiAgZW52aXJvbm1lbnQ6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgZXh0cmFDb25maWdGaWxlPzogc3RyaW5nLFxuKTogc3RyaW5nW10ge1xuICBjb25zdCBsb2NhdGlvbnM6IHN0cmluZ1tdID0gW1xuICAgIC4uLmdldEFsbENvbmZpZ0ZpbGVzSW5EaXJlY3RvcnkocGFja2FnZURpciwgZW52aXJvbm1lbnQpLFxuICBdXG4gIGlmIChsb2NhbERpciAhPT0gcGFja2FnZURpcikge1xuICAgIGxvY2F0aW9ucy5wdXNoKC4uLmdldEFsbENvbmZpZ0ZpbGVzSW5EaXJlY3RvcnkobG9jYWxEaXIsIGVudmlyb25tZW50KSlcbiAgfVxuICBpZiAoZXh0cmFDb25maWdGaWxlICYmIGxvY2F0aW9ucy5ldmVyeShsb2MgPT4gbG9jICE9PSBleHRyYUNvbmZpZ0ZpbGUpKSB7XG4gICAgbG9jYXRpb25zLnB1c2gocmVzb2x2ZShleHRyYUNvbmZpZ0ZpbGUpKVxuICB9XG4gIHJldHVybiBsb2NhdGlvbnNcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvU25ha2VDYXNlKHN0cmluZzogc3RyaW5nKSB7XG4gIGNvbnN0IHZhbHVlID0gc3RyaW5nLnNwbGl0KCdfJylcbiAgLm1hcChpdGVtID0+IGl0ZW1bMF0udG9VcHBlckNhc2UoKSArIGl0ZW0uc2xpY2UoMSkudG9Mb3dlckNhc2UoKSlcbiAgLmpvaW4oJycpXG4gIHJldHVybiB2YWx1ZVswXS50b0xvd2VyQ2FzZSgpICsgdmFsdWUuc2xpY2UoMSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRDb25maWcoXG4gIGVudiA9IHByb2Nlc3MuZW52LFxuICBwYWNrYWdlRGlyID0gam9pbihmaW5kUGFja2FnZVJvb3QoKSwgJ2NvbmZpZycpLFxuICBsb2NhbERpciA9IGpvaW4ocHJvY2Vzcy5jd2QoKSwgJ2NvbmZpZycpLFxuICBleHRyYUNvbmZpZ0ZpbGU/OiBzdHJpbmcsXG4pIHtcbiAgY29uc3QgbG9jYXRpb25zID0gZ2V0QWxsQ29uZmlnTG9jYXRpb25zKFxuICAgIHBhY2thZ2VEaXIsIGxvY2FsRGlyLCBlbnYuTk9ERV9FTlYsIGV4dHJhQ29uZmlnRmlsZSlcblxuICBjb25zdCByZWFkRmlsZXMgPSBsb2NhdGlvbnNcbiAgLm1hcChsb2NhdGlvbiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJlYWRDb25maWdGaWxlKGxvY2F0aW9uKVxuICAgICAgZGVidWcoJ1JlYWQgY29uZmlnIGZpbGU6ICVzJywgbG9jYXRpb24pXG4gICAgICByZXR1cm4gcmVzdWx0XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoIS9FTk9FTlQvLnRlc3QoZXJyLm1lc3NhZ2UpKSB7XG4gICAgICAgIHRocm93IGVyclxuICAgICAgfVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgfSlcbiAgLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IHVuZGVmaW5lZClcblxuICBjb25zdCBjb25maWcgPSByZWFkRmlsZXNcbiAgLnJlZHVjZSgobWVyZ2VkLCBjb25maWcpID0+IG1lcmdlQ29uZmlnKGNvbmZpZywgbWVyZ2VkKSwge30pXG5cbiAgY29uc3QgZW52Q29uZmlnOiBhbnkgPSB7fVxuICBPYmplY3Qua2V5cyhlbnYpXG4gIC5maWx0ZXIoa2V5ID0+IGtleS5zdGFydHNXaXRoKCdQRUVSQ0FMTFNfXycpKVxuICAuZm9yRWFjaChrZXkgPT4ge1xuICAgIGNvbnN0IHZhbHVlID0gZW52W2tleV0hXG4gICAga2V5ID0ga2V5LnNsaWNlKCdQRUVSQ0FMTFNfXycubGVuZ3RoKVxuICAgIGxldCBjZmcgPSBlbnZDb25maWdcbiAgICBjb25zdCBrZXlzID0ga2V5LnNwbGl0KCdfXycpLm1hcCh0b1NuYWtlQ2FzZSlcbiAgICBjb25zdCBsYXN0S2V5ID0ga2V5c1trZXlzLmxlbmd0aCAtIDFdXG4gICAga2V5c1xuICAgIC5zbGljZSgwLCBrZXlzLmxlbmd0aCAtIDEpXG4gICAgLmZvckVhY2goc2hvcnRLZXkgPT4ge1xuICAgICAgY2ZnID0gY2ZnW3Nob3J0S2V5XSA9IGNmZ1tzaG9ydEtleV0gfHwge31cbiAgICB9KVxuXG4gICAgdHJ5IHtcbiAgICAgIGNmZ1tsYXN0S2V5XSA9IEpTT04ucGFyc2UodmFsdWUpXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjZmdbbGFzdEtleV0gPSB2YWx1ZVxuICAgIH1cbiAgfSlcblxuICBjb25zdCBjb25maWdXaXRoRW52ID0gbWVyZ2VDb25maWcoZW52Q29uZmlnLCBjb25maWcpXG4gIGRlYnVnKCdSZWFkIGNvbmZpZ3VyYXRpb246ICVqJywgY29uZmlnV2l0aEVudilcbiAgcmV0dXJuIG5ldyBSZWFkQ29uZmlnKGNvbmZpZ1dpdGhFbnYpXG59XG4iXX0=